<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VoiseTiFi - –£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<style>
:root {
    /* === PRIMARY COLORS === */
    --primary: #10b981;           /* Emerald Green */
    --primary-dark: #059669;      /* Dark Green */
    --primary-light: #34d399;     /* Light Green */
    --secondary: #1f2937;         /* Deep Charcoal */
    --secondary-dark: #111827;    /* Darker Charcoal */
    
    /* === SEMANTIC COLORS === */
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    
    /* === BACKGROUNDS === */
    --bg-primary: #0a0e1a;        /* Almost Black */
    --bg-secondary: #111827;      /* Dark Gray */
    --bg-tertiary: #1f2937;       /* Medium Gray */
    --bg-card: rgba(31, 41, 55, 0.8);
    --bg-glass: rgba(16, 185, 129, 0.05);
    --bg-hover: rgba(16, 185, 129, 0.1);
    --bg-active: rgba(16, 185, 129, 0.15);
    
    /* === TEXT COLORS === */
    --text-primary: #f9fafb;      /* Almost White */
    --text-secondary: #9ca3af;    /* Gray */
    --text-muted: #6b7280;        /* Muted Gray */
    --text-disabled: #4b5563;     /* Disabled Gray */
    --text-inverse: #111827;      /* For light backgrounds */
    
    /* === BORDERS === */
    --border-color: rgba(16, 185, 129, 0.2);
    --border-light: rgba(255, 255, 255, 0.1);
    --border-focus: #10b981;
    
    /* === SHADOWS === */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
    --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.4);
    
    /* === GRADIENTS === */
    --gradient-primary: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-card: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    
    /* === THEME TOGGLE === */
    --toggle-bg: #1f2937;
    --toggle-active: #10b981;
}
/* Light Theme */
body.light {
    /* === PRIMARY COLORS === */
    --primary: #dc2626;           /* Vibrant Red */
    --primary-dark: #b91c1c;      /* Dark Red */
    --primary-light: #ef4444;     /* Light Red */
    --secondary: #fbbf24;         /* Golden Yellow */
    --secondary-dark: #f59e0b;    /* Dark Yellow */
    
    /* === SEMANTIC COLORS === */
    --success: #10b981;
    --danger: #dc2626;
    --warning: #fbbf24;
    --info: #3b82f6;
    
    /* === BACKGROUNDS === */
    --bg-primary: #ffffff;        /* Pure White */
    --bg-secondary: #fef3c7;      /* Light Yellow */
    --bg-tertiary: #fed7aa;       /* Peach */
    --bg-card: rgba(254, 243, 199, 0.9);
    --bg-glass: rgba(220, 38, 38, 0.05);
    --bg-hover: rgba(220, 38, 38, 0.1);
    --bg-active: rgba(220, 38, 38, 0.15);
    
    /* === TEXT COLORS === */
    --text-primary: #1f2937;      /* Dark Gray */
    --text-secondary: #4b5563;    /* Medium Gray */
    --text-muted: #6b7280;        /* Light Gray */
    --text-disabled: #9ca3af;     /* Very Light Gray */
    --text-inverse: #ffffff;      /* For dark backgrounds */
    
    /* === BORDERS === */
    --border-color: rgba(220, 38, 38, 0.2);
    --border-light: rgba(0, 0, 0, 0.1);
    --border-focus: #dc2626;
    
    /* === SHADOWS === */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
    --shadow-glow: 0 0 20px rgba(220, 38, 38, 0.3);
    
    /* === GRADIENTS === */
    --gradient-primary: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    --gradient-card: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-danger: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    
    /* === THEME TOGGLE === */
    --toggle-bg: #fef3c7;
    --toggle-active: #dc2626;
}

/* üî• BACKGROUND OVERLAY –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
body.light::before {
    background: radial-gradient(circle at 20% 80%, rgba(220, 38, 38, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(251, 191, 36, 0.08) 0%, transparent 50%);
}


/* Global Resets */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
    }
    50% {
        box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
    }
}

@keyframes voicePulse {
    0%, 100% {
        transform: scale(1);
        opacity: 0.3;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.1;
    }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Onboarding */
.onboarding-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.onboarding-step {
    display: none;
    animation: fadeInUp 0.5s ease;
}

.onboarding-step.active {
    display: block;
}

.onboarding-content {
    text-align: center;
    max-width: 400px;
    padding: var(--spacing-xl);
}

.onboarding-logo {
    font-size: 80px;
    margin-bottom: var(--spacing-lg);
    animation: bounce 2s infinite;
}

.onboarding-title {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: var(--spacing-md);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.onboarding-subtitle {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xl);
    font-size: 18px;
}

.onboarding-input {
    width: 100%;
    padding: 20px;
    font-size: 48px;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--bg-glass);
    color: var(--text-primary);
    margin-bottom: var(--spacing-lg);
    transition: all var(--transition-normal);
}

.onboarding-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

.currency-selector, .language-selector {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
    justify-content: center;
}

.currency-btn, .language-btn {
    padding: 12px 24px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--bg-glass);
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.currency-btn.active, .language-btn.active {
    background: var(--gradient-primary);
    border-color: transparent;
    color: white;
}

.onboarding-btn {
    width: 100%;
    padding: 16px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.onboarding-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
}

/* App Container */
.app-container {
    max-width: 680px;
    min-width: 360px;
    margin: 0 auto;
    height: 100vh;
    position: relative;
    background: var(--bg-primary);
}

/* Screens */
.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: calc(100vh - 80px);
    opacity: 0;
    transform: translateX(100%);
    transition: all var(--transition-normal);
    overflow-y: auto;
    padding-bottom: var(--spacing-lg);
}

.screen.active {
    opacity: 1;
    transform: translateX(0);
}

.screen::-webkit-scrollbar {
    width: 4px;
}

.screen::-webkit-scrollbar-track {
    background: transparent;
}

.screen::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 2px;
}

/* Headers */
.app-header {
    position: sticky;
    top: 0;
    background: var(--bg-secondary);
    backdrop-filter: blur(10px);
    padding: var(--spacing-lg);
    padding-top: max(24px, env(safe-area-inset-top));
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
}

.header-left p {
    color: var(--text-secondary);
    font-size: 14px;
}

.notification-btn {
    position: relative;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.notification-btn:hover {
    background: var(--primary);
    transform: scale(1.05);
}

.notification-icon {
    font-size: 20px;
}

.notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}

/* Screen Content */
.screen-content {
    padding: var(--spacing-lg);
}

/* Balance Card */
.balance-card {
    background: var(--gradient-primary);
    border-radius: var(--border-radius-large);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-large);
}

.balance-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: rotate 3s linear infinite;
}

.balance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.balance-header h3 {
    font-size: 18px;
    font-weight: 600;
    opacity: 0.9;
}

.edit-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
}

.edit-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
}

.balance-amount {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: var(--spacing-lg);
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.balance-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.balance-stat {
    text-align: center;
}

.balance-stat-label {
    font-size: 14px;
    opacity: 0.8;
    margin-bottom: 4px;
}

.balance-stat-value {
    font-size: 20px;
    font-weight: 700;
}

.balance-stat-value.income {
    color: #4ade80;
}

.balance-stat-value.expense {
    color: #f87171;
}

.budget-progress-container {
    margin-top: var(--spacing-lg);
}

.budget-progress-bar {
    height: 8px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--spacing-sm);
}

.budget-progress {
    height: 100%;
    background: rgba(255,255,255,0.8);
    border-radius: 4px;
    transition: width var(--transition-slow);
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

.budget-progress-text {
    font-size: 14px;
    opacity: 0.9;
    text-align: center;
}

/* Quick Stats */
.quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.stat-card {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: all var(--transition-normal);
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medium);
}

.stat-icon {
    font-size: 24px;
    margin-bottom: var(--spacing-sm);
}

.stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--danger);
}


/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ AI */
.ai-fallback-indicator {
    font-size: 10px;
    color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
    margin-bottom: 5px;
    display: inline-block;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.action-btn {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    cursor: pointer;
    transition: all var(--transition-normal);
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}

.action-btn:nth-child(1) { animation-delay: 0.1s; }
.action-btn:nth-child(2) { animation-delay: 0.2s; }
.action-btn:nth-child(3) { animation-delay: 0.3s; }
.action-btn:nth-child(4) { animation-delay: 0.4s; }

.action-btn:hover {
    transform: scale(1.05);
}

.action-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.voice-btn .action-icon {
    background: var(--gradient-primary);
    animation: pulse 2s infinite;
}

.receipt-btn .action-icon {
    background: var(--gradient-info);
}

.income-btn .action-icon {
    background: var(--gradient-success);
}

.expense-btn .action-icon {
    background: var(--gradient-danger);
}

.action-label {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Alerts */
.alerts-container {
    margin-bottom: var(--spacing-lg);
}

.alert {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border-left: 4px solid var(--warning);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    animation: slideInRight 0.3s ease;
}

.alert.warning {
    border-left-color: var(--warning);
}

.alert.danger {
    border-left-color: var(--danger);
}

.alert.info {
    border-left-color: var(--info);
}

.alert-icon {
    font-size: 20px;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.alert-text {
    font-size: 14px;
    color: var(--text-secondary);
}

/* Transactions List */
.recent-transactions {
    margin-bottom: var(--spacing-lg);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.section-header h3 {
    font-size: 18px;
    font-weight: 600;
}

.section-header a {
    color: var(--primary);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
}

.transactions-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.transaction-item {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.transaction-item:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-small);
}

.transaction-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.transaction-info {
    flex: 1;
}

.transaction-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.transaction-time {
    font-size: 12px;
    color: var(--text-secondary);
}

.transaction-amount {
    font-weight: 700;
    font-size: 16px;
}

.transaction-amount.income {
    color: var(--success);
}

.transaction-amount.expense {
    color: var(--danger);
}

.transaction-receipt {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-small);
    object-fit: cover;
}

/* Analytics Screen */
.period-tabs {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    overflow-x: auto;
    padding-bottom: var(--spacing-xs);
}

.period-tab {
    padding: 8px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    white-space: nowrap;
}

.period-tab.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
}

/* üî• –î–û–ë–ê–í–¨–¢–ï –í –ö–û–ù–ï–¶ CSS */

.receipt-preview-item {
    position: relative;
    display: inline-block;
    margin-top: 10px;
}

.receipt-preview-item img {
    max-width: 200px;
    border-radius: var(--border-radius);
    border: 2px solid var(--border-color);
}

.remove-receipt-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--danger);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 12px;
}

.receipt-section {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}

.receipt-section h4 {
    margin-bottom: var(--spacing-sm);
    color: var(--text-secondary);
    font-size: 14px;
}

.transaction-detail-receipt {
    max-width: 100%;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: transform 0.2s ease;
}

.transaction-detail-receipt:hover {
    transform: scale(1.02);
}

.analytics-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.analytics-card {
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    color: white;
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}

.analytics-card:nth-child(1) { 
    background: var(--gradient-success);
    animation-delay: 0.1s;
}
.analytics-card:nth-child(2) { 
    background: var(--gradient-danger);
    animation-delay: 0.2s;
}
.analytics-card:nth-child(3) { 
    background: var(--gradient-primary);
    animation-delay: 0.3s;
}
.analytics-card:nth-child(4) { 
    background: var(--gradient-info);
    animation-delay: 0.4s;
}

.analytics-icon {
    font-size: 32px;
}

.analytics-content {
    flex: 1;
}

.analytics-label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.analytics-value {
    font-size: 24px;
    font-weight: 800;
}

/* Charts */
.charts-section {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.chart-container {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
}

.chart-container h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
}

.chart-container canvas {
    max-height: 200px;
}

/* Top Categories */
.top-categories-container {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
}

.top-categories {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.category-bar {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.category-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-bar-name {
    font-weight: 500;
}

.category-bar-value {
    font-weight: 600;
}

.category-bar-progress {
    height: 8px;
    background: var(--bg-glass);
    border-radius: 4px;
    overflow: hidden;
}

.category-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width var(--transition-slow);
}

/* –î–æ–±–∞–≤–∏—Ç—å –≤ CSS */
.currency-selector-edit {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    justify-content: center;
}

.currency-edit-btn {
    padding: 12px 20px;
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.currency-edit-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.currency-edit-btn.active {
    background: var(--gradient-primary);
    border-color: transparent;
    color: white;
}

#edit-daily-display {
    background: var(--bg-glass) !important;
    color: var(--text-secondary) !important;
    cursor: not-allowed;
}

#edit-daily-display:focus {
    outline: none;
    box-shadow: none;
    border-color: var(--border-color) !important;
}

.edit-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
    font-size: 16px;
}

.edit-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1) rotate(15deg);
}

/* Comparison Card */
.comparison-card {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
}

.comparison-card h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
}

.comparison-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
}

.comparison-value {
    font-weight: 600;
}

.comparison-value.positive {
    color: var(--success);
}

.comparison-value.negative {
    color: var(--danger);
}

/* Calendar Heatmap */
.calendar-container {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
}

.calendar-container h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
}

.calendar-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.calendar-day:hover {
    transform: scale(1.1);
}

.calendar-day.empty {
    opacity: 0.3;
}

/* History Screen */
.search-filters {
    margin-bottom: var(--spacing-lg);
}

.search-container {
    margin-bottom: var(--spacing-md);
}

.search-container input {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
}

.filter-container {
    display: flex;
    gap: var(--spacing-sm);
}

.filter-container select,
.filter-btn {
    flex: 1;
    padding: 12px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
}

.filter-btn {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Period Totals Card */
.period-totals-card {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-top: var(--spacing-lg);
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.total-row:last-child {
    border-bottom: none;
}

.total-value {
    font-weight: 700;
    font-size: 18px;
}

.total-value.income {
    color: var(--success);
}

.total-value.expense {
    color: var(--danger);
}

.total-value.balance {
    color: var(--primary);
}

/* üî• –î–û–ë–ê–í–¨–¢–ï –í CSS */
.quick-edit-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
}

.quick-edit-actions .action-btn {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.quick-edit-actions .action-btn:hover {
    transform: scale(1.05);
    border-color: var(--primary);
}

.quick-edit-actions .action-icon {
    font-size: 20px;
}

.quick-edit-actions .action-label {
    font-size: 12px;
    color: var(--text-secondary);
}

/* –î–æ–±–∞–≤–∏—Ç—å –≤ CSS */
.chart-container {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    position: relative;
    overflow: hidden;
}

.chart-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    opacity: 0.3;
}

.chart-container h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.chart-container h3::before {
    content: 'üìä';
    font-size: 18px;
}

.chart-container canvas {
    max-height: 250px !important;
    width: 100% !important;
    height: auto !important;
    display: block;
    margin: 0 auto;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è empty state –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö */
.chart-container .empty-state {
    padding: var(--spacing-xl) var(--spacing-lg);
    text-align: center;
    background: var(--bg-glass);
    border-radius: var(--border-radius);
    border: 1px dashed var(--border-color);
}

.chart-container .empty-state-icon {
    font-size: 48px;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

.chart-container .empty-state-text {
    color: var(--text-secondary);
    font-size: 14px;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ */
.chart-loading {
    position: relative;
    min-height: 200px;
}

.chart-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    margin: -20px 0 0 -20px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes confetti-fall {
    to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
    }
}

/* Settings Screen */
.settings-section {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.settings-section h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--text-secondary);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-item.danger {
    color: var(--danger);
}

.setting-btn {
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    padding: 8px 16px;
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.setting-btn:hover {
    background: var(--primary);
    color: white;
}

.setting-btn.danger:hover {
    background: var(--danger);
}

/* Toggle Switch */
.toggle {
    position: relative;
    width: 52px;
    height: 28px;
}

.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: 28px;
    transition: var(--transition-normal);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: var(--transition-normal);
}

.toggle input:checked + .toggle-slider {
    background: var(--gradient-primary);
    border-color: transparent;
}

.toggle input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* üî• –î–û–ë–ê–í–¨–¢–ï –í CSS */
.edit-btn {
    flex: 1;
    padding: 12px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-small);
}

.edit-transaction-section {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}

.edit-transaction-section h4 {
    margin-bottom: var(--spacing-md);
    color: var(--text-secondary);
    font-size: 16px;
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 680px;
    background: var(--bg-secondary);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    padding: var(--spacing-sm) 0;
    padding-bottom: max(0px, env(safe-area-inset-bottom));
    height: calc(80px + env(safe-area-inset-bottom));
    z-index: 100;
}

.nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    padding: var(--spacing-sm);
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-normal);
    flex: 1;
}

.nav-btn.active {
    color: var(--primary);
}

.nav-btn:hover {
    transform: translateY(-2px);
}

.nav-icon {
    font-size: 24px;
}

.nav-label {
    font-size: 10px;
    font-weight: 500;
}

.add-btn {
    position: relative;
    margin-top: -32px;
    background: var(--gradient-primary);
    border-radius: 50%;
    width: 64px;
    height: 64px;
    box-shadow: var(--shadow-large);
    animation: pulse 2s infinite;
}

.add-btn .nav-icon {
    font-size: 32px;
    color: white;
}

.add-btn .nav-label {
    display: none;
}

.recurring-payments-container {
    margin-bottom: var(--spacing-lg);
}

.recurring-payments-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.recurring-payment-item {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    transition: all var(--transition-normal);
}

.recurring-payment-item:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-small);
}

.recurring-icon {
    font-size: 24px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-glass);
    border-radius: 50%;
}

.recurring-info {
    flex: 1;
}

.recurring-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.recurring-date {
    font-size: 12px;
    font-weight: 500;
}

.recurring-amount {
    font-weight: 700;
    font-size: 16px;
    color: var(--danger);
}

/* Modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 1000;
}

.modal.active {
    display: flex;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
}

.modal-content {
    position: relative;
    background: var(--bg-secondary);
    border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
    width: 100%;
    max-width: 680px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    font-size: 20px;
    font-weight: 700;
}

.close-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bg-glass);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
}

.close-btn:hover {
    background: var(--danger);
    color: white;
}

/* Modal Tabs */
.modal-tabs {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    overflow-x: auto;
}

.modal-tab {
    padding: 8px 16px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    white-space: nowrap;
}

.modal-tab.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
}

/* Tab Content */
.tab-content {
    display: none;
    padding: var(--spacing-lg);
}

.tab-content.active {
    display: block;
}

/* Categories Grid */
.categories-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.category-item {
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.category-item:hover {
    transform: scale(1.05);
}

.category-item.active {
    background: var(--gradient-primary);
    border-color: transparent;
    color: white;
}

.category-icon {
    font-size: 32px;
}

.category-label {
    font-size: 12px;
    font-weight: 500;
    text-align: center;
}

/* Form Elements */
.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-group label {
    display: block;
    margin-bottom: var(--spacing-sm);
    font-weight: 500;
    color: var(--text-secondary);
}

.amount-input {
    width: 100%;
    padding: 20px;
    font-size: 48px;
    text-align: center;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    transition: all var(--transition-normal);
}

.amount-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

.desc-input, .name-input, .percent-input {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
    transition: all var(--transition-normal);
}

.desc-input:focus, .name-input:focus, .percent-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

select {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
    cursor: pointer;
}

input[type="date"] {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
}

.attach-btn {
    width: 100%;
    padding: 12px;
    background: var(--bg-glass);
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-secondary);
    font-size: 14px;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.attach-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.receipt-preview {
    margin-top: var(--spacing-md);
}

.receipt-preview img {
    max-width: 200px;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.save-btn {
    width: 100%;
    padding: 16px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.save-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
}

/* Voice Modal */
.voice-modal-content {
    text-align: center;
    padding: var(--spacing-xl);
}

.voice-container {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto var(--spacing-lg);
}

.voice-circle {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--gradient-primary);
    opacity: 0.3;
    animation: voicePulse 2s infinite;
}

.voice-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    z-index: 1;
}

.voice-status {
    font-size: 18px;
    margin-bottom: var(--spacing-md);
    color: var(--text-secondary);
}

.voice-text {
    font-size: 16px;
    margin-bottom: var(--spacing-lg);
    min-height: 24px;
}

.voice-btn {
    padding: 16px 32px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.voice-btn:hover {
    transform: scale(1.05);
}

/* Transaction Detail Modal */
.detail-modal-content {
    max-width: 400px;
    margin: auto;
}

.transaction-detail {
    text-align: center;
    padding: var(--spacing-xl);
}

.detail-actions {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
}

.delete-btn {
    flex: 1;
    padding: 12px;
    background: var(--gradient-danger);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.close-detail-btn {
    flex: 1;
    padding: 12px;
    background: var(--bg-glass);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

/* Management Modals */
.category-list, .loan-list, .recurring-list, .goals-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    max-height: 400px;
    overflow-y: auto;
}

.list-item {
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.list-item-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.list-item-icon {
    font-size: 24px;
}

.list-item-details {
    display: flex;
    flex-direction: column;
}

.list-item-name {
    font-weight: 600;
}

.list-item-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
}

.list-item-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.list-item-btn {
    padding: 6px 12px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-primary);
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.list-item-btn:hover {
    background: var(--primary);
    color: white;
}

.list-item-btn.delete:hover {
    background: var(--danger);
}

.add-category-btn, .add-loan-btn, .add-recurring-btn, .add-goal-btn {
    width: 100%;
    padding: 12px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

/* Date Filter Modal */
.filter-actions {
    display: flex;
    gap: var(--spacing-md);
}

.apply-filter-btn, .reset-filter-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.apply-filter-btn {
    background: var(--gradient-primary);
    color: white;
}

.reset-filter-btn {
    background: var(--bg-glass);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

/* –î–æ–±–∞–≤–∏—Ç—å –≤ CSS */
#onboarding {
    transition: opacity 0.3s ease;
}

#app {
    transition: opacity 0.3s ease;
}

.onboarding-step {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.onboarding-step.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

/* Language/Currency Options */
.language-options, .currency-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.language-option, .currency-option {
    padding: 16px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.language-option:hover, .currency-option:hover {
    background: var(--primary);
    color: white;
    border-color: transparent;
}

/* About Modal */
.about-content {
    text-align: center;
    padding: var(--spacing-xl);
}

.about-logo {
    font-size: 80px;
    margin-bottom: var(--spacing-lg);
}

.about-content h2 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: var(--spacing-sm);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.about-content p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-md);
}

.about-features, .about-contact {
    text-align: left;
    margin-top: var(--spacing-xl);
}

.about-features h3, .about-contact h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
}

.about-features ul {
    list-style: none;
    padding-left: 0;
}

.about-features li {
    padding: 4px 0;
    color: var(--text-secondary);
}

.about-features li:before {
    content: "‚úì ";
    color: var(--success);
    font-weight: bold;
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

.empty-state-text {
    font-size: 16px;
}

/* Toast Notifications */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    animation: slideInRight 0.3s ease;
    z-index: 2000;
}

.toast.success {
    border-left: 4px solid var(--success);
}

.toast.error {
    border-left: 4px solid var(--danger);
}

.toast.warning {
    border-left: 4px solid var(--warning);
}

.toast.info {
    border-left: 4px solid var(--info);
}

/* PIN Screen */
.pin-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.pin-container {
    text-align: center;
    max-width: 400px;
    padding: var(--spacing-xl);
}

.pin-logo {
    font-size: 80px;
    margin-bottom: var(--spacing-lg);
    animation: pulse 2s infinite;
}

.pin-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: var(--spacing-xl);
    color: var(--text-primary);
}

.pin-dots {
    display: flex;
    justify-content: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.pin-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    transition: all var(--transition-normal);
}

.pin-dot.filled {
    background: var(--primary);
    border-color: var(--primary);
    box-shadow: 0 0 10px var(--primary);
}

.pin-keyboard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.pin-key {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 28px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
}

.pin-key:hover:not(.empty) {
    background: var(--primary);
    transform: scale(1.05);
}

.pin-key:active:not(.empty) {
    transform: scale(0.95);
}

.pin-key.empty {
    opacity: 0;
    pointer-events: none;
}

.biometric-btn {
    width: 100%;
    padding: 16px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.biometric-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
}

/* Hide amounts when enabled */
.amounts-hidden .balance-amount,
.amounts-hidden .balance-stat-value,
.amounts-hidden .stat-value,
.amounts-hidden .transaction-amount,
.amounts-hidden .analytics-value,
.amounts-hidden .total-value,
.amounts-hidden #total-balance,
.amounts-hidden #total-income,
.amounts-hidden #total-expense {
    color: transparent !important;
    text-shadow: 0 0 8px rgba(255,255,255,0.5);
}

.amounts-hidden .balance-amount::before,
.amounts-hidden .balance-stat-value::before,
.amounts-hidden .stat-value::before,
.amounts-hidden .transaction-amount::before,
.amounts-hidden .analytics-value::before,
.amounts-hidden .total-value::before {
    content: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    position: absolute;
    color: var(--text-primary);
    text-shadow: none;
}

/* Responsive Design */
@media (max-width: 400px) {
    .quick-stats {
        grid-template-columns: 1fr;
    }
    
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .analytics-cards {
        grid-template-columns: 1fr;
    }
    
    .categories-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .balance-amount {
        font-size: 36px;
    }
    
    .amount-input {
        font-size: 36px;
    }
}

@media (max-width: 360px) {
    .app-container {
        min-width: 320px;
    }
    
    .screen-content {
        padding: var(--spacing-md);
    }
    
    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .nav-label {
        font-size: 10px;
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

@media (prefers-contrast: high) {
    :root {
        --border-color: rgba(255, 255, 255, 0.3);
        --text-secondary: #ffffff;
    }
}

/* Focus styles */
button:focus-visible,
input:focus-visible,
select:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Print styles */
@media print {
    .bottom-nav,
    .modal,
    .onboarding-container {
        display: none !important;
    }
    
    .screen {
        height: auto;
        overflow: visible;
    }
    
    body {
        background: white;
        color: black;
    }
}
/* üî• –î–û–ë–ê–í–¨–¢–ï –í –ö–û–ù–ï–¶ CSS –§–ê–ô–õ–ê */

/* Category Limits Styles */
.category-limits-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.category-limit-item {
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 12px;
}

.category-limit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: 500;
}

.category-limit-value {
    font-weight: 600;
    color: var(--primary);
}

.category-limit-progress {
    display: flex;
    align-items: center;
    gap: 10px;
}

.category-limit-progress-bar {
    flex: 1;
    height: 6px;
    background: var(--bg-glass);
    border-radius: 3px;
    overflow: hidden;
}

.category-limit-progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
}

.category-limit-spent {
    font-size: 12px;
    color: var(--text-secondary);
    min-width: 60px;
    text-align: right;
}

/* Edit Category Limits */
.category-limits-edit {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.category-limits-edit .form-group {
    margin-bottom: 15px;
}

.category-limits-edit .form-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.category-limit-input {
    margin-top: 5px;
}

/* Smart Notifications Badge */
.notification-badge.warning {
    background: var(--warning);
    animation: pulse 1.5s infinite;
}

.notification-badge.danger {
    background: var(--danger);
    animation: pulse 1s infinite;
}

/* Confetti Animation */
@keyframes confetti-fall {
    to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
    }
}

/* ==========================================
   üß† AI CHAT STYLES
   ========================================== */

/* –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ AI */
.ai-quick-btn {
    padding: 8px 12px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-secondary);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.ai-quick-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--shadow-small);
}

/* –°–æ–æ–±—â–µ–Ω–∏—è AI —á–∞—Ç–∞ */
.ai-message {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: var(--border-radius);
    max-width: 85%;
    animation: fadeInUp 0.3s ease;
}

.ai-message.user {
    background: var(--gradient-primary);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.ai-message.assistant {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
}

.ai-message-content {
    display: flex;
    flex-direction: column;
}

.ai-message-text {
    margin-bottom: 4px;
    line-height: 1.4;
}

.ai-message-time {
    font-size: 10px;
    opacity: 0.6;
    text-align: right;
}

.ai-message.assistant .ai-message-time {
    text-align: left;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ AI */
.ai-message.temp-message {
    opacity: 0.7;
    animation: pulse 1.5s infinite;
}

/* AI –∫–Ω–æ–ø–∫–∞ –≤ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö */
.ai-btn .action-icon {
    background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
    animation: pulse 2s infinite;
}

/* === THEME TOGGLE BUTTON === */
.theme-toggle-btn {
    position: relative;
    width: 60px;
    height: 32px;
    background: var(--toggle-bg);
    border: 2px solid var(--border-light);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    padding: 0 4px;
    overflow: hidden;
}

.theme-toggle-btn:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
    transform: scale(1.05);
}

.theme-toggle-btn:active {
    transform: scale(0.95);
}

/* === –ò–ö–û–ù–ö–ò === */
.theme-icon {
    position: absolute;
    font-size: 18px;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.sun-icon {
    left: 4px;
    opacity: 0;
    transform: rotate(-180deg) scale(0);
}

.moon-icon {
    right: 4px;
    opacity: 1;
    transform: rotate(0deg) scale(1);
}

/* === –°–û–°–¢–û–Ø–ù–ò–Ø –¢–ï–ú === */
body.light .theme-toggle-btn {
    background: var(--toggle-bg);
}

body.light .sun-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
}

body.light .moon-icon {
    opacity: 0;
    transform: rotate(180deg) scale(0);
}

/* === –ê–ù–ò–ú–ê–¶–ò–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø === */
.theme-toggle-btn::before {
    content: '';
    position: absolute;
    width: 24px;
    height: 24px;
    background: var(--primary);
    border-radius: 50%;
    left: 4px;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

body.light .theme-toggle-btn::before {
    left: calc(100% - 28px);
    background: var(--primary);
}

/* === –ü–£–õ–¨–°–ê–¶–ò–Ø –ü–†–ò HOVER === */
@keyframes theme-pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 var(--primary);
    }
    50% {
        box-shadow: 0 0 0 8px transparent;
    }
}

.theme-toggle-btn:hover::before {
    animation: theme-pulse 1.5s infinite;
}

/* === –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ === */
@media (max-width: 400px) {
    .theme-toggle-btn {
        width: 50px;
        height: 28px;
    }
    
    .theme-icon {
        font-size: 16px;
        width: 20px;
        height: 20px;
    }
    
    .theme-toggle-btn::before {
        width: 20px;
        height: 20px;
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è AI —á–∞—Ç–∞ */
@media (max-width: 400px) {
    .ai-message {
        max-width: 90%;
    }
    
    .ai-quick-btn {
        font-size: 10px;
        padding: 6px 8px;
    }
}

</style>
<body>
    <!-- ONBOARDING SCREEN -->
   
        <!-- PIN CODE SCREEN -->
    <div id="pin-screen" class="pin-screen" style="display: none;">
        <div class="pin-container">
            <div class="pin-logo">üîí</div>
            <h2 class="pin-title">–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥</h2>
            <div class="pin-dots">
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
            </div>
            <div class="pin-keyboard">
                <button class="pin-key" onclick="enterPin('1')">1</button>
                <button class="pin-key" onclick="enterPin('2')">2</button>
                <button class="pin-key" onclick="enterPin('3')">3</button>
                <button class="pin-key" onclick="enterPin('4')">4</button>
                <button class="pin-key" onclick="enterPin('5')">5</button>
                <button class="pin-key" onclick="enterPin('6')">6</button>
                <button class="pin-key" onclick="enterPin('7')">7</button>
                <button class="pin-key" onclick="enterPin('8')">8</button>
                <button class="pin-key" onclick="enterPin('9')">9</button>
                <button class="pin-key empty"></button>
                <button class="pin-key" onclick="enterPin('0')">0</button>
                <button class="pin-key" onclick="clearPin()">‚å´</button>
            </div>
            <button class="biometric-btn" id="biometric-btn" onclick="useBiometric()" style="display: none;">
                üëÜ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é
            </button>
        </div>
    </div>
     <div id="onboarding" class="onboarding-container">
        <!-- Step 1: Welcome -->
        <div class="onboarding-step active" data-step="1">
            <div class="onboarding-content">
                <div class="onboarding-logo">üí∞</div>
                <h1 class="onboarding-title">VoiseTiFi</h1>
                <p class="onboarding-subtitle">–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏</p>
                <button class="onboarding-btn" onclick="nextOnboardingStep()">–ù–∞—á–∞—Ç—å</button>
            </div>
        </div>
        
        <!-- Step 2: Monthly Income -->
        <div class="onboarding-step" data-step="2">
            <div class="onboarding-content">
                <h2 class="onboarding-title">–í–∞—à –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
                <input type="number" id="monthly-income" class="onboarding-input" placeholder="0" min="0" step="0.01">
                <div class="currency-selector">
                    <button class="currency-btn active" data-currency="USD" data-rate="1" data-symbol="$" onclick="selectCurrency('USD')">$</button>
                    <button class="currency-btn" data-currency="TJS" data-rate="10.7" data-symbol="SM" onclick="selectCurrency('TJS')">TJS</button>
                    <button class="currency-btn" data-currency="RUB" data-rate="92" data-symbol="‚ÇΩ" onclick="selectCurrency('RUB')">‚ÇΩ</button>
                </div>
                <button class="onboarding-btn" onclick="nextOnboardingStep()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- Step 3: Language Selection -->
        <div class="onboarding-step" data-step="3">
            <div class="onboarding-content">
                <h2 class="onboarding-title">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
                <div class="language-selector">
                    <button class="language-btn active" data-lang="ru" onclick="selectLanguage('ru')">–†—É—Å—Å–∫–∏–π</button>
                    <button class="language-btn" data-lang="en" onclick="selectLanguage('en')">English</button>
                    <button class="language-btn" data-lang="tj" onclick="selectLanguage('tj')">–¢–æ“∑–∏–∫”£</button>
                </div>
                <button class="onboarding-btn" onclick="finishOnboarding()">–ì–æ—Ç–æ–≤–æ!</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="app-container" style="display: none;">
        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen active">
            <header class="app-header">
                <div class="header-content">
                    <div class="header-left">
                        <h2 id="greeting-text">–î–æ–±—Ä—ã–π –¥–µ–Ω—å</h2>
                        <p id="current-date">–°–µ–≥–æ–¥–Ω—è</p>
                    </div>
                      <button class="theme-toggle-btn" 
                onclick="toggleTheme()" 
                aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
                title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
            <span class="theme-icon moon-icon">üåô</span>
        </button>
                    <button class="notification-btn" onclick="showNotifications()">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                </div>
            </header>
            
            <div class="screen-content">
                <!-- Balance Card -->
                <div class="balance-card">
                    <div class="balance-header">
                        <h3>–í–∞—à –±—é–¥–∂–µ—Ç</h3>
                        <button class="edit-btn" onclick="editBudget()">‚úèÔ∏è</button>
                    </div>
                    <div class="balance-amount" id="total-balance">$0.00</div>
                    <div class="balance-stats">
                        <div class="balance-stat">
                            <span class="balance-stat-label">–î–æ—Ö–æ–¥</span>
                            <span class="balance-stat-value income" id="total-income">+$0.00</span>
                        </div>
                        <div class="balance-stat">
                            <span class="balance-stat-label">–†–∞—Å—Ö–æ–¥</span>
                            <span class="balance-stat-value expense" id="total-expense">-$0.00</span>
                        </div>
                    </div>
                    <div class="budget-progress-container">
                        <div class="budget-progress-bar">
                            <div class="budget-progress" id="budget-progress"></div>
                        </div>
                        <p class="budget-progress-text" id="spent-percent">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ 0% –æ—Ç –±—é–¥–∂–µ—Ç–∞</p>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <p class="stat-label">–°–µ–≥–æ–¥–Ω—è</p>
                            <p class="stat-value" id="today-spent">$0.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <p class="stat-label">–ù–µ–¥–µ–ª—è</p>
                            <p class="stat-value" id="week-spent">$0.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <p class="stat-label">–ú–µ—Å—è—Ü</p>
                            <p class="stat-value" id="month-spent">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
               <!-- Quick Actions -->
<div class="quick-actions">
    <button class="action-btn voice-btn" onclick="openVoiceModal()">
        <span class="action-icon">üé§</span>
        <span class="action-label">–ì–æ–ª–æ—Å</span>
    </button>
    <button class="action-btn ai-btn" onclick="openAIChatModal()">
        <span class="action-icon">üß†</span>
        <span class="action-label">AI</span>
    </button>
    <button class="action-btn receipt-btn" onclick="openReceiptModal()">
        <span class="action-icon">üßæ</span>
        <span class="action-label">–ß–µ–∫</span>
    </button>
    <button class="action-btn income-btn" onclick="openAddModal('income')">
        <span class="action-icon">üí∞</span>
        <span class="action-label">–î–æ—Ö–æ–¥</span>
    </button>
    <button class="action-btn expense-btn" onclick="openAddModal('expense')">
        <span class="action-icon">üí∏</span>
        <span class="action-label">–†–∞—Å—Ö–æ–¥</span>
    </button>
</div>
                
                <!-- Alerts -->
                <div class="alerts-container" id="alerts-container">
                    <!-- Alerts will be dynamically added here -->
                </div>
                
                <!-- Recent Transactions -->
                <div class="recent-transactions">
                    <div class="section-header">
                        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                        <a href="#" onclick="switchScreen('history')">–í—Å–µ</a>
                    </div>
                    <div class="transactions-list" id="recent-transactions">
                        <!-- Transactions will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS SCREEN -->
        <div id="analytics-screen" class="screen">
            <header class="app-header">
                <div class="header-content">
                    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                </div>
            </header>
            
            <div class="screen-content">
                <!-- Period Selector -->
                <div class="period-tabs" id="period-tabs">
                    <button class="period-tab active" data-period="today" onclick="selectPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
                    <button class="period-tab" data-period="week" onclick="selectPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-tab" data-period="month" onclick="selectPeriod('month')">–ú–µ—Å—è—Ü</button>
                    <button class="period-tab" data-period="year" onclick="selectPeriod('year')">–ì–æ–¥</button>
                </div>
                
                <!-- Analytics Cards -->
                <div class="analytics-cards">
                    <div class="analytics-card income-card">
                        <div class="analytics-icon">üí∞</div>
                        <div class="analytics-content">
                            <p class="analytics-label">–î–æ—Ö–æ–¥</p>
                            <p class="analytics-value" id="analytics-income">$0.00</p>
                        </div>
                    </div>
                    <div class="analytics-card expense-card">
                        <div class="analytics-icon">üí∏</div>
                        <div class="analytics-content">
                            <p class="analytics-label">–†–∞—Å—Ö–æ–¥</p>
                            <p class="analytics-value" id="analytics-expense">$0.00</p>
                        </div>
                    </div>
                    <div class="analytics-card balance-card">
                        <div class="analytics-icon">üí≥</div>
                        <div class="analytics-content">
                            <p class="analytics-label">–ë–∞–ª–∞–Ω—Å</p>
                            <p class="analytics-value" id="analytics-balance">$0.00</p>
                        </div>
                    </div>
                    <div class="analytics-card daily-card">
                        <div class="analytics-icon">üìä</div>
                        <div class="analytics-content">
                            <p class="analytics-label">–°—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π</p>
                            <p class="analytics-value" id="analytics-daily">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="charts-section">
                    <!-- Line Chart -->
                    <!-- –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<div class="charts-section">
    <!-- Line Chart Container -->
    <div class="chart-container">
        <h3>–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <canvas id="line-chart" style="height: 250px;"></canvas>
    </div>
    
    <!-- Pie Chart Container -->
    <div class="chart-container">
        <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <canvas id="pie-chart" style="height: 250px;"></canvas>
    </div>
    
    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <div class="top-categories-container">
        <!-- ... -->
    </div>
</div>
                    <!-- Top Categories -->
                    <div class="top-categories-container">
                        <h3>–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                        <div class="top-categories" id="top-categories">
                            <!-- Categories will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- Comparison Card -->
                    <div class="comparison-card">
                        <h3>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º –º–µ—Å—è—Ü–µ–º</h3>
                        <div class="comparison-row">
                            <span>–†–∞—Å—Ö–æ–¥—ã</span>
                            <span class="comparison-value" id="expense-comparison">+0%</span>
                        </div>
                        <div class="comparison-row">
                            <span>–î–æ—Ö–æ–¥—ã</span>
                            <span class="comparison-value" id="income-comparison">+0%</span>
                        </div>
                    </div>
                    
                    <!-- Calendar Heatmap -->
                    <div class="calendar-container">
                        <h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
                        <div class="calendar-heatmap" id="calendar-heatmap">
                            <!-- Calendar days will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY SCREEN -->
        <div id="history-screen" class="screen">
            <header class="app-header">
                <div class="header-content">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
                </div>
            </header>
            
            <div class="screen-content">
                <!-- Search and Filters -->
                <div class="search-filters">
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫..." onkeyup="filterTransactions()">
                    </div>
                    <div class="filter-container">
                        <select id="type-filter" onchange="filterTransactions()">
                            <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
                            <option value="income">–î–æ—Ö–æ–¥—ã</option>
                            <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥—ã</option>
                        </select>
                        <select id="category-filter" onchange="filterTransactions()">
                            <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <!-- Categories will be dynamically added here -->
                        </select>
                        <button class="filter-btn" onclick="openDateFilter()">
                            üìÖ
                        </button>
                    </div>
                </div>
                
                <!-- Transactions List -->
                <div class="transactions-list" id="transactions-list">
                    <!-- Transactions will be dynamically added here -->
                </div>
                
                <!-- Period Totals Card -->
                <div class="period-totals-card">
                    <div class="total-row">
                        <span>–û–±—â–∏–π –¥–æ—Ö–æ–¥</span>
                        <span class="total-value income" id="period-income">+$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</span>
                        <span class="total-value expense" id="period-expenses">-$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>–ë–∞–ª–∞–Ω—Å</span>
                        <span class="total-value balance" id="period-balance">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div id="settings-screen" class="screen">
            <header class="app-header">
                <div class="header-content">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                </div>
            </header>
            
            <div class="screen-content">
                <!-- Profile & Budget Section -->
                <div class="settings-section">
                    <h3>–ü—Ä–æ—Ñ–∏–ª—å –∏ –±—é–¥–∂–µ—Ç</h3>
                    <div class="setting-item">
                        <span>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</span>
                        <span id="settings-income" onclick="editBudget()">$0.00</span>
                    </div>
                    <div class="setting-item">
                        <span>–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç</span>
                        <span id="daily-limit">$0.00</span>
                    </div>

                    <!-- Security Section -->
                <div class="settings-section">
                    <h3>üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                    <div class="setting-item">
                        <span>PIN-–∫–æ–¥</span>
                        <label class="toggle">
                            <input type="checkbox" id="pin-toggle" onchange="togglePinCode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–ë–∏–æ–º–µ—Ç—Ä–∏—è</span>
                        <label class="toggle">
                            <input type="checkbox" id="biometric-toggle" onchange="toggleBiometric()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–°–∫—Ä—ã—Ç—å —Å—É–º–º—ã</span>
                        <label class="toggle">
                            <input type="checkbox" id="hide-amounts-toggle" onchange="toggleHideAmounts()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–ê–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–º–∏–Ω)</span>
                        <select id="autolock-select" onchange="changeAutoLock()">
                            <option value="0">–û—Ç–∫–ª—é—á–µ–Ω–æ</option>
                            <option value="1">1 –º–∏–Ω—É—Ç–∞</option>
                            <option value="5" selected>5 –º–∏–Ω—É—Ç</option>
                            <option value="15">15 –º–∏–Ω—É—Ç</option>
                            <option value="30">30 –º–∏–Ω—É—Ç</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <span>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –±—ç–∫–∞–ø</span>
                        <button class="setting-btn" onclick="exportEncrypted()">üîí –≠–∫—Å–ø–æ—Ä—Ç</button>
                    </div>
                </div>

                    <div class="setting-item">
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–µ</span>
                        <label class="toggle">
                            <input type="checkbox" id="limit-notifications" onchange="toggleSetting('limit-notifications')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Appearance Section -->
                <div class="settings-section">
                    <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                    <div class="setting-item">
                        <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <label class="toggle">
                            <input type="checkbox" id="dark-theme" checked onchange="toggleTheme()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–Ø–∑—ã–∫</span>
                        <button class="setting-btn" id="current-language" onclick="openLanguageSelector()">–†—É—Å—Å–∫–∏–π</button>
                    </div>
                    <div class="setting-item">
                        <span>–í–∞–ª—é—Ç–∞</span>
                        <button class="setting-btn" id="current-currency" onclick="openCurrencySelector()">USD</button>
                    </div>
                </div>
                                 <div class="settings-section">
    <h3>ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫</h3>
    <div class="setting-item">
        <span>AI –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
        <label class="toggle">
            <input type="checkbox" id="ai-analytics" checked onchange="toggleAISetting('analytics')">
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="setting-item">
        <span>–£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</span>
        <label class="toggle">
            <input type="checkbox" id="ai-advice" checked onchange="toggleAISetting('advice')">
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="setting-item">
        <span>–ì–æ–ª–æ—Å–æ–≤–æ–π AI</span>
        <label class="toggle">
            <input type="checkbox" id="ai-voice" checked onchange="toggleAISetting('voice')">
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="setting-item">
        <span>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å AI</span>
        <button class="setting-btn" onclick="testAIConnection()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>
</div>
                <!-- Categories Management -->
                <div class="settings-section">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    <div class="setting-item">
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                        <button class="setting-btn" onclick="manageCategories()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ‚ûú</button>
                    </div>
                    <div class="setting-item">
                        <span>–î–æ–ª–≥–∏</span>
                        <button class="setting-btn" onclick="manageLoans()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏ ‚ûú</button>
                    </div>
                    <div class="setting-item">
                        <span>–ü–ª–∞—Ç–µ–∂–∏</span>
                        <button class="setting-btn" onclick="manageRecurring()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏ ‚ûú</button>
                    </div>
                    <div class="setting-item">
                        <span>–¶–µ–ª–∏</span>
                        <button class="setting-btn" onclick="manageGoals()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏ ‚ûú</button>
                    </div>
                </div>
                
                <!-- Backup Section -->
                <div class="settings-section">
                    <h3>–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <div class="setting-item">
                        <span>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                        <button class="setting-btn" onclick="exportData()">üíæ</button>
                    </div>
                    <div class="setting-item">
                        <span>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                        <button class="setting-btn" onclick="document.getElementById('import-file').click()">üì•</button>
                        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                    <div class="setting-item danger">
                        <span>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</span>
                        <button class="setting-btn danger" onclick="clearAllData()">üóëÔ∏è</button>
                    </div>
                </div>
                
                <!-- Notifications Settings -->
                <div class="settings-section">
                    <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <div class="setting-item">
                        <span>–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞</span>
                        <label class="toggle">
                            <input type="checkbox" id="budget-notifications" checked onchange="toggleSetting('budget-notifications')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–æ–ª–≥–∞—Ö</span>
                        <label class="toggle">
                            <input type="checkbox" id="debt-notifications" checked onchange="toggleSetting('debt-notifications')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</span>
                        <label class="toggle">
                            <input type="checkbox" id="weekly-report" onchange="toggleSetting('weekly-report')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- About Section -->
                <div class="settings-section">
                    <h3>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                    <div class="setting-item">
                        <span>–í–µ—Ä—Å–∏—è</span>
                        <span>1.0.0</span>
                    </div>
                    <div class="setting-item">
                        <span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                        <button class="setting-btn" onclick="showAbout()">‚ÑπÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-screen="home" onclick="switchScreen('home')">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
            </button>
            <button class="nav-btn" data-screen="analytics" onclick="switchScreen('analytics')">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
            </button>
            <button class="nav-btn add-btn" onclick="openAddModal()">
                <span class="nav-icon">‚ûï</span>
            </button>
            <button class="nav-btn" data-screen="history" onclick="switchScreen('history')">
                <span class="nav-icon">üìî</span>
                <span class="nav-label">–ò—Å—Ç–æ—Ä–∏—è</span>
            </button>
            <button class="nav-btn" data-screen="settings" onclick="switchScreen('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </button>
        </nav>
    </div>

    <!-- MODALS -->
    
    <!-- Add Transaction Modal -->
    <div id="add-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('add-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</h2>
                <button class="close-btn" onclick="closeModal('add-modal')">‚úï</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="expense" onclick="switchTab('expense')">–†–∞—Å—Ö–æ–¥</button>
                <button class="modal-tab" data-tab="income" onclick="switchTab('income')">–î–æ—Ö–æ–¥</button>
                <button class="modal-tab" data-tab="transfer" onclick="switchTab('transfer')">–ü–µ—Ä–µ–≤–æ–¥</button>
                <button class="modal-tab" data-tab="loan" onclick="switchTab('loan')">–ö—Ä–µ–¥–∏—Ç</button>
            </div>
            
            <div class="modal-body">
                <!-- Expense Tab -->
                <div class="tab-content active" id="expense-tab">
                    <div class="categories-grid" id="expense-categories">
                        <div class="category-item" onclick="selectCategory('food', 'expense')">
                            <div class="category-icon">üõí</div>
                            <div class="category-label">–ü—Ä–æ–¥—É–∫—Ç—ã</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('transport', 'expense')">
                            <div class="category-icon">üöñ</div>
                            <div class="category-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('restaurant', 'expense')">
                            <div class="category-icon">üçî</div>
                            <div class="category-label">–ö–∞—Ñ–µ</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('health', 'expense')">
                            <div class="category-icon">üíä</div>
                            <div class="category-label">–ó–¥–æ—Ä–æ–≤—å–µ</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('clothes', 'expense')">
                            <div class="category-icon">üëï</div>
                            <div class="category-label">–û–¥–µ–∂–¥–∞</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('entertainment', 'expense')">
                            <div class="category-icon">üéÆ</div>
                            <div class="category-label">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('bills', 'expense')">
                            <div class="category-icon">üí°</div>
                            <div class="category-label">–ö–æ–º–º—É–Ω–∞–ª–∫–∞</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('other', 'expense')">
                            <div class="category-icon">üì¶</div>
                            <div class="category-label">–î—Ä—É–≥–æ–µ</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <input type="number" id="expense-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <input type="text" id="expense-desc" class="desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                    
                    <div class="form-group">
                        <button class="attach-btn" onclick="document.getElementById('expense-receipt').click()">
                            üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —á–µ–∫
                        </button>
                        <input type="file" id="expense-receipt" accept="image/*" style="display: none;" onchange="previewReceipt(event)">
                        <div id="expense-receipt-preview" class="receipt-preview"></div>
                    </div>
                    
                    <button class="save-btn" onclick="saveTransaction('expense')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <!-- Income Tab -->
                <div class="tab-content" id="income-tab">
                    <div class="categories-grid" id="income-categories">
                        <div class="category-item" onclick="selectCategory('salary', 'income')">
                            <div class="category-icon">üíº</div>
                            <div class="category-label">–ó–∞—Ä–ø–ª–∞—Ç–∞</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('freelance', 'income')">
                            <div class="category-icon">üíª</div>
                            <div class="category-label">–§—Ä–∏–ª–∞–Ω—Å</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('gift', 'income')">
                            <div class="category-icon">üéÅ</div>
                            <div class="category-label">–ü–æ–¥–∞—Ä–æ–∫</div>
                        </div>
                        <div class="category-item" onclick="selectCategory('investment', 'income')">
                            <div class="category-icon">üìà</div>
                            <div class="category-label">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <input type="number" id="income-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <input type="text" id="income-desc" class="desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                    
                    <button class="save-btn" onclick="saveTransaction('income')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <!-- Transfer Tab -->
                <div class="tab-content" id="transfer-tab">
                    <div class="form-group">
                        <label>–ò–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                        <select id="transfer-from">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <!-- Options will be dynamically added -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–í –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
                        <select id="transfer-to">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <!-- Options will be dynamically added -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <input type="number" id="transfer-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <input type="text" id="transfer-desc" class="desc-input" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                    
                    <button class="save-btn" onclick="saveTransaction('transfer')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <!-- Loan Tab -->
                <div class="tab-content" id="loan-tab">
                    <div class="form-group">
                        <input type="text" id="loan-name" class="name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–æ–º—É/–æ—Ç–∫—É–¥–∞)">
                    </div>
                    
                    <div class="form-group">
                        <input type="number" id="loan-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <input type="date" id="loan-date">
                    </div>
                    
                    <div class="form-group">
                        <input type="number" id="loan-percent" class="percent-input" placeholder="–ü—Ä–æ—Ü–µ–Ω—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" step="0.01" min="0">
                    </div>
                    
                    <button class="save-btn" onclick="saveTransaction('loan')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Input Modal -->
    <div id="voice-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('voice-modal')"></div>
        <div class="modal-content voice-modal-content">
            <button class="close-btn" onclick="closeModal('voice-modal')">‚úï</button>
            
            <div class="voice-container">
                <div class="voice-circle"></div>
                <div class="voice-icon">üé§</div>
            </div>
            
            <p id="voice-status" class="voice-status">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å</p>
            <p id="voice-text" class="voice-text"></p>
            
            <button id="voice-btn" class="voice-btn" onclick="toggleVoiceRecording()">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>
    </div>
    
    <!-- Transaction Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('detail-modal')"></div>
        <div class="modal-content detail-modal-content">
            <div class="modal-header">
                <h2>–î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <button class="close-btn" onclick="closeModal('detail-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="transaction-detail" id="transaction-detail">
                    <!-- Transaction details will be dynamically added here -->
                </div>
                
                <div class="detail-actions">
                <button class="edit-btn" onclick="editTransaction()">‚úèÔ∏è</button>
    <button class="delete-btn" onclick="deleteTransaction()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    <button class="close-detail-btn" onclick="closeModal('detail-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
       <!-- Edit Transaction Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('edit-modal')"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
            <button class="close-btn" onclick="closeModal('edit-modal')">‚úï</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label>–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                <select id="edit-type" onchange="updateEditCategories()">
                    <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                    <option value="income">–î–æ—Ö–æ–¥</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <div class="categories-grid" id="edit-categories">
                    <!-- Categories will be populated dynamically -->
                </div>
            </div>
            
            <div class="form-group">
                <label>–°—É–º–º–∞</label>
                <input type="number" id="edit-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" id="edit-desc" class="desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            </div>
            
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="datetime-local" id="edit-date">
            </div>
            
            <button class="save-btn" onclick="saveEditedTransaction()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>
</div>



    <!-- Category Management Modal -->
           <!-- AI Settings Section -->
    <div id="category-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('category-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
                <button class="close-btn" onclick="closeModal('category-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="category-list" id="category-list">
                    <!-- Categories will be dynamically added here -->
                </div>
                
                <button class="add-category-btn" onclick="addNewCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
            </div>
        </div>
    </div>
    
    <!-- Loan Management Modal -->
    <div id="loan-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('loan-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏</h2>
                <button class="close-btn" onclick="closeModal('loan-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="loan-list" id="loan-list">
                    <!-- Loans will be dynamically added here -->
                </div>

                <button class="add-loan-btn" onclick="addNewLoan()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</button>
            </div>
        </div>
    </div>
    
    <!-- Recurring Payments Modal -->
    <div id="recurring-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('recurring-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏</h2>
                <button class="close-btn" onclick="closeModal('recurring-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="recurring-list" id="recurring-list">
                    <!-- Recurring payments will be dynamically added here -->
                </div>
                
                <button class="add-recurring-btn" onclick="addNewRecurring()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
            </div>
        </div>
    </div>
    
    <!-- Goals Management Modal -->
    <div id="goals-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('goals-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏</h2>
                <button class="close-btn" onclick="closeModal('goals-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="goals-list" id="goals-list">
                    <!-- Goals will be dynamically added here -->
                </div>
                
                <button class="add-goal-btn" onclick="addNewGoal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
            </div>
        </div>
    </div>

    <!-- Date Filter Modal -->
    <div id="date-filter-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('date-filter-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h2>
                <button class="close-btn" onclick="closeModal('date-filter-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>–û—Ç</label>
                    <input type="date" id="date-from">
                </div>
                
                <div class="form-group">
                    <label>–î–æ</label>
                    <input type="date" id="date-to">
                </div>
                
                <div class="filter-actions">
                    <button class="apply-filter-btn" onclick="applyDateFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="reset-filter-btn" onclick="resetDateFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Language Selector Modal -->
    <div id="language-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('language-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
                <button class="close-btn" onclick="closeModal('language-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="language-options">
                    <button class="language-option" onclick="changeLanguage('ru')">–†—É—Å—Å–∫–∏–π</button>
                    <button class="language-option" onclick="changeLanguage('en')">English</button>
                    <button class="language-option" onclick="changeLanguage('tj')">–¢–æ“∑–∏–∫”£</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Currency Selector Modal -->
    <div id="currency-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('currency-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</h2>
                <button class="close-btn" onclick="closeModal('currency-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="currency-options">
                    <button class="currency-option" onclick="changeCurrency('USD')">USD ($)</button>
                    <button class="currency-option" onclick="changeCurrency('TJS')">TJS (TJS)</button>
                    <button class="currency-option" onclick="changeCurrency('RUB')">RUB (‚ÇΩ)</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- About Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('about-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
                <button class="close-btn" onclick="closeModal('about-modal')">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="about-content">
                    <div class="about-logo">üí∞</div>
                    <h2>VoiseTiFi</h2>
                    <p>–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏</p>
                    <p>–í–µ—Ä—Å–∏—è 1.0.0</p>
                    
                    <div class="about-features">
                        <h3>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</h3>
                        <ul>
                            <li>–£—á–µ—Ç –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</li>
                            <li>–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–π</li>
                            <li>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</li>
                            <li>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏ –∏ —Ü–µ–ª—è–º–∏</li>
                            <li>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–ª–∞—Ç–µ–∂–∏</li>
                            <li>–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</li>
                        </ul>
                    </div>
                    
                    <div class="about-contact">
                        <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</h3>
                        <p>Email: support@voicetifi.com</p>
                        <p>–í–µ–±: www.voicetifi.com</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>

   // Mustafoshoh Programer // State Management
   // üîß –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentOnboardingStep = 1; // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û!
let voiceManager = null;
let lineChartInstance = null;
let pieChartInstance = null;
   // üîß –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

let state = {
    user: {
        monthlyIncome: 0,
        currency: 'USD',
        language: 'ru',
        theme: 'dark',
        dailyLimit: 0
    },
    security: {
        pinEnabled: false,
        pinCode: null,
        biometricEnabled: false,
        hideAmounts: false,
        autoLockMinutes: 5,
        lastUnlockTime: null
    },

    transactions: [],
    loans: [],
    recurringPayments: [],
    savingsGoals: [],
    customCategories: {},
    categories: {
        food: { ru: '–ü—Ä–æ–¥—É–∫—Ç—ã', en: 'Groceries', tj: '–ú–∞“≥—Å—É–ª–æ—Ç', icon: 'üõí', color: '#10b981' },
        transport: { ru: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', en: 'Transport', tj: '–ù–∞–∫–ª–∏—ë—Ç', icon: 'üöñ', color: '#3b82f6' },
        restaurant: { ru: '–ö–∞—Ñ–µ', en: 'Dining', tj: '–•”Ø—Ä–æ–∫', icon: 'üçî', color: '#f59e0b' },
        health: { ru: '–ó–¥–æ—Ä–æ–≤—å–µ', en: 'Health', tj: '–°–∞–ª–æ–º–∞—Ç”£', icon: 'üíä', color: '#ef4444' },
        clothes: { ru: '–û–¥–µ–∂–¥–∞', en: 'Clothes', tj: '–õ–∏–±–æ—Å', icon: 'üëï', color: '#8b5cf6' },
        entertainment: { ru: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', en: 'Entertainment', tj: '–§–∞—Ä–æ“ì–∞—Ç', icon: 'üéÆ', color: '#ec4899' },
        bills: { ru: '–ö–æ–º–º—É–Ω–∞–ª–∫–∞', en: 'Bills', tj: '–ö–æ–º–º—É–Ω–∞–ª–∫–∞', icon: 'üí°', color: '#f97316' },
        other: { ru: '–î—Ä—É–≥–æ–µ', en: 'Other', tj: '–î–∏–≥–∞—Ä', icon: 'üì¶', color: '#6b7280' },
        goal: { 
    ru: '–¶–µ–ª—å', 
    en: 'Goal', 
    tj: '“≤–∞–¥–∞—Ñ', 
    icon: 'üéØ', 
    color: '#8b5cf6' 
},
        salary: { ru: '–ó–∞—Ä–ø–ª–∞—Ç–∞', en: 'Salary', tj: '–ú—É–∑–¥', icon: 'üíº', color: '#10b981' },
        freelance: { ru: '–§—Ä–∏–ª–∞–Ω—Å', en: 'Freelance', tj: '–§—Ä–∏–ª–∞–Ω—Å', icon: 'üíª', color: '#3b82f6' },
        gift: { ru: '–ü–æ–¥–∞—Ä–æ–∫', en: 'Gift', tj: '–¢—É“≥—Ñ–∞', icon: 'üéÅ', color: '#ec4899' },
        investment: { ru: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', en: 'Investment', tj: '–°–∞—Ä–º–æ—è–≥—É–∑–æ—Ä”£', icon: 'üìà', color: '#10b981' }
    },
    filters: {
        searchQuery: '',
        type: 'all',
        category: 'all',
        period: 'month',
        dateFrom: null,
        dateTo: null
    },
    settings: {
        notifications: {
            budget: true,
            debt: true,
            weekly: false,
            monthly: false
        }
    },
    currentScreen: 'home',
    editingTransaction: null,
    selectedCategory: null,
    isFirstLaunch: true,
    voiceRecognition: null,
    isRecording: false
};


// Mustafoshoh Programer // Currency System
const rates = {
    USD: 1,
    TJS: 10.7,
    RUB: 92
};

const currencySymbols = {
    USD: '$',
    TJS: 'TJS',
    RUB: '‚ÇΩ'
};

// Mustafoshoh Programer // Translations
const translations = {
    ru: {
        greeting: ['–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–î–æ–±—Ä—ã–π –¥–µ–Ω—å', '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä'],
        months: ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'],
        days: ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'],
        today: '–°–µ–≥–æ–¥–Ω—è',
        yesterday: '–í—á–µ—Ä–∞',
        week: '–ù–µ–¥–µ–ª—è',
        month: '–ú–µ—Å—è—Ü',
        year: '–ì–æ–¥',
        all: '–í—Å—ë –≤—Ä–µ–º—è',
        noData: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
        confirmDelete: '–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?',
        confirmClear: '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
        success: '–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
        error: '–û—à–∏–±–∫–∞',
        fillFields: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',
        welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VoiseTiFi! üéâ',
        voiceNotSupported: '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
        listening: '–°–ª—É—à–∞—é...',
        processing: '–û–±—Ä–∞–±–æ—Ç–∫–∞...',
        loanAdded: '–î–æ–ª–≥ –¥–æ–±–∞–≤–ª–µ–Ω',
        loanPaid: '–î–æ–ª–≥ –ø–æ–≥–∞—à–µ–Ω',
        goalCreated: '–¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞',
        goalReached: '–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞',
        recurringAdded: '–ü–ª–∞—Ç—ë–∂ –¥–æ–±–∞–≤–ª–µ–Ω'
    },
    en: {
        greeting: ['Good morning', 'Good afternoon', 'Good evening'],
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        today: 'Today',
        yesterday: 'Yesterday',
        week: 'Week',
        month: 'Month',
        year: 'Year',
        all: 'All time',
        noData: 'No data',
        confirmDelete: 'Delete transaction?',
        confirmClear: 'Delete all data? This cannot be undone!',
        success: 'Successfully saved',
        error: 'Error',
        fillFields: 'Fill all fields',
        welcome: 'Welcome to VoiseTiFi! üéâ',
        voiceNotSupported: 'Voice input not supported',
        listening: 'Listening...',
        processing: 'Processing...',
        loanAdded: 'Loan added',
        loanPaid: 'Loan paid',
        goalCreated: 'Goal created',
        goalReached: 'Goal reached',
        recurringAdded: 'Payment added'
    },
    tj: {
        greeting: ['–°—É–±“≥ –±–∞ —Ö–∞–π—Ä', '–†”Ø–∑ –±–∞ —Ö–∞–π—Ä', '–®–æ–º –±–∞ —Ö–∞–π—Ä'],
        months: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'],
        days: ['–Ø–∫—à–∞–Ω–±–µ', '–î—É—à–∞–Ω–±–µ', '–°–µ—à–∞–Ω–±–µ', '–ß–æ—Ä—à–∞–Ω–±–µ', '–ü–∞–Ω“∑—à–∞–Ω–±–µ', '“∂—É–º—ä–∞', '–®–∞–Ω–±–µ'],
        today: '–ò–º—Ä”Ø–∑',
        yesterday: '–î–∏—Ä”Ø–∑',
        week: '“≤–∞—Ñ—Ç–∞',
        month: '–ú–æ“≥',
        year: '–°–æ–ª',
        all: '“≤–∞–º–∞ –≤–∞“õ—Ç',
        noData: '–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç',
        confirmDelete: '–ù–µ—Å—Ç –∫—É–Ω–µ–¥?',
        confirmClear: '“≤–∞–º–∞—Ä–æ –Ω–µ—Å—Ç –∫—É–Ω–µ–¥?',
        success: '–ú—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç',
        error: '–•–∞—Ç–æ–≥”£',
        fillFields: '“≤–∞–º–∞—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥',
        welcome: 'VoiseTiFi-—Ä–æ —Ö—É—à –æ–º–∞–¥–µ–¥! üéâ',
        voiceNotSupported: '–í–æ—Ä–∏–¥–∏ –æ–≤–æ–∑ –¥–∞—Å—Ç–≥–∏—Ä”£ –Ω–∞–º–µ—à–∞–≤–∞–¥',
        listening: '–ì”Ø—à –º–µ–∫—É–Ω–∞–º...',
        processing: '–ö–æ—Ä–∫–∞—Ä–¥...',
        loanAdded: '“ö–∞—Ä–∑ –∏–ª–æ–≤–∞ —à—É–¥',
        loanPaid: '“ö–∞—Ä–∑ –ø–∞—Ä–¥–æ—Ö—Ç —à—É–¥',
        goalCreated: '“≤–∞–¥–∞—Ñ —ç“∑–æ–¥ —à—É–¥',
        goalReached: '“≤–∞–¥–∞—Ñ –Ω–æ–∏–ª —à—É–¥',
        recurringAdded: '–ü–∞—Ä–¥–æ—Ö—Ç –∏–ª–æ–≤–∞ —à—É–¥'
    }
};


// Mustafoshoh Programer // Chart instances


// Mustafoshoh Programer // Initialize App
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    loadData();
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Chart.js
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    initializeApp();
    
    // Setup event listeners
    setupEventListeners();
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    checkNotifications();
    
    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
    processRecurringPayments();
    
    console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ');
});
// Mustafoshoh Programer // Load Data
function loadData() {
    try {
        const saved = localStorage.getItem('voicetifi_mobile');
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            state.isFirstLaunch = false;
        }
    } catch (e) {
        console.error('Load error:', e);
    }
}

// Mustafoshoh Programer // Save Data
function saveData() {
    try {
        const backup = localStorage.getItem('voicetifi_mobile');
        if (backup) {
            localStorage.setItem('voicetifi_mobile_backup', backup);
        }
        localStorage.setItem('voicetifi_mobile', JSON.stringify(state));
    } catch (e) {
        console.error('Save error:', e);
    }
}

// Mustafoshoh Programer // Initialize App
function initializeApp() {
    if (state.isFirstLaunch) {
        showOnboarding();
    } else {
        checkSecurityOnLoad();
    }
    
    const onboardingEl = document.getElementById('onboarding');
    const appEl = document.getElementById('app');
    
    if (onboardingEl) {
        onboardingEl.style.display = 'none';
    }
    
    if (appEl) {
        appEl.style.display = 'block';
        appEl.style.opacity = '1';
    }
    
    // üî• –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–∏–º–∏—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    initializeCategoryLimits();
    
    applyTheme();
    updateUI();
    renderAllScreens();
    
    // üî• –ó–ê–ü–£–°–ö–ê–ï–ú –£–ú–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –° –ó–ê–î–ï–†–ñ–ö–û–ô
    setTimeout(() => {
        checkSmartNotifications();
    }, 3000);
    
    setTimeout(() => {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        }
        initializeVoiceRecognition();
    }, 200);
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

// Mustafoshoh Programer // Onboarding


function showOnboarding() {
    const onboardingEl = document.getElementById('onboarding');
    const appEl = document.getElementById('app');
    
    if (onboardingEl) onboardingEl.classList.add('active');
    if (appEl) appEl.style.display = 'none';
}

// üî• –í–†–ï–ú–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
function testCategoryLimits() {
    console.log('üß™ Testing category limits...');
    console.log('State category limits:', state.categoryLimits);
    console.log('Settings screen:', document.getElementById('settings-screen'));
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª
    renderCategoryLimitsSection();
}

// –í—ã–∑–æ–≤–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞: testCategoryLimits()

function addTestData() {
    // ‚ùå –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï –û–¢–ö–õ–Æ–ß–ï–ù–´
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ
    
    console.log('‚ÑπÔ∏è –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã');
    return;
    
    /* –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    console.log('üìä –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
    
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000;
    const oneHour = 60 * 60 * 1000;
    
    const testTransactions = [];
    let idCounter = now;
    
    // ... –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    
    state.transactions = testTransactions;
    saveData();
    
    console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ' + testTransactions.length + ' —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
    */
}

/*******  8696572d-3812-4eab-be58-b03f9b651af7  *******/
function nextOnboardingStep() {
    const currentStepEl = document.querySelector(`.onboarding-step.active`);
    
    if (currentOnboardingStep === 2) {
        const income = parseFloat(document.getElementById('monthly-income').value);
        if (!income || income <= 0) {
            showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞', 'error');
            return;
        }
        state.user.monthlyIncome = income;
        state.user.dailyLimit = income / 30;
    }
    
    if (currentStepEl) currentStepEl.classList.remove('active');
    currentOnboardingStep++;
    
    const nextStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
    if (nextStepEl) {
        nextStepEl.classList.add('active');
    }
}

function finishOnboarding() {
    state.isFirstLaunch = false;
    saveData();
    
    const onboardingEl = document.getElementById('onboarding');
    const appEl = document.getElementById('app');
    
    if (onboardingEl) {
        onboardingEl.style.transition = 'opacity 0.3s ease';
        onboardingEl.style.opacity = '0';
        
        setTimeout(() => {
            onboardingEl.style.display = 'none';
            onboardingEl.classList.remove('active');
            
            if (appEl) {
                appEl.style.display = 'block';
                appEl.style.opacity = '0';
                appEl.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    appEl.style.opacity = '1';
                    applyTheme();
                    updateUI();
                    renderAllScreens();
                    
                    setTimeout(() => {
                        initializeCharts();
                        initializeVoiceRecognition();
                    }, 100);
                    
                    showToast(translations[state.user.language].welcome, 'success');
                }, 50);
            }
        }, 300);
    }
}

function selectCurrency(currency) {
    state.user.currency = currency;
    document.querySelectorAll('.currency-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.currency === currency) {
            btn.classList.add('active');
        }
    });
}

function selectLanguage(lang) {
    state.user.language = lang;
    document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === lang) {
            btn.classList.add('active');
        }
    });
}

// Mustafoshoh Programer // Navigation
function switchScreen(screenName) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const screenEl = document.getElementById(`${screenName}-screen`);
    if (screenEl) screenEl.classList.add('active');
    
    const navBtn = document.querySelector(`.nav-btn[data-screen="${screenName}"]`);
    if (navBtn) navBtn.classList.add('active');
    
    state.currentScreen = screenName;
    
    if (screenName === 'home') renderHomeScreen();
    if (screenName === 'analytics') {
        setTimeout(() => renderAnalyticsScreen(), 100);
    }
    if (screenName === 'history') renderHistoryScreen();
    if (screenName === 'settings') renderSettingsScreen();
}

// Mustafoshoh Programer // Home Screen
function renderHomeScreen() {
    updateGreeting();
    updateBalanceCard();
    updateQuickStats();
    updateRecurringPayments(); // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û!
    updateRecentTransactions();
    checkAlerts();
}

function updateRecurringPayments() {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    let container = document.getElementById('recurring-payments-widget');
    
    if (!container) {
        // –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç
        const alertsContainer = document.getElementById('alerts-container');
        if (alertsContainer) {
            container = document.createElement('div');
            container.id = 'recurring-payments-widget';
            container.className = 'recurring-payments-container';
            container.style.marginBottom = 'var(--spacing-lg)';
            alertsContainer.parentElement.insertBefore(container, alertsContainer);
        } else {
            return;
        }
    }
    
    if (state.recurringPayments.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    const activePayments = state.recurringPayments.filter(p => p.isActive);
    
    if (activePayments.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = `
        <div class="section-header">
            <h3>üîÅ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
            <a href="#" onclick="manageRecurring()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
        </div>
        <div class="recurring-payments-list">
            ${activePayments.map(payment => {
                const nextDate = new Date(payment.nextDate);
                const daysUntil = Math.ceil((nextDate - new Date()) / (24 * 60 * 60 * 1000));
                
                let statusText = '';
                let statusColor = '';
                
                if (daysUntil < 0) {
                    statusText = `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${Math.abs(daysUntil)} –¥–Ω.`;
                    statusColor = '#ef4444';
                } else if (daysUntil === 0) {
                    statusText = '–°–µ–≥–æ–¥–Ω—è!';
                    statusColor = '#f59e0b';
                } else if (daysUntil <= 3) {
                    statusText = `–ß–µ—Ä–µ–∑ ${daysUntil} –¥–Ω.`;
                    statusColor = '#f59e0b';
                } else {
                    statusText = nextDate.toLocaleDateString('ru-RU');
                    statusColor = '#10b981';
                }
                
                return `
                    <div class="recurring-payment-item">
                        <div class="recurring-icon">üîÑ</div>
                        <div class="recurring-info">
                            <div class="recurring-name">${payment.name}</div>
                            <div class="recurring-date" style="color: ${statusColor};">${statusText}</div>
                        </div>
                        <div class="recurring-amount">${formatCurrency(payment.amount)}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function updateGreeting() {
    const hour = new Date().getHours();
    const lang = state.user.language;
    let greetingIndex = 1;
    if (hour < 12) greetingIndex = 0;
    if (hour >= 18) greetingIndex = 2;
    
    const greetingEl = document.getElementById('greeting-text');
    if (greetingEl) {
        greetingEl.textContent = translations[lang].greeting[greetingIndex];
    }
    
    const date = new Date();
    const dayName = translations[lang].days[date.getDay()];
    const day = date.getDate();
    const month = translations[lang].months[date.getMonth()];
    
    const dateEl = document.getElementById('current-date');
    if (dateEl) {
        dateEl.textContent = `${dayName}, ${day} ${month}`;
    }
}

function updateBalanceCard() {
    //const rate = rates[state.user.currency] || 1;
    //const budget = state.user.monthlyIncome * rate;
   const budget = state.user.monthlyIncome; // –ë–ï–ó —É–º–Ω–æ–∂–µ–Ω–∏—è!
    const rate = rates[state.user.currency] || 1;
    
    const expenses = getFilteredTransactions('expense', 'month');
    const totalExpense = expenses.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        return sum + convertedAmount;
    }, 0);
    
    const income = getFilteredTransactions('income', 'month');
    const totalIncome = income.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        return sum + convertedAmount;
    }, 0);
    
    const balance = budget + totalIncome - totalExpense;
    const spentPercent = budget > 0 ? Math.min((totalExpense / budget) * 100, 100) : 0;
    
    updateElementText('total-balance', formatCurrency(balance));
    updateElementText('total-income', '+' + formatCurrency(totalIncome));
    updateElementText('total-expense', '-' + formatCurrency(totalExpense));
    
    const progressEl = document.getElementById('budget-progress');
    if (progressEl) {
        progressEl.style.width = spentPercent + '%';
    }
    
    updateElementText('spent-percent', Math.round(spentPercent) + '%');
}
function updateQuickStats() {
    const rate = rates[state.user.currency] || 1;
    
    const today = getFilteredTransactions('expense', 'today');
    const todayTotal = today.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    const week = getFilteredTransactions('expense', 'week');
    const weekTotal = week.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    const month = getFilteredTransactions('expense', 'month');
    const monthTotal = month.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    updateElementText('today-spent', '-' + formatCurrency(todayTotal));
    updateElementText('week-spent', '-' + formatCurrency(weekTotal));
    updateElementText('month-spent', '-' + formatCurrency(monthTotal));
}

function updateRecentTransactions() {
    const container = document.getElementById('recent-transactions');
    if (!container) return;
    
    const recent = state.transactions.slice(0, 5);
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recent.map(t => createTransactionHTML(t)).join('');
}

function checkAlerts() {
    const container = document.getElementById('alerts-container');
    if (!container) return;
    
    const alerts = [];
    const rate = rates[state.user.currency] || 1;
    const budget = state.user.monthlyIncome * rate;
    const expenses = getFilteredTransactions('expense', 'month');
    const totalExpense = expenses.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    if (totalExpense > budget * 0.9 && totalExpense < budget) {
        alerts.push({
            type: 'warning',
            icon: '‚ö†Ô∏è',
            title: '–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –ª–∏–º–∏—Ç—É',
            text: `–í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ${Math.round((totalExpense/budget)*100)}% –æ—Ç –±—é–¥–∂–µ—Ç–∞`
        });
    }
    
    if (totalExpense > budget) {
        alerts.push({
            type: 'danger',
            icon: 'üö®',
            title: '–ü—Ä–µ–≤—ã—à–µ–Ω –±—é–¥–∂–µ—Ç!',
            text: `–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: ${formatCurrency(totalExpense - budget)}`
        });
    }
    
    if (state.loans.length > 0) {
        const totalDebt = state.loans.reduce((sum, l) => {
            const loanRate = rates[l.currency || state.user.currency] || 1;
            return sum + ((l.amount * loanRate) / rate);
        }, 0);
        alerts.push({
            type: 'info',
            icon: 'üí≥',
            title: '–ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–ª–≥–∏',
            text: `–£ –≤–∞—Å ${state.loans.length} –¥–æ–ª–≥–æ–≤ –Ω–∞ —Å—É–º–º—É ${formatCurrency(totalDebt)}`
        });
    }
    
    container.innerHTML = alerts.map(a => `
        <div class="alert ${a.type}">
            <div class="alert-icon">${a.icon}</div>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-text">${a.text}</div>
            </div>
        </div>
    `).join('');
}

// Mustafoshoh Programer // Analytics Screen
function renderAnalyticsScreen() {
    updateAnalyticsCards();
     
    // ‚ú® –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –ó–ê–î–ï–†–ñ–ö–£:
    setTimeout(() => {
        renderLineChart();
        renderPieChart();
        renderTopCategories();
        renderComparison();
        renderCalendarHeatmap();
    }, 150); // –ñ–¥—ë–º 150ms –ø–æ–∫–∞ DOM –æ–±–Ω–æ–≤–∏—Ç—Å—è
}

function initializeCharts() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        setTimeout(initializeCharts, 200);
        return;
    }
    
    Chart.defaults.color = '#a0a0c0';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 12;
}

function updateAnalyticsCards() {
    const rate = rates[state.user.currency] || 1;
    const period = state.filters.period;
    
    const expenses = getFilteredTransactions('expense', period);
    const totalExpense = expenses.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    const income = getFilteredTransactions('income', period);
    const totalIncome = income.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        return sum + ((t.amount * txRate) / rate);
    }, 0);
    
    const balance = totalIncome - totalExpense;
    const days = getPeriodDays(period);
    const daily = days > 0 ? totalExpense / days : 0;
    
    updateElementText('analytics-income', formatCurrency(totalIncome));
    updateElementText('analytics-expense', formatCurrency(totalExpense));
    updateElementText('analytics-balance', formatCurrency(balance));
    updateElementText('analytics-daily', formatCurrency(daily));
}

function renderLineChart() {
     if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        setTimeout(renderLineChart, 300);
        return;
    }
    
    const canvas = document.getElementById('line-chart');
    if (!canvas) {
        console.warn('‚ö†Ô∏è Canvas line-chart –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Cannot get 2D context');
        return;
    }
    
    // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫
    if (lineChartInstance) {
        lineChartInstance.destroy();
        lineChartInstance = null;
    }
    
    const period = state.filters.period;
    const data = getChartData(period);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (!data.labels || data.labels.length === 0) {
        const container = canvas.parentElement;
        canvas.style.display = 'none';
        
        let emptyState = container.querySelector('.chart-empty-state');
        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'chart-empty-state';
            emptyState.style.cssText = 'text-align:center;padding:40px;color:var(--text-secondary);';
            emptyState.innerHTML = `
                <div style="font-size:48px;margin-bottom:16px;">üìä</div>
                <div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            `;
            container.appendChild(emptyState);
        }
        return;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å canvas, —Å–∫—Ä—ã—Ç—å empty state
    canvas.style.display = 'block';
    const emptyState = canvas.parentElement.querySelector('.chart-empty-state');
    if (emptyState) emptyState.remove();
    
    try {
        lineChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '–†–∞—Å—Ö–æ–¥—ã',
                    data: data.values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { 
                        display: false 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 15, 35, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: (context) => '–†–∞—Å—Ö–æ–¥—ã: ' + formatCurrency(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { 
                            color: 'rgba(255,255,255,0.05)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#a0a0c0',
                            callback: (value) => formatCurrency(value)
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#a0a0c0' }
                    }
                }
            }
        });
        
        console.log('‚úÖ Line chart rendered successfully');
        
    } catch (error) {
        console.error('‚ùå Line chart error:', error);
        canvas.style.display = 'none';
        
        const container = canvas.parentElement;
        let errorDiv = container.querySelector('.chart-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error';
            errorDiv.style.cssText = 'text-align:center;padding:40px;color:#ef4444;';
            errorDiv.innerHTML = `
                <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞</div>
            `;
            container.appendChild(errorDiv);
        }
    }
} 

function renderPieChart() {
    const canvas = document.getElementById('pie-chart');
    if (!canvas) {
        console.warn('Pie chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Cannot get 2D context');
        return;
    }
    
    // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫
    if (pieChartInstance) {
        pieChartInstance.destroy();
        pieChartInstance = null;
    }
    
    const period = state.filters.period;
    const expenses = getFilteredTransactions('expense', period);
    const rate = rates[state.user.currency] || 1;
    
    const categoryData = {};
    expenses.forEach(t => {
        const cat = t.category || 'other';
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        categoryData[cat] = (categoryData[cat] || 0) + convertedAmount;
    });
    
    const entries = Object.entries(categoryData).filter(([, v]) => v > 0);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (entries.length === 0) {
        const container = canvas.parentElement;
        canvas.style.display = 'none';
        
        let emptyState = container.querySelector('.chart-empty-state');
        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'chart-empty-state';
            emptyState.style.cssText = 'text-align:center;padding:40px;color:var(--text-secondary);';
            emptyState.innerHTML = `
                <div style="font-size:48px;margin-bottom:16px;">ü•ß</div>
                <div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            `;
            container.appendChild(emptyState);
        }
        return;
    }
    
    canvas.style.display = 'block';
    const emptyState = canvas.parentElement.querySelector('.chart-empty-state');
    if (emptyState) emptyState.remove();
    
    const labels = entries.map(([cat]) => {
        const c = state.categories[cat] || state.categories.other;
        return c[state.user.language];
    });
    const values = entries.map(([, amt]) => amt);
    const bgColors = entries.map(([cat]) => {
        const c = state.categories[cat] || state.categories.other;
        return c.color;
    });
    
    try {
        pieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#a0a0c0',
                            font: { size: 12 },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 15, 35, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: (context) => {
                                const total = values.reduce((s, n) => s + n, 0);
                                const percent = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${formatCurrency(context.parsed)} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Pie chart rendered successfully');
        
    } catch (error) {
        console.error('‚ùå Pie chart error:', error);
        canvas.style.display = 'none';
        
        const container = canvas.parentElement;
        let errorDiv = container.querySelector('.chart-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error';
            errorDiv.style.cssText = 'text-align:center;padding:40px;color:#ef4444;';
            errorDiv.innerHTML = `
                <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞</div>
            `;
            container.appendChild(errorDiv);
        }
    }
}

function renderTopCategories() {
    const container = document.getElementById('top-categories');
    if (!container) return;
    
    const period = state.filters.period;
    const expenses = getFilteredTransactions('expense', period);
    const rate = rates[state.user.currency] || 1;
    
    const categoryData = {};
    expenses.forEach(t => {
        const cat = t.category || 'other';
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        categoryData[cat] = (categoryData[cat] || 0) + convertedAmount;
    });
    
    const sorted = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    if (sorted.length === 0) {
        container.innerHTML = `<div class="empty-state-text">${translations[state.user.language].noData}</div>`;
        return;
    }
    
    const max = sorted[0]?.[1] || 1;
    
    container.innerHTML = sorted.map(([cat, amount]) => {
        const c = state.categories[cat] || state.categories.other;
        const percent = (amount / max) * 100;
        
        return `
            <div class="category-bar">
                <div class="category-bar-header">
                    <span class="category-bar-name">${c.icon} ${c[state.user.language]}</span>
                    <span class="category-bar-value">${formatCurrency(amount)}</span>
                </div>
                <div class="category-bar-progress">
                    <div class="category-bar-fill" style="width: ${percent}%; background: ${c.color};"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderComparison() {
    const now = new Date();
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const previousMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
    const previousMonthEnd = currentMonthStart - 1;
    
    const rate = rates[state.user.currency] || 1;
    
    const currentExpenses = state.transactions
        .filter(t => t.type === 'expense' && t.timestamp >= currentMonthStart)
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const previousExpenses = state.transactions
        .filter(t => t.type === 'expense' && t.timestamp >= previousMonthStart && t.timestamp <= previousMonthEnd)
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const currentIncome = state.transactions
        .filter(t => t.type === 'income' && t.timestamp >= currentMonthStart)
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const previousIncome = state.transactions
        .filter(t => t.type === 'income' && t.timestamp >= previousMonthStart && t.timestamp <= previousMonthEnd)
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const expenseChange = previousExpenses > 0 
        ? ((currentExpenses - previousExpenses) / previousExpenses * 100).toFixed(1)
        : 0;
    
    const incomeChange = previousIncome > 0
        ? ((currentIncome - previousIncome) / previousIncome * 100).toFixed(1)
        : 0;
    
    const expenseEl = document.getElementById('expense-comparison');
    const incomeEl = document.getElementById('income-comparison');
    
    if (expenseEl) {
        expenseEl.textContent = `${expenseChange > 0 ? '+' : ''}${expenseChange}%`;
        expenseEl.className = `comparison-value ${expenseChange > 0 ? 'negative' : 'positive'}`;
    }
    
    if (incomeEl) {
        incomeEl.textContent = `${incomeChange > 0 ? '+' : ''}${incomeChange}%`;
        incomeEl.className = `comparison-value ${incomeChange > 0 ? 'positive' : 'negative'}`;
    }
}

function renderCalendarHeatmap() {
    const container = document.getElementById('calendar-heatmap');
    if (!container) return;
    
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const rate = rates[state.user.currency] || 1;
    
    const dailyExpenses = {};
    state.transactions.filter(t => t.type === 'expense').forEach(t => {
        const date = new Date(t.timestamp);
        if (date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear()) {
            const day = date.getDate();
            const txRate = rates[t.currency] || 1;
            const convertedAmount = (t.amount * txRate) / rate;
            dailyExpenses[day] = (dailyExpenses[day] || 0) + convertedAmount;
        }
    });
    
    const maxExpense = Math.max(...Object.values(dailyExpenses), 1);
    
    let html = '';
    for (let i = 1; i <= daysInMonth; i++) {
        const expense = dailyExpenses[i] || 0;
        const intensity = expense / maxExpense;
        let bgColor = 'rgba(102, 126, 234, 0.1)';
        
        if (intensity > 0) {
            bgColor = `rgba(102, 126, 234, ${0.2 + intensity * 0.8})`;
        }
        
        const isToday = i === today.getDate();
        const border = isToday ? 'border: 2px solid #667eea;' : '';
        
        html += `
            <div class="calendar-day ${expense === 0 ? 'empty' : ''}" 
                 style="background: ${bgColor}; ${border}" 
                 title="${i}: ${formatCurrency(expense)}">
                ${i}
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Mustafoshoh Programer // Period Selection
function selectPeriod(period) {
    state.filters.period = period;
    
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.period === period);
    });
    
    renderAnalyticsScreen();
}


function getChartData(period) {
    const transactions = getFilteredTransactions('expense', period);
    const rate = rates[state.user.currency] || 1;
    
    if (transactions.length === 0) {
        return { labels: [], values: [] };
    }
    
    const grouped = {};
    
    transactions.forEach(t => {
        const date = new Date(t.timestamp);
        let key;
        
        switch(period) {
            case 'today':
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å–∞–º (0-23)
                key = date.getHours() + ':00';
                break;
                
            case 'week':
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
                const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
                key = dayNames[date.getDay()];
                break;
                
            case 'month':
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞ (1-31)
                key = date.getDate();
                break;
                
            case 'year':
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º
                const monthNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
                key = monthNames[date.getMonth()];
                break;
                
            default:
                key = date.toLocaleDateString();
        }
        
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        grouped[key] = (grouped[key] || 0) + convertedAmount;
    });
    
    // ==========================================
    // –ó–ê–ü–û–õ–ù–ò–¢–¨ –ü–£–°–¢–´–ï –ü–ï–†–ò–û–î–´
    // ==========================================
    
    let labels = [];
    let values = [];
    
    if (period === 'today') {
        // –í—Å–µ 24 —á–∞—Å–∞
        for (let h = 0; h < 24; h++) {
            const hourKey = h + ':00';
            labels.push(hourKey);
            values.push(grouped[hourKey] || 0);
        }
    } 
    else if (period === 'week') {
        // –í—Å–µ 7 –¥–Ω–µ–π
        const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
        dayNames.forEach(day => {
            labels.push(day);
            values.push(grouped[day] || 0);
        });
    } 
    else if (period === 'month') {
        // –í—Å–µ –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (1-31)
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
            labels.push(d.toString());
            values.push(grouped[d] || 0);
        }
    } 
    else if (period === 'year') {
        // –í—Å–µ 12 –º–µ—Å—è—Ü–µ–≤
        const monthNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
        monthNames.forEach(month => {
            labels.push(month);
            values.push(grouped[month] || 0);
        });
    }
    
    return {
        labels: labels,
        values: values
    };
}

function getPeriodDays(period) {
    switch(period) {
        case 'today': return 1;
        case 'week': return 7;
        case 'month': return 30;
        case 'year': return 365;
        default: return 30;
    }
}

// Mustafoshoh Programer // History Screen
function renderHistoryScreen() {
    renderTransactionsList();
    updatePeriodTotals();
    populateCategoryFilter();
}

function renderTransactionsList() {
    const container = document.getElementById('transactions-list');
    if (!container) return;
    
    let transactions = getFilteredTransactions();
    
    if (state.filters.searchQuery) {
        transactions = transactions.filter(t => 
            t.description?.toLowerCase().includes(state.filters.searchQuery.toLowerCase())
        );
    }
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }
    
    const grouped = groupTransactionsByDate(transactions);
    
    container.innerHTML = Object.entries(grouped).map(([date, trans]) => `
        <div class="date-group">
            <div class="date-header">${date}</div>
            ${trans.map(t => createTransactionHTML(t)).join('')}
        </div>
    `).join('');
}

function updatePeriodTotals() {
    const rate = rates[state.user.currency] || 1;
    const transactions = getFilteredTransactions();
    
    const income = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const expenses = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
    
    const balance = income - expenses;
    
    updateElementText('period-income', '+' + formatCurrency(income));
    updateElementText('period-expenses', '-' + formatCurrency(expenses));
    updateElementText('period-balance', formatCurrency(balance));
}

function populateCategoryFilter() {
    const filter = document.getElementById('category-filter');
    if (!filter) return;
    
    const categories = new Set();
    state.transactions.forEach(t => {
        if (t.category) categories.add(t.category);
    });
    
    filter.innerHTML = '<option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    Array.from(categories).sort().forEach(cat => {
        const c = state.categories[cat] || state.categories.other;
        filter.innerHTML += `<option value="${cat}">${c[state.user.language]}</option>`;
    });
}

function filterTransactions() {
    state.filters.searchQuery = document.getElementById('search-input')?.value || '';
    state.filters.type = document.getElementById('type-filter')?.value || 'all';
    state.filters.category = document.getElementById('category-filter')?.value || 'all';
    
    renderTransactionsList();
    updatePeriodTotals();
}

// Mustafoshoh Programer // Settings Screen
function renderSettingsScreen() {
   updateSettingsValues();
    updateToggleStates();
    updateSecurityToggles(); // ‚úÖ –î–û–ë–ê–í–ò–¢–¨

      // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î - –î–û–ë–ê–í–õ–Ø–ï–ú –õ–ò–ú–ò–¢–´ –ö–ê–¢–ï–ì–û–†–ò–ô
    setTimeout(() => {
        renderCategoryLimitsSection();
    }, 100);
}

// üî• –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –°–†–ê–ó–£ –ü–û–°–õ–ï renderSettingsScreen()
function renderCategoryLimitsSection() {
    const settingsContent = document.querySelector('#settings-screen .screen-content');
    if (!settingsContent) {
        console.log('‚ùå Settings content not found');
        return;
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–∞–∑–¥–µ–ª –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldSection = document.getElementById('category-limits-section');
    if (oldSection) {
        oldSection.remove();
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª
    const limitsSection = document.createElement('div');
    limitsSection.className = 'settings-section';
    limitsSection.id = 'category-limits-section';
    limitsSection.innerHTML = `
        <h3>üéØ –õ–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <div class="category-limits-list" id="category-limits-list">
            ${renderCategoryLimitsList()}
        </div>
        <button class="setting-btn" onclick="editAllCategoryLimits()" style="margin-top: 10px; width: 100%;">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–∏–º–∏—Ç—ã
        </button>
    `;
    
    // –ù–∞—Ö–æ–¥–∏–º —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ—Ñ–∏–ª—å –∏ –±—é–¥–∂–µ—Ç" –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –Ω–µ–≥–æ
    const profileSection = settingsContent.querySelector('.settings-section');
    if (profileSection) {
        profileSection.parentNode.insertBefore(limitsSection, profileSection.nextSibling);
        console.log('‚úÖ Category limits section added');
    } else {
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
        settingsContent.prepend(limitsSection);
        console.log('‚úÖ Category limits section added to start');
    }
}

function renderCategoryLimitsList() {
    if (!state.categoryLimits) initializeCategoryLimits();
    
    const expenseCategories = Object.keys(state.categories).filter(key => {
        const cat = state.categories[key];
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
        return !['salary', 'freelance', 'gift', 'investment'].includes(key);
    });
    
    if (expenseCategories.length === 0) {
        return '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤</div>';
    }
    
    return expenseCategories.map(category => {
        const cat = state.categories[category];
        const limit = state.categoryLimits[category] || 0;
        const spent = getCategorySpentThisMonth(category);
        const percent = limit > 0 ? Math.min((spent / limit) * 100, 100) : 0;
        
        let progressColor = '#10b981'; // green
        if (percent > 90) progressColor = '#ef4444'; // red
        else if (percent > 70) progressColor = '#f59e0b'; // yellow
        
        return `
            <div class="category-limit-item">
                <div class="category-limit-header">
                    <span>${cat.icon} ${cat[state.user.language]}</span>
                    <span class="category-limit-value">${formatCurrency(limit)}</span>
                </div>
                <div class="category-limit-progress">
                    <div class="category-limit-progress-bar">
                        <div class="category-limit-progress-fill" 
                             style="width: ${percent}%; background: ${progressColor};">
                        </div>
                    </div>
                    <span class="category-limit-spent">${formatCurrency(spent)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function getCategorySpentThisMonth(category) {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    const monthExpenses = state.transactions.filter(t => {
        if (t.type !== 'expense') return false;
        if (t.category !== category) return false;
        
        const date = new Date(t.timestamp);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
    });
    
    const rate = rates[state.user.currency] || 1;
    return monthExpenses.reduce((sum, t) => {
        const txRate = rates[t.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        return sum + convertedAmount;
    }, 0);
}
   

function editAllCategoryLimits() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–õ–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="category-limits-edit" id="category-limits-edit">
                    ${renderCategoryLimitsEdit()}
                </div>
                <button class="save-btn" onclick="saveCategoryLimits()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function renderCategoryLimitsEdit() {
    if (!state.categoryLimits) initializeCategoryLimits();
    
    const expenseCategories = Object.keys(state.categories).filter(key => {
        // –¢–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
        return !['salary', 'freelance', 'gift', 'investment'].includes(key);
    });
    
    return expenseCategories.map(category => {
        const cat = state.categories[category];
        const limit = state.categoryLimits[category] || 0;
        const spent = getCategorySpentThisMonth(category);
        
        return `
            <div class="form-group">
                <label>
                    ${cat.icon} ${cat[state.user.language]}
                    <span style="color: var(--text-secondary); font-size: 12px;">
                        (–ø–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatCurrency(spent)})
                    </span>
                </label>
                <input type="number" 
                       class="desc-input category-limit-input" 
                       data-category="${category}"
                       value="${limit}"
                       placeholder="0.00"
                       step="0.01"
                       min="0">
            </div>
        `;
    }).join('');
}

function saveCategoryLimits() {
    const inputs = document.querySelectorAll('.category-limit-input');
    let hasChanges = false;
    
    inputs.forEach(input => {
        const category = input.dataset.category;
        const limit = parseFloat(input.value) || 0;
        
        if (state.categoryLimits[category] !== limit) {
            state.categoryLimits[category] = limit;
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        saveData();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        const limitsList = document.getElementById('category-limits-list');
        if (limitsList) {
            limitsList.innerHTML = renderCategoryLimitsList();
        }
        
        showToast('üéØ –õ–∏–º–∏—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const modal = document.querySelector('.modal.active');
    if (modal) modal.remove();
}
function renderCategoryLimitsEdit() {
    if (!state.categoryLimits) initializeCategoryLimits();
    
    const expenseCategories = Object.keys(state.categories).filter(key => {
        const cat = state.categories[key];
        return !cat.isCustom || cat.isExpense !== false;
    });
    
    return expenseCategories.map(category => {
        const cat = state.categories[category];
        const limit = state.categoryLimits[category] || 0;
        
        return `
            <div class="form-group">
                <label>${cat.icon} ${cat[state.user.language]}</label>
                <input type="number" 
                       class="desc-input category-limit-input" 
                       data-category="${category}"
                       value="${limit}"
                       placeholder="0.00"
                       step="0.01"
                       min="0">
            </div>
        `;
    }).join('');
}

function saveCategoryLimits() {
    const inputs = document.querySelectorAll('.category-limit-input');
    inputs.forEach(input => {
        const category = input.dataset.category;
        const limit = parseFloat(input.value) || 0;
        state.categoryLimits[category] = limit;
    });
    
    saveData();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    const limitsList = document.getElementById('category-limits-list');
    if (limitsList) {
        limitsList.innerHTML = renderCategoryLimitsList();
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const modal = document.querySelector('.modal.active');
    if (modal) modal.remove();
    
    showToast('–õ–∏–º–∏—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

// üî• –û–ë–ù–û–í–ò–¢–ï renderSettingsScreen()
function renderSettingsScreen() {
    updateSettingsValues();
    updateToggleStates();
    updateSecurityToggles();
    
    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –†–ê–ó–î–ï–õ –õ–ò–ú–ò–¢–û–í
    setTimeout(() => {
        renderCategoryLimitsSection();
    }, 100);
}

function updateSettingsValues() {
    const rate = rates[state.user.currency] || 1;
    updateElementText('settings-income', formatCurrency(state.user.monthlyIncome * rate));
    updateElementText('daily-limit', formatCurrency(state.user.dailyLimit * rate));
    updateElementText('current-language', 
        state.user.language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 
        state.user.language === 'en' ? 'English' : '–¢–æ“∑–∏–∫”£'
    );
    updateElementText('current-currency', state.user.currency);
}

function updateToggleStates() {
    const darkThemeEl = document.getElementById('dark-theme');
    const limitNotifEl = document.getElementById('limit-notifications');
    const budgetNotifEl = document.getElementById('budget-notifications');
    const debtNotifEl = document.getElementById('debt-notifications');
    const weeklyReportEl = document.getElementById('weekly-report');
    
    if (darkThemeEl) darkThemeEl.checked = state.user.theme === 'dark';
    if (limitNotifEl) limitNotifEl.checked = state.settings.notifications.budget;
    if (budgetNotifEl) budgetNotifEl.checked = state.settings.notifications.budget;
    if (debtNotifEl) debtNotifEl.checked = state.settings.notifications.debt;
    if (weeklyReportEl) weeklyReportEl.checked = state.settings.notifications.weekly;
}

// === THEME TOGGLE SYSTEM ===
function toggleTheme() {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
    const currentTheme = state.user.theme;
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
    document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    state.user.theme = newTheme;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é —Ç–µ–º—É
    applyTheme(newTheme);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    saveData();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI —ç–ª–µ–º–µ–Ω—Ç—ã, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç —Ç–µ–º—ã
    updateThemeDependentElements();
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const themeNames = {
        dark: 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞',
        light: '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞'
    };
    showToast(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ${themeNames[newTheme]}`, 'info');
    
    // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–∫—Ç–∏–ª—å–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    if ('vibrate' in navigator) {
        navigator.vibrate(50);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –≤ meta-—Ç–µ–≥–µ
    updateThemeMetaTag(newTheme);
}

// === –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –¢–ï–ú–´ ===
function applyTheme(theme = state.user.theme) {
    const body = document.body;
    
    if (theme === 'light') {
        body.classList.add('light');
        body.classList.remove('dark');
    } else {
        body.classList.add('dark');
        body.classList.remove('light');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º meta-—Ç–µ–≥–∏ –¥–ª—è PWA
    updateThemeMetaTag(theme);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
    if (typeof Chart !== 'undefined' && lineChartInstance) {
        updateChartsTheme(theme);
    }
    
    console.log(`‚úÖ –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: ${theme}`);
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï META-–¢–ï–ì–ê ===
function updateThemeMetaTag(theme) {
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme) {
        metaTheme.content = theme === 'light' ? '#ffffff' : '#0a0e1a';
    }
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–û–í, –ó–ê–í–ò–°–Ø–©–ò–• –û–¢ –¢–ï–ú–´ ===
function updateThemeDependentElements() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    
    if (state.user.theme === 'light') {
        sunIcon?.classList.add('active');
        moonIcon?.classList.remove('active');
    } else {
        moonIcon?.classList.add('active');
        sunIcon?.classList.remove('active');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    if (lineChartInstance || pieChartInstance) {
        updateChartsTheme(state.user.theme);
    }
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ï–ú –ì–†–ê–§–ò–ö–û–í ===
function updateChartsTheme(theme) {
    const chartColors = theme === 'light' ? {
        text: '#1f2937',
        grid: 'rgba(0, 0, 0, 0.1)',
        primary: '#dc2626'
    } : {
        text: '#f9fafb',
        grid: 'rgba(255, 255, 255, 0.1)',
        primary: '#10b981'
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chart.js
    if (typeof Chart !== 'undefined') {
        Chart.defaults.color = chartColors.text;
        Chart.defaults.borderColor = chartColors.grid;
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        if (lineChartInstance) lineChartInstance.update();
        if (pieChartInstance) pieChartInstance.update();
    }
}

function applyTheme() {
    if (state.user.theme === 'light') {
        document.body.classList.add('light');
    } else {
        document.body.classList.remove('light');
    }
}

function toggleSetting(setting) {
    const checkbox = document.getElementById(setting);
    if (!checkbox) return;
    
    const isChecked = checkbox.checked;
    
    switch(setting) {
        case 'limit-notifications':
        case 'budget-notifications':
            state.settings.notifications.budget = isChecked;
            break;
        case 'debt-notifications':
            state.settings.notifications.debt = isChecked;
            break;
        case 'weekly-report':
            state.settings.notifications.weekly = isChecked;
            break;
    }
    
    saveData();
}

// Mustafoshoh Programer // Modal Functions
function openAddModal(type) {
    type = type || 'expense';
    const modal = document.getElementById('add-modal');
    if (!modal) return;
    
    modal.classList.add('active');
    
    document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const tab = document.querySelector(`.modal-tab[data-tab="${type}"]`);
    const content = document.getElementById(`${type}-tab`);
    if (tab) tab.classList.add('active');
    if (content) content.classList.add('active');
    
    const titles = {
        expense: '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        income: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥',
        transfer: '–ü–µ—Ä–µ–≤–æ–¥',
        loan: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥'
    };
    const titleEl = document.getElementById('modal-title');
    if (titleEl) titleEl.textContent = titles[type] || '–î–æ–±–∞–≤–∏—Ç—å';
    
    clearModalForm();
    
    if (type === 'loan') {
        const loanDateEl = document.getElementById('loan-date');
        if (loanDateEl) {
            loanDateEl.value = new Date().toISOString().split('T')[0];
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        clearModalForm();
    }
}

function clearModalForm() {
    document.querySelectorAll('.modal input').forEach(input => {
        if (input.type === 'checkbox') return;
        input.value = '';
    });
    
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const previewEl = document.getElementById('expense-receipt-preview');
    if (previewEl) previewEl.innerHTML = '';
    
    state.selectedCategory = null;
}

function switchTab(tabName) {
    document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const tab = document.querySelector(`.modal-tab[data-tab="${tabName}"]`);
    const content = document.getElementById(`${tabName}-tab`);
    
    if (tab) tab.classList.add('active');
    if (content) content.classList.add('active');
    
    const titles = {
        expense: '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥',
        income: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥',
        transfer: '–ü–µ—Ä–µ–≤–æ–¥',
        loan: '–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥'
    };
    const titleEl = document.getElementById('modal-title');
    if (titleEl) titleEl.textContent = titles[tabName] || '–î–æ–±–∞–≤–∏—Ç—å';
}

function selectCategory(category, type) {
    state.selectedCategory = category;
    
    document.querySelectorAll(`#${type}-categories .category-item`).forEach(item => {
        item.classList.remove('active');
    });
    
    if (window.event && window.event.target) {
        const categoryItem = window.event.target.closest('.category-item');
        if (categoryItem) categoryItem.classList.add('active');
    }
}

function saveTransaction(type) {
    const generateUniqueId = () => {
        let id = Date.now();
        while (state.transactions.some(t => t.id === id)) {
            id++;
        }
        return id;
    };
    
    let transaction = {
        id: generateUniqueId(),
        type: type,
        timestamp: Date.now(),
        currency: state.user.currency
    };
    
    switch(type) {
        case 'expense':
            const expenseAmount = parseFloat(document.getElementById('expense-amount')?.value);
            if (!expenseAmount || expenseAmount <= 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
                return;
            }
            
            transaction.amount = expenseAmount;
            transaction.category = state.selectedCategory || 'other';
            transaction.description = document.getElementById('expense-desc')?.value || '';
            
            // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–∞
            const receiptFile = document.getElementById('expense-receipt')?.files[0];
            if (receiptFile) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        transaction.receipt = e.target.result;
                        completeTransactionSave(transaction);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(receiptFile);
                });
            }
            
            completeTransactionSave(transaction);
            break;
            
        case 'income':
            const incomeAmount = parseFloat(document.getElementById('income-amount')?.value);
            if (!incomeAmount || incomeAmount <= 0) {
                showToast(translations[state.user.language].fillFields, 'error');
                return;
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
            if (!state.selectedCategory) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ—Ö–æ–¥–∞', 'error');
                return;
            }
            
            transaction.amount = incomeAmount;
            transaction.category = state.selectedCategory;
            transaction.description = document.getElementById('income-desc')?.value || '';
            break;
            
        case 'transfer':
            const transferAmount = parseFloat(document.getElementById('transfer-amount')?.value);
            const fromCategory = document.getElementById('transfer-from')?.value;
            const toCategory = document.getElementById('transfer-to')?.value;
            
            if (!transferAmount || transferAmount <= 0 || !fromCategory || !toCategory) {
                showToast(translations[state.user.language].fillFields, 'error');
                return;
            }
            
            transaction.amount = transferAmount;
            transaction.fromCategory = fromCategory;
            transaction.toCategory = toCategory;
            transaction.description = document.getElementById('transfer-desc')?.value || '';
            break;
            
        case 'loan':
            const loanAmount = parseFloat(document.getElementById('loan-amount')?.value);
            const loanName = document.getElementById('loan-name')?.value;
            const loanDate = document.getElementById('loan-date')?.value;
            const loanPercent = parseFloat(document.getElementById('loan-percent')?.value) || 0;
            
            if (!loanAmount || loanAmount <= 0 || !loanName || !loanDate) {
                showToast(translations[state.user.language].fillFields, 'error');
                return;
            }
            
            const loan = {
                id: Date.now(),
                name: loanName,
                amount: loanAmount,
                date: loanDate,
                percent: loanPercent,
                currency: state.user.currency,
                isPaid: false
            };
            
            state.loans.push(loan);
            saveData();
            closeModal('add-modal');
            updateUI();
            renderAllScreens();
            showToast(translations[state.user.language].loanAdded, 'success');
            return;
    }
    
    // üî• –§–£–ù–ö–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è expense —Å —á–µ–∫–æ–º)
    function completeTransactionSave(tx) {
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', tx);
        state.transactions.unshift(tx);
        saveData();
        closeModal('add-modal');
        updateUI();
        renderAllScreens();
        showToast('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    }
}

function showTransactionDetail(id) {
    const transaction = state.transactions.find(t => t.id === id);
    if (!transaction) return;
    
    state.editingTransaction = transaction;
    
    const modal = document.getElementById('detail-modal');
    const container = document.getElementById('transaction-detail');
    
    const category = state.categories[transaction.category] || state.categories.other;
    const txRate = rates[transaction.currency] || 1;
    const rate = rates[state.user.currency] || 1;
    const amount = (transaction.amount * txRate) / rate;
    
    // üî• –û–ë–ù–û–í–õ–ï–ù–ù–´–ô HTML –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ß–ï–ö–ê
    container.innerHTML = `
        <div class="transaction-detail-icon" style="background: ${category.color}20;">
            ${category.icon}
        </div>
        <h3>${transaction.description || category[state.user.language]}</h3>
        <div class="transaction-detail-amount ${transaction.type}">
            ${transaction.type === 'expense' ? '-' : '+'}${formatCurrency(amount)}
        </div>
        <div class="transaction-detail-info">
            <div class="detail-row">
                <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                <span>${category.icon} ${category[state.user.language]}</span>
            </div>
            <div class="detail-row">
                <span>–î–∞—Ç–∞:</span>
                <span>${formatDate(transaction.timestamp)}</span>
            </div>
            <div class="detail-row">
                <span>–í—Ä–µ–º—è:</span>
                <span>${formatTime(transaction.timestamp)}</span>
            </div>
            <div class="detail-row">
                <span>–¢–∏–ø:</span>
                <span>${transaction.type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–ü–µ—Ä–µ–≤–æ–¥'}</span>
            </div>
        </div>
        ${transaction.receipt ? `
            <div class="receipt-section">
                <h4>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —á–µ–∫:</h4>
                <img src="${transaction.receipt}" class="transaction-detail-receipt" 
                     onclick="openReceiptFullscreen('${transaction.receipt}')">
            </div>
        ` : ''}
    `;
    
    modal.classList.add('active');
}

// üî• –î–û–ë–ê–í–¨–¢–ï –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–û–ì–û –ü–†–û–°–ú–û–¢–†–ê –ß–ï–ö–ê
function openReceiptFullscreen(receiptUrl) {
    const fullscreenModal = document.createElement('div');
    fullscreenModal.className = 'modal active';
    fullscreenModal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div class="modal-header">
                <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä —á–µ–∫–∞</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
            </div>
            <div style="padding: 20px; text-align: center;">
                <img src="${receiptUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
            </div>
        </div>
    `;
    document.body.appendChild(fullscreenModal);
}

function deleteTransaction() {
    if (!state.editingTransaction) return;
    
    if (confirm(translations[state.user.language].confirmDelete)) {
        state.transactions = state.transactions.filter(t => t.id !== state.editingTransaction.id);
        saveData();
        
        closeModal('detail-modal');
        updateUI();
        renderAllScreens();
        
        showToast(translations[state.user.language].success, 'success');
    }
}

// Mustafoshoh Programer // Voice Recognition
// ==========================================
// üé§ –ì–û–õ–û–°–û–í–û–ô –ú–ï–ù–ï–î–ñ–ï–† - –ù–û–í–´–ô –ö–û–î
// ==========================================

// Mustafoshoh Programer // Voice Recognition
// ==========================================
// üé§ –ì–û–õ–û–°–û–í–û–ô –ú–ï–ù–ï–î–ñ–ï–† - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î
// ==========================================

class VoiceManager {
    constructor() {
        this.recognition = null;
        this.isListening = false;
        this.currentLanguage = 'ru-RU';
        this.transcript = '';
        this.init();
    }
    
    init() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            console.warn('üé§ Speech Recognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            return false;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = true;
        this.recognition.maxAlternatives = 1;
        
        this.recognition.onstart = () => {
            this.isListening = true;
            console.log('üé§ –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏...');
            
            const statusEl = document.getElementById('voice-status');
            if (statusEl) {
                statusEl.textContent = 'üé§ –°–ª—É—à–∞—é...';
                statusEl.style.color = '#10b981';
            }
        };
        
        this.recognition.onresult = (event) => {
            const result = event.results[event.results.length - 1];
            this.transcript = result[0].transcript;
            console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', this.transcript);
            
            const voiceTextEl = document.getElementById('voice-text');
            if (voiceTextEl) {
                voiceTextEl.textContent = this.transcript;
                voiceTextEl.style.color = '#a0a0c0';
            }
            
            if (result.isFinal) {
                console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–æ–º–∞–Ω–¥—É');
                const statusEl = document.getElementById('voice-status');
                if (statusEl) {
                    statusEl.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                    statusEl.style.color = '#f59e0b';
                }
                this.processCommand(this.transcript);
            }
        };
        
        this.recognition.onerror = (event) => {
            console.error('üé§ –û—à–∏–±–∫–∞:', event.error);
            this.isListening = false;
            
            const statusEl = document.getElementById('voice-status');
            const btnEl = document.getElementById('voice-btn');
            
            if (statusEl) {
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + event.error;
                statusEl.style.color = '#ef4444';
            }
            
            if (btnEl) {
                btnEl.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
                btnEl.onclick = () => this.start();
            }
        };
        
        this.recognition.onend = () => {
            this.isListening = false;
            console.log('üé§ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        };
        
        return true;
    }
    
    start(language = null) {
        if (!this.recognition) {
            showToast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
            return;
        }
        
        if (language) {
            const codes = { 'ru': 'ru-RU', 'en': 'en-US', 'tj': 'tg-TJ' };
            this.currentLanguage = codes[language] || 'ru-RU';
        } else {
            const codes = { 'ru': 'ru-RU', 'en': 'en-US', 'tj': 'tg-TJ' };
            this.currentLanguage = codes[state.user.language] || 'ru-RU';
        }
        
        this.recognition.lang = this.currentLanguage;
        
        try {
            this.recognition.start();
            this.showVoiceModal();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ', 'error');
        }
    }
    
    stop() {
        if (this.recognition && this.isListening) {
            console.log('üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ');
            this.recognition.stop();
            this.isListening = false;
        }
        
        const statusEl = document.getElementById('voice-status');
        const btnEl = document.getElementById('voice-btn');
        
        if (statusEl) {
            statusEl.textContent = '–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
            statusEl.style.color = '#6b7280';
        }
        if (btnEl) {
            btnEl.textContent = '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            btnEl.onclick = () => this.start();
        }
    }
    
    showVoiceModal() {
        openModal('voice-modal');
        
        const statusEl = document.getElementById('voice-status');
        const textEl = document.getElementById('voice-text');
        const btnEl = document.getElementById('voice-btn');
        
        if (statusEl) {
            statusEl.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
            statusEl.style.color = '#667eea';
        }
        if (textEl) {
            textEl.textContent = '';
        }
        if (btnEl) {
            btnEl.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            btnEl.onclick = () => {
                console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –ø–æ –∫–Ω–æ–ø–∫–µ');
                this.stop();
                closeModal('voice-modal');
            };
        }
    }

    // üî• –ù–û–í–´–ô –ú–ï–¢–û–î –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥
    handleBasicCommands(text) {
        const lowerText = text.toLowerCase().trim();
        
        // 1Ô∏è‚É£ –ü–û–ú–û–©–¨
        if (lowerText.includes('–ø–æ–º–æ—â—å') || lowerText.includes('help') || lowerText.includes('–∫”Ø–º–∞–∫')) {
            return this.showHelp();
        }
        
        // 2Ô∏è‚É£ –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        if (lowerText.includes('—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª') || lowerText.includes('—Å–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª')) {
            if (lowerText.includes('–Ω–µ–¥–µ–ª') || lowerText.includes('week') || lowerText.includes('“≥–∞—Ñ—Ç–∞')) {
                return this.getSpendingStats(text, 'week');
            }
            if (lowerText.includes('–º–µ—Å—è—Ü') || lowerText.includes('month') || lowerText.includes('–º–æ“≥')) {
                return this.getSpendingStats(text, 'month');
            }
            if (lowerText.includes('—Å–µ–≥–æ–¥') || lowerText.includes('today') || lowerText.includes('–∏–º—Ä”Ø–∑')) {
                return this.getSpendingStats(text, 'today');
            }
            return this.getSpendingStats(text, 'month');
        }
        
        // 3Ô∏è‚É£ –ë–ê–õ–ê–ù–°
        if (lowerText.includes('–±–∞–ª–∞–Ω—Å') || lowerText.includes('balance') || lowerText.includes('–¥–µ–Ω—å–≥–∏') || lowerText.includes('–æ—Å—Ç–∞—Ç–æ–∫')) {
            return this.getBalance();
        }
        
        // 4Ô∏è‚É£ –†–ê–°–•–û–î–´
        if (lowerText.includes('–∫—É–ø–∏–ª') || lowerText.includes('–ø–æ—Ç—Ä–∞—Ç–∏–ª') || lowerText.includes('–∑–∞–ø–ª–∞—Ç–∏–ª') || 
            lowerText.includes('—Ä–∞—Å—Ö–æ–¥') || lowerText.includes('–ø–æ–∫—É–ø–∫–∞') || lowerText.includes('cost') || 
            lowerText.includes('spent') || lowerText.includes('—Ö–∞—Ä“∑')) {
            return this.addTransactionFromVoice(text, 'expense');
        }
        
        // 5Ô∏è‚É£ –î–û–•–û–î–´
        if (lowerText.includes('–ø–æ–ª—É—á–∏–ª') || lowerText.includes('–∑–∞—Ä–∞–±–æ—Ç–∞–ª') || lowerText.includes('–¥–æ—Ö–æ–¥') || 
            lowerText.includes('income') || lowerText.includes('earned') || lowerText.includes('–¥–∞—Ä–æ–º–∞–¥')) {
            return this.addTransactionFromVoice(text, 'income');
        }
        
        // 6Ô∏è‚É£ –ï—Å–ª–∏ –µ—Å—Ç—å —á–∏—Å–ª–∞ - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
        if (/(\d+)/.test(lowerText)) {
            return this.addTransactionFromVoice(text, 'expense');
        }
        
        return false; // –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
    }

    // üî• –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î processCommand
    async processCommand(text) {
        console.log('üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã:', text);
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
        if (this.handleBasicCommands(text)) {
            return true;
        }
        
        // –°–ª–æ–∂–Ω—ã–µ/–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã -> –∫ –ò–ò
        console.log('üß† –ü–µ—Ä–µ–¥–∞—é –∫–æ–º–∞–Ω–¥—É –ò–ò:', text);
        return await this.processWithAI(text);
    }

    // üî• –ù–û–í–´–ô –ú–ï–¢–û–î –¥–ª—è –ò–ò –æ–±—Ä–∞–±–æ—Ç–∫–∏
    async processWithAI(text) {
        try {
            const statusEl = document.getElementById('voice-status');
            if (statusEl) {
                statusEl.textContent = 'üß† –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...';
                statusEl.style.color = '#8b5cf6';
            }
            
            // –í—ã–∑—ã–≤–∞–µ–º AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            const aiResponse = await financialAI.processFinancialQuery(text, 'voice');
            
            // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            if (aiResponse.shouldSpeak) {
                this.speak(aiResponse.text);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            if (aiResponse.showInUI) {
                showToast(aiResponse.text, 'info');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (statusEl) {
                statusEl.textContent = '‚úÖ –ò–ò –æ—Ç–≤–µ—Ç–∏–ª';
                statusEl.style.color = '#10b981';
            }
            
            return true;
            
        } catch (error) {
            console.error('AI Processing Error:', error);
            
            const statusEl = document.getElementById('voice-status');
            if (statusEl) {
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ò–ò';
                statusEl.style.color = '#ef4444';
            }
            
            this.speak('–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å');
            return false;
        }
    }

    // üé§ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    showHelp() {
        const helpText = `–Ø —É–º–µ—é:
- –î–æ–±–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥—ã: "–∫—É–ø–∏–ª —Ö–ª–µ–± –∑–∞ 50 —Ä—É–±–ª–µ–π"
- –î–æ–±–∞–≤–ª—è—Ç—å –¥–æ—Ö–æ–¥—ã: "–∑–∞—Ä–ø–ª–∞—Ç–∞ 1000 –¥–æ–ª–ª–∞—Ä–æ–≤" 
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: "—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª"
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å: "–±–∞–ª–∞–Ω—Å"`;

        closeModal('voice-modal');
        showToast(helpText, 'info');
        this.speak('–Ø –ø–æ–∫–∞–∑–∞–ª —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥');
        return true;
    }

    getSpendingStats(text, period) {
        const rate = rates[state.user.currency] || 1;
        let targetCategory = null;
        
        for (const [cat, data] of Object.entries(state.categories)) {
            const catName = data[state.user.language].toLowerCase();
            if (text.includes(catName)) {
                targetCategory = cat;
                break;
            }
        }
        
        let transactions = getFilteredTransactions('expense', period);
        if (targetCategory) {
            transactions = transactions.filter(t => t.category === targetCategory);
        }
        
        const total = transactions.reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
        
        const symbol = currencySymbols[state.user.currency];
        const periodText = { today: '—Å–µ–≥–æ–¥–Ω—è', week: '–∑–∞ –Ω–µ–¥–µ–ª—é', month: '–∑–∞ –º–µ—Å—è—Ü' };
        
        let response;
        if (targetCategory) {
            const catName = state.categories[targetCategory][state.user.language];
            response = `–¢—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª ${symbol}${total.toFixed(2)} –Ω–∞ ${catName} ${periodText[period]}`;
        } else {
            response = `–¢–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã ${periodText[period]}: ${symbol}${total.toFixed(2)}`;
        }
        
        closeModal('voice-modal');
        this.speak(response);
        showToast('üìä ' + response, 'info');
        return true;
    }

    getBalance() {
        const rate = rates[state.user.currency] || 1;
        const budget = state.user.monthlyIncome * rate;
        
        const expenses = getFilteredTransactions('expense', 'month');
        const totalExpense = expenses.reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
        
        const income = getFilteredTransactions('income', 'month');
        const totalIncome = income.reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
        
        const balance = budget + totalIncome - totalExpense;
        const symbol = currencySymbols[state.user.currency];
        const response = `–¢–≤–æ–π –±–∞–ª–∞–Ω—Å: ${symbol}${balance.toFixed(2)}. –î–æ—Ö–æ–¥: ${symbol}${totalIncome.toFixed(2)}, –†–∞—Å—Ö–æ–¥: ${symbol}${totalExpense.toFixed(2)}`;
        
        closeModal('voice-modal');
        this.speak(response);
        showToast('üí∞ ' + response, 'info');
        return true;
    }

    addTransactionFromVoice(text, type) {
        console.log(`üéØ –î–æ–±–∞–≤–ª—è—é ${type} –∏–∑ –≥–æ–ª–æ—Å–∞:`, text);
        
        let amount = this.extractAmount(text);
        console.log('üí∞ –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è —Å—É–º–º–∞:', amount);
        
        if (!amount || amount <= 0) {
            console.log('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—É–º–º—É');
            this.speak('–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —Å—É–º–º—É –≤ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ');
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É', 'error');
            return true;
        }
        
        const category = this.detectCategory(text);
        console.log('üè∑Ô∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', category);
        
        // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        const transaction = {
            id: Date.now(),
            type: type,
            amount: amount,
            category: category,
            description: text,
            timestamp: Date.now(),
            currency: state.user.currency
        };
        
        state.transactions.unshift(transaction);
        saveData();
        
        const categoryInfo = state.categories[category] || state.categories.other;
        const categoryName = categoryInfo[state.user.language];
        const symbol = currencySymbols[state.user.currency];
        const response = `–î–æ–±–∞–≤–ª–µ–Ω ${type === 'expense' ? '—Ä–∞—Å—Ö–æ–¥' : '–¥–æ—Ö–æ–¥'} ${symbol}${amount.toFixed(2)} –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${categoryName}`;
        
        closeModal('voice-modal');
        this.speak(response);
        showToast('‚úÖ ' + response, 'success');
        
        updateUI();
        renderAllScreens();
        
        return true;
    }

    detectCategory(text) {
        console.log('üîç –û–ø—Ä–µ–¥–µ–ª—è—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è:', text);
        
        const categoryPatterns = {
            food: {
                keywords: ['—Ö–ª–µ–±', '–º–æ–ª–æ–∫–æ', '—Å—ã—Ä', '–º—è—Å–æ', '—Ä—ã–±–∞', '–æ–≤–æ—â', '—Ñ—Ä—É–∫—Ç', '–±–∞–Ω–∞–Ω', '—è–±–ª–æ–∫–æ', '–≤–æ–¥–∞', '—Å–æ–∫', '—á–∞–π', '–∫–æ—Ñ–µ', 
                          '–ø—Ä–æ–¥—É–∫—Ç', '–µ–¥–∞', '–º–∞–≥–∞–∑–∏–Ω', '—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–∞—à–∞–Ω', '–º–∞–≥–Ω–∏—Ç', '–ø—è—Ç—ë—Ä–æ—á–∫–∞', '–ª–µ–Ω—Ç–∞', '–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫',
                          '–Ω–æ–Ω', '—à–∏—Ä', '–≥”Ø—à—Ç', '–º–æ“≥”£', '—Å–∞–±–∑–∞–≤–æ—Ç', '–º–µ–≤–∞', '–æ–±', '—á–æ–π', '—Ö”Ø—Ä–æ–∫', '–º–∞“≥—Å—É–ª–æ—Ç'],
                weight: 0
            },
            transport: {
                keywords: ['—Ç–∞–∫—Å–∏', '–∞–≤—Ç–æ–±—É—Å', '–º–µ—Ç—Ä–æ', '—Ç—Ä–∞–º–≤–∞–π', '–º–∞—Ä—à—Ä—É—Ç–∫–∞', '–ø—Ä–æ–µ–∑–¥', '–±–µ–Ω–∑–∏–Ω', '–∑–∞–ø—Ä–∞–≤–∫–∞', '–∞–∑—Å', '—Ç–æ–ø–ª–∏–≤–æ',
                          '–Ω–∞–∫–ª–∏—ë—Ç', '—Ç–∞–∫—Å–∏', '–±–µ–Ω–∑–∏–Ω', '—Å”Ø—Ö—Ç', '—è–Ω–¥–µ–∫—Å', 'uber', 'bolt', 'gett'],
                weight: 0
            },
            restaurant: {
                keywords: ['–∫–∞—Ñ–µ', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', '–±–∞—Ä', '–ø–∞–±', '—Å—Ç–æ–ª–æ–≤–∞—è', '–±—É—Ñ–µ—Ç', '—Ñ—É–¥–∫–æ—Ä—Ç', '–æ–±–µ–¥', '—É–∂–∏–Ω', '–∑–∞–≤—Ç—Ä–∞–∫', '–ø–æ–µ–ª',
                          '–º–∞–∫–¥–æ–Ω–∞–ª–¥—Å', '–∫—Ñ—Å', '–±—É—Ä–≥–µ—Ä', '–ø–∏—Ü—Ü–∞', '—Å—É—à–∏', '—Ä–æ–ª–ª—ã', '–Ω–∞“≥–æ—Ä', '—Ö”Ø—Ä–æ–∫'],
                weight: 0
            },
            health: {
                keywords: ['–∞–ø—Ç–µ–∫–∞', '–ª–µ–∫–∞—Ä—Å—Ç–≤–æ', '—Ç–∞–±–ª–µ—Ç–∫–∏', '–≤–∏—Ç–∞–º–∏–Ω—ã', '–≤—Ä–∞—á', '–¥–æ–∫—Ç–æ—Ä', '–±–æ–ª—å–Ω–∏—Ü–∞', '–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞', '–∞–Ω–∞–ª–∏–∑—ã',
                          '–¥–æ—Ä—É—Ö–æ–Ω–∞', '—Ç–∞–±–∏–±', '–±–µ–º–æ—Ä', '—Å–∞–ª–æ–º–∞—Ç”£'],
                weight: 0
            },
            clothes: {
                keywords: ['–æ–¥–µ–∂–¥–∞', '–∫—É—Ä—Ç–∫–∞', '—à—Ç–∞–Ω—ã', '–¥–∂–∏–Ω—Å—ã', '—Ñ—É—Ç–±–æ–ª–∫–∞', '—Ä—É–±–∞—à–∫–∞', '–ø–ª–∞—Ç—å–µ', '—é–±–∫–∞', '–æ–±—É–≤—å', '–∫—Ä–æ—Å—Å–æ–≤–∫–∏',
                          '–ª–∏–±–æ—Å', '–ø”Ø—à–æ–∫', '–∫—É—Ä—Ç–∞', '–ø–æ—è—Ñ–∑–æ–ª'],
                weight: 0
            },
            entertainment: {
                keywords: ['–∫–∏–Ω–æ', '—Ñ–∏–ª—å–º', '–±–∏–ª–µ—Ç', '–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä', '–∏–≥—Ä–∞', '–∏–≥—Ä—ã', '–∫–æ–Ω—Ü–µ—Ä—Ç', '—Ç–µ–∞—Ç—Ä', '–º—É–∑–µ–π', '–≤—ã—Å—Ç–∞–≤–∫–∞', '–ø–∞—Ä–∫',
                          '—Å–∏–Ω–∞–º–æ', '–±–æ–∑”£', '–∫–æ–Ω—Ü–µ—Ä—Ç', '—Ç–µ–∞—Ç—Ä'],
                weight: 0
            },
            bills: {
                keywords: ['–∫–æ–º–º—É–Ω–∞–ª–∫–∞', '–∂–∫—Ö', '–∫–≤–∞—Ä—Ç–ø–ª–∞—Ç–∞', '—Å–≤–µ—Ç', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–≤–æ–¥–∞', '–≥–∞–∑', '–æ—Ç–æ–ø–ª–µ–Ω–∏–µ', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
                          '—Ç–µ–ª–µ—Ñ–æ–Ω', '—Å–≤—è–∑—å', '–º–æ–±–∏–ª—å–Ω–∞—è', '–±–∞—Ä–∫', '–æ–±'],
                weight: 0
            },
            salary: {
                keywords: ['–∑–∞—Ä–ø–ª–∞—Ç–∞', '–æ–∫–ª–∞–¥', '–∞–≤–∞–Ω—Å', '–ø—Ä–µ–º–∏—è', '–±–æ–Ω—É—Å', '–º—É–∑–¥', '–º–∞–æ—à'],
                weight: 0
            },
            freelance: {
                keywords: ['—Ñ—Ä–∏–ª–∞–Ω—Å', '–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞', '–ø—Ä–æ–µ–∫—Ç', '–∑–∞–∫–∞–∑', '—Ä–∞–±–æ—Ç–∞', '–∫–æ—Ä–∏ –∏–ª–æ–≤–∞–≥”£'],
                weight: 0
            },
            gift: {
                keywords: ['–ø–æ–¥–∞—Ä–æ–∫', '–ø–æ–¥–∞—Ä–∏–ª', '–ø–æ–¥–∞—Ä–∏–ª–∏', '–ø–æ–ª—É—á–∏–ª –ø–æ–¥–∞—Ä–æ–∫', '–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è', '—Ç—É“≥—Ñ–∞', '“≥–∞–¥—è'],
                weight: 0
            }
        };

        const lowerText = text.toLowerCase();
        
        // –°—á–∏—Ç–∞–µ–º –≤–µ—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        for (const [category, data] of Object.entries(categoryPatterns)) {
            data.weight = 0;
            for (const keyword of data.keywords) {
                if (lowerText.includes(keyword)) {
                    data.weight += keyword.length;
                }
            }
        }

        // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤–µ—Å–æ–º
        let bestCategory = 'other';
        let maxWeight = 0;

        for (const [category, data] of Object.entries(categoryPatterns)) {
            if (data.weight > maxWeight) {
                maxWeight = data.weight;
                bestCategory = category;
            }
        }

        console.log(`üéØ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${bestCategory} (–≤–µ—Å: ${maxWeight})`);
        return bestCategory;
    }

    extractAmount(text) {
        console.log('üîç –ò—â—É —Å—É–º–º—É –≤ —Ç–µ–∫—Å—Ç–µ:', text);
        
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—É–º–º
        const amountRegex = /(\d+[,.]?\d*)\s*(?:–¥–æ–ª–ª–∞—Ä|–¥–æ–ª–ª–∞—Ä–æ–≤|–¥–æ–ª–ª–∞—Ä–∞|—Å–æ–º–æ–Ω|—Å–æ–º–æ–Ω–æ–≤|—Å–æ–º–∞|—Å–æ–º|—Ä—É–±–ª|—Ä—É–±–ª–µ–π|—Ä—É–±–ª—è|‚ÇΩ|\$|sm|som|usd|—Ä|—Å|—Ç–≥|—Ç–µ–Ω–≥–µ)/i;
        const match = text.match(amountRegex);
        
        if (match) {
            let amount = parseFloat(match[1].replace(',', '.'));
            console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Å—É–º–º–∞:', amount);
            return amount;
        }
        
        // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ —á–∏—Å–µ–ª
        const simpleMatch = text.match(/(\d+[,.]?\d*)/);
        if (simpleMatch) {
            let amount = parseFloat(simpleMatch[1].replace(',', '.'));
            console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞:', amount);
            return amount;
        }
        
        console.log('‚ùå –°—É–º–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return null;
    }

    speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = this.currentLanguage;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        }
        return true;
    }
}

// ==========================================
// üß† AI CHAT INTERFACE
// ==========================================

// ü§ñ –û—Ç–∫—Ä—ã—Ç—å AI —á–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function openAIChatModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>üß† VoiseTiFi AI</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
            </div>
            <div class="modal-body" style="flex: 1; padding: 0; display: flex; flex-direction: column;">
                <div id="ai-chat-container" style="flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-primary);">
                    <div class="ai-welcome-message">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üß†</div>
                            <h3 style="margin-bottom: 8px;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫</h3>
                            <p style="color: var(--text-secondary); font-size: 14px;">–°–ø—Ä–æ—Å–∏—Ç–µ –æ –±—é–¥–∂–µ—Ç–µ, –∞–Ω–∞–ª–∏–∑–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–≤–µ—Ç—ã</p>
                        </div>
                    </div>
                    <div id="ai-chat-messages"></div>
                </div>
                <div style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" id="ai-chat-input" 
                               placeholder="üí¨ –°–ø—Ä–æ—Å–∏—Ç–µ –æ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö..." 
                               style="flex: 1; padding: 12px 16px; background: var(--bg-glass); border: 1px solid var(--border-color); border-radius: var(--border-radius); color: var(--text-primary); font-size: 14px;"
                               onkeypress="if(event.key === 'Enter') sendAIMessage()">
                        <button onclick="sendAIMessage()" style="padding: 12px 20px; background: var(--gradient-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600;">
                            üì®
                        </button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="insertAIPrompt('–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?')" class="ai-quick-btn">üìä –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ç</button>
                        <button onclick="insertAIPrompt('–î–∞–π—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç')" class="ai-quick-btn">üí° –°–æ–≤–µ—Ç—ã</button>
                        <button onclick="insertAIPrompt('–ü–æ–º–æ–≥–∏ —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞')" class="ai-quick-btn">üéØ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                        <button onclick="insertAIPrompt('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã')" class="ai-quick-btn">üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('ai-chat-input').focus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ AI
    setTimeout(() => {
        addAIMessage("–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞, –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏ –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?", 'assistant');
    }, 500);
}

// üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ AI
// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø sendAIMessage
async function sendAIMessage() {
    const input = document.getElementById('ai-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.value = '';
    addAIMessage(message, 'user');
    
    try {
        addAIMessage('üß† –î—É–º–∞—é...', 'assistant', true);
        
        const response = await financialAI.processFinancialQuery(message, 'chat');
        
        removeLoadingMessage();
        addAIMessage(response.text, 'assistant', false, response.isFallback);
        
    } catch (error) {
        removeLoadingMessage();
        addAIMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π AI...', 'assistant', false, true);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        setTimeout(() => {
            const fallbackResponse = financialAI.getFallbackAIResponse(message);
            addAIMessage(fallbackResponse, 'assistant', false, true);
        }, 1000);
    }
}
// ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø addAIMessage
function addAIMessage(text, sender, isTemp = false, isFallback = false) {
    const container = document.getElementById('ai-chat-messages');
    const messageDiv = document.createElement('div');
    
    let fallbackIndicator = '';
    if (sender === 'assistant' && isFallback) {
        fallbackIndicator = '<div class="ai-fallback-indicator">üîß –õ–æ–∫–∞–ª—å–Ω—ã–π AI</div>';
    }
    
    messageDiv.className = `ai-message ${sender} ${isTemp ? 'temp-message' : ''}`;
    messageDiv.innerHTML = `
        ${fallbackIndicator}
        <div class="ai-message-content">
            <div class="ai-message-text">${text}</div>
            <div class="ai-message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    messageDiv.id = isTemp ? 'ai-loading-message' : '';
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
function removeLoadingMessage() {
    const loadingMsg = document.getElementById('ai-loading-message');
    if (loadingMsg) {
        loadingMsg.remove();
    }
}

// üî• –í—Å—Ç–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–º–ø—Ç
function insertAIPrompt(prompt) {
    const input = document.getElementById('ai-chat-input');
    input.value = prompt;
    input.focus();
}

// üéØ AI Quick Action –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
function openAIQuickAction() {
    openAIChatModal();
}

// ==========================================
// üîî AI SMART NOTIFICATIONS
// ==========================================

// üéØ –£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç AI
function checkSmartAINotifications() {
    const notifications = [];
    const financialContext = financialAI.getUserFinancialContext();
    
    // 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞
    if (financialContext.budgetUtilization > 90) {
        notifications.push({
            type: 'warning',
            icon: 'üö®',
            title: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞',
            message: `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${financialContext.budgetUtilization}% –±—é–¥–∂–µ—Ç–∞!`,
            action: 'show_analysis'
        });
    }
    
    // 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—ã—á–Ω—ã—Ö —Ç—Ä–∞—Ç–∞—Ö
    if (financialContext.monthSpending > financialContext.monthlyIncome * 0.8) {
        notifications.push({
            type: 'info', 
            icon: 'üí°',
            title: '–í—ã—Å–æ–∫–∏–µ —Ç—Ä–∞—Ç—ã',
            message: `–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ ${financialContext.monthSpending.toFixed(2)}${financialContext.currencySymbol}`,
            action: 'show_advice'
        });
    }
    
    // 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π
    financialContext.activeGoals.forEach(goal => {
        const progress = (goal.saved / goal.target) * 100;
        if (progress >= 75 && progress < 100) {
            notifications.push({
                type: 'success',
                icon: 'üéØ',
                title: '–¶–µ–ª—å –ø–æ—á—Ç–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞',
                message: `–¶–µ–ª—å "${goal.name}" –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${progress.toFixed(0)}%`,
                action: 'show_goals'
            });
        }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notifications.forEach(notification => {
        showSmartNotification(notification);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    updateNotificationBadge(notifications.length);
}

// üîî –ü–æ–∫–∞–∑–∞—Ç—å —É–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showSmartNotification(notification) {
    const toast = document.createElement('div');
    toast.className = `toast ${notification.type}`;
    toast.innerHTML = `
        <div class="alert-icon">${notification.icon}</div>
        <div class="alert-content">
            <div class="alert-title">${notification.title}</div>
            <div class="alert-text">${notification.message}</div>
        </div>
        <button class="close-btn" onclick="this.parentElement.remove()" style="margin-left: 10px;">‚úï</button>
    `;
    
    document.body.appendChild(toast);
    
    // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// üî¢ –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function updateNotificationBadge(count) {
    const badge = document.getElementById('notification-count');
    if (badge) {
        badge.textContent = count > 0 ? count : '0';
        badge.style.display = count > 0 ? 'flex' : 'none';
    }
}

// üéØ –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotifications() {
    // –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ –≤—Å–µ–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
    checkSmartAINotifications();
}
// –°–æ–∑–¥–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä

// ==========================================
// üß† GEMINI AI FINANCIAL ASSISTANT
// ==========================================
// ==========================================
// ‚öôÔ∏è AI SETTINGS FUNCTIONS
// ==========================================

// üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI
function toggleAISetting(setting) {
    const checkbox = document.getElementById(`ai-${setting}`);
    if (!checkbox) return;
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ AI
    showToast(`–ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI "${setting}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
}

// üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
// –¢–µ—Å—Ç API –∫–ª—é—á–∞
async function quickTest() {
    const API_KEY = "AIzaSyAq3j_TovBNyp2trg3Qvs7jS3azfFUZ_L4";
    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${API_KEY}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            contents: [{parts: [{text: "–û—Ç–≤–µ—Ç—å '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω'"}]}]
        })
    });
    
    console.log('Status:', response.status);
    console.log('Data:', await response.json());
}

quickTest();
class FinancialAIAssistant {
    constructor() {
        this.apiKey = "AIzaSyBk_A9ExB6I_r2PaeOm3qk8fylxE15NRC8"; // üîë –ù–û–í–´–ô –ö–õ–Æ–ß
       // –í–∞—Ä–∏–∞–Ω—Ç 3 (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
this.baseURL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent";
        this.conversationHistory = [];
        this.cache = new Map();
        this.maxHistory = 10;
    }

    // üîß –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    getUserFinancialContext() {
        const rate = rates[state.user.currency] || 1;
        
        // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const monthExpenses = state.transactions
            .filter(t => t.type === 'expense' && 
                        new Date(t.timestamp).getMonth() === currentMonth &&
                        new Date(t.timestamp).getFullYear() === currentYear)
            .reduce((sum, t) => {
                const txRate = rates[t.currency] || 1;
                return sum + ((t.amount * txRate) / rate);
            }, 0);

        const monthIncome = state.transactions
            .filter(t => t.type === 'income' && 
                        new Date(t.timestamp).getMonth() === currentMonth &&
                        new Date(t.timestamp).getFullYear() === currentYear)
            .reduce((sum, t) => {
                const txRate = rates[t.currency] || 1;
                return sum + ((t.amount * txRate) / rate);
            }, 0);

        // –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
        const categorySpending = {};
        state.transactions
            .filter(t => t.type === 'expense')
            .forEach(t => {
                const txRate = rates[t.currency] || 1;
                const amount = (t.amount * txRate) / rate;
                categorySpending[t.category] = (categorySpending[t.category] || 0) + amount;
            });

        const topCategories = Object.entries(categorySpending)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([cat, amount]) => ({
                category: cat,
                name: (state.categories[cat] || state.categories.other)[state.user.language],
                amount: amount,
                icon: (state.categories[cat] || state.categories.other).icon
            }));

        return {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            monthlyIncome: state.user.monthlyIncome,
            currency: state.user.currency,
            currencySymbol: currencySymbols[state.user.currency],
            currentBalance: this.calculateCurrentBalance(),
            
            // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            monthSpending: monthExpenses,
            monthIncome: monthIncome,
            monthBalance: monthIncome - monthExpenses,
            budgetUtilization: state.user.monthlyIncome > 0 ? 
                (monthExpenses / state.user.monthlyIncome * 100).toFixed(1) : 0,
            
            // –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            topSpendingCategories: topCategories,
            
            // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏ –∏ –¥–æ–ª–≥–∏
            activeGoals: state.savingsGoals.filter(g => !g.completed),
            activeLoans: state.loans.filter(l => !l.isPaid),
            recurringPayments: state.recurringPayments.filter(p => p.isActive),
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            language: state.user.language,
            dailyLimit: state.user.dailyLimit
        };
    }

    // üîß –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    calculateCurrentBalance() {
        const rate = rates[state.user.currency] || 1;
        const budget = state.user.monthlyIncome;
        
        const totalExpenses = state.transactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => {
                const txRate = rates[t.currency] || 1;
                return sum + ((t.amount * txRate) / rate);
            }, 0);

        const totalIncome = state.transactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => {
                const txRate = rates[t.currency] || 1;
                return sum + ((t.amount * txRate) / rate);
            }, 0);

        return budget + totalIncome - totalExpenses;
    }

    // üéØ –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    async processFinancialQuery(userMessage, messageType = 'voice') {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            const cacheKey = userMessage.toLowerCase().trim();
            if (this.cache.has(cacheKey)) {
                return this.cache.get(cacheKey);
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const financialContext = this.getUserFinancialContext();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            this.updateConversationHistory({
                role: 'user',
                content: userMessage,
                timestamp: Date.now()
            });

            // –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            const prompt = this.buildFinancialPrompt(userMessage, financialContext, messageType);
            
            // –í—ã–∑—ã–≤–∞–µ–º Gemini API
            const aiResponse = await this.callGeminiAPI(prompt);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            const processedResponse = this.processAIResponse(aiResponse, userMessage);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –∫—ç—à
            this.updateConversationHistory({
                role: 'assistant',
                content: processedResponse.text,
                timestamp: Date.now(),
                action: processedResponse.action
            });

            this.cache.set(cacheKey, processedResponse);
            
            return processedResponse;

        } catch (error) {
            console.error('‚ùå Gemini AI Error:', error);
            return this.getFallbackResponse(userMessage);
        }
    }

    // üìù –°—Ç—Ä–æ–∏–º —É–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤
    buildFinancialPrompt(userMessage, financialContext, messageType) {
        const language = state.user.language;
        const langConfig = {
            ru: { responseLang: '—Ä—É—Å—Å–∫–æ–º', examples: this.getRussianExamples() },
            en: { responseLang: 'English', examples: this.getEnglishExamples() },
            tj: { responseLang: '—Ç–æ“∑–∏–∫”£', examples: this.getTajikExamples() }
        }[language];

        return `
–¢—ã - VoiseTiFi AI, —É–º–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ, –ø–æ–ª–µ–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ ${langConfig.responseLang}.

–ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
- –î–æ—Ö–æ–¥: ${financialContext.monthlyIncome} ${financialContext.currency}
- –ë–∞–ª–∞–Ω—Å: ${financialContext.currentBalance.toFixed(2)} ${financialContext.currency}
- –¢—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: ${financialContext.monthSpending.toFixed(2)} ${financialContext.currency}
- –î–æ—Ö–æ–¥—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: ${financialContext.monthIncome.toFixed(2)} ${financialContext.currency}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: ${financialContext.budgetUtilization}%
- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞—Ç: ${financialContext.topSpendingCategories.map(c => `${c.icon} ${c.name}: ${c.amount.toFixed(2)}`).join(', ')}
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏: ${financialContext.activeGoals.length}
- –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–ª–≥–∏: ${financialContext.activeLoans.length}

–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:
${this.conversationHistory.slice(-3).map(msg => 
    `${msg.role === 'user' ? 'üë§' : 'ü§ñ'}: ${msg.content}`
).join('\n')}

–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "${userMessage}"
–¢–ò–ü –°–û–û–ë–©–ï–ù–ò–Ø: ${messageType}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ ${langConfig.responseLang}
2. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≥–æ–ª–æ—Å–∞)
3. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
4. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è
5. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä–∞—Å—á–µ—Ç—ã - –ø–æ–∫–∞–∂–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
6. –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ - –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–∑–≤—É—á–∏–≤–∞–µ–º—ã–º

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
${langConfig.examples}

–¢–ï–ö–£–©–ò–ô –ó–ê–ü–†–û–°: "${userMessage}"
`;
    }

    // üåê –í—ã–∑–æ–≤ Gemini API
   // üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î callGeminiAPI —Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
async callGeminiAPI(prompt) {
    try {
        console.log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini API...');
        
        const response = await fetch(`${this.baseURL}?key=${this.apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 500,
                }
            })
        });

        console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Gemini API Error:', errorData);
            throw new Error(`Gemini API error: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.candidates || !data.candidates[0].content.parts[0].text) {
            console.error('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:', data);
            throw new Error('Invalid response from Gemini API');
        }

        console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini');
        return data.candidates[0].content.parts[0].text;

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Gemini API, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É:', error);
        return this.getFallbackAIResponse(prompt);
    }
}

// üîß –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ú–ï–¢–û–î –í –ö–õ–ê–°–° FinancialAIAssistant
getFallbackAIResponse(prompt) {
    console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é AI —Å–∏—Å—Ç–µ–º—É...');
    
    const lowerPrompt = prompt.toLowerCase();
    
    // –ü—Ä–æ—Å—Ç—ã–µ rule-based –æ—Ç–≤–µ—Ç—ã –∫–æ–≥–¥–∞ Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const financialContext = this.getUserFinancialContext();
    
    // –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤
    if (lowerPrompt.includes('—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª') || lowerPrompt.includes('–∞–Ω–∞–ª–∏–∑') || lowerPrompt.includes('—Ç—Ä–∞—Ç—ã')) {
        return `üìä –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö: –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ${financialContext.monthSpending.toFixed(2)}${financialContext.currencySymbol}. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${financialContext.topSpendingCategories.map(c => `${c.icon} ${c.name}`).join(', ')}.`;
    }
    
    // –°–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏
    if (lowerPrompt.includes('—Å–æ–≤–µ—Ç') || lowerPrompt.includes('—ç–∫–æ–Ω–æ–º–∏') || lowerPrompt.includes('—Å—ç–∫–æ–Ω–æ–º–∏—Ç—å')) {
        const topCategory = financialContext.topSpendingCategories[0];
        return `üí° –°–æ–≤–µ—Ç: –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${topCategory.name}" - –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ${topCategory.amount.toFixed(2)}${financialContext.currencySymbol}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.`;
    }
    
    // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞
    if (lowerPrompt.includes('–±—é–¥–∂–µ—Ç') || lowerPrompt.includes('–ø–ª–∞–Ω') || lowerPrompt.includes('–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')) {
        const dailyBudget = (financialContext.monthlyIncome - financialContext.monthSpending) / 30;
        return `üéØ –†–µ–∫–æ–º–µ–Ω–¥—É—é –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: ${dailyBudget.toFixed(2)}${financialContext.currencySymbol}. –¢–∞–∫ –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ—Å—Ç–∏—á—å –±–∞–ª–∞–Ω—Å–∞ –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞.`;
    }
    
    // –ë–∞–ª–∞–Ω—Å
    if (lowerPrompt.includes('–±–∞–ª–∞–Ω—Å') || lowerPrompt.includes('–æ—Å—Ç–∞—Ç–æ–∫') || lowerPrompt.includes('–¥–µ–Ω—å–≥–∏')) {
        return `üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${financialContext.currentBalance.toFixed(2)}${financialContext.currencySymbol}. –î–æ—Ö–æ–¥—ã: ${financialContext.monthIncome.toFixed(2)}, —Ä–∞—Å—Ö–æ–¥—ã: ${financialContext.monthSpending.toFixed(2)}.`;
    }
    
    // –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    if (lowerPrompt.includes('–ø—Ä–∏–≤–µ—Ç') || lowerPrompt.includes('hello') || lowerPrompt.includes('—Å–∞–ª–æ–º')) {
        return "–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ VoiseTiFi. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?";
    }
    
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
    return "ü§ñ –Ø —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ VoiseTiFi. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞, –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–∞—Ö!";
}

    // üîß –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

// –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞: testGeminiConnection()

    // üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò
    // üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î processAIResponse
processAIResponse(aiResponse, originalQuery) {
    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–∏—à–µ–ª –æ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –ø–æ–º–µ—á–∞–µ–º —ç—Ç–æ
    const isFallback = typeof aiResponse === 'string' && !aiResponse.includes('candidates');
    
    const responseAnalysis = this.analyzeResponseType(aiResponse, originalQuery);
    
    return {
        text: aiResponse,
        type: responseAnalysis.type,
        action: responseAnalysis.action,
        shouldSpeak: true,
        showInUI: true,
        timestamp: Date.now(),
        isFallback: isFallback // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    };
}
    // üîç –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–∞
    analyzeResponseType(response, query) {
        const lowerResponse = response.toLowerCase();
        const lowerQuery = query.toLowerCase();

        if (lowerResponse.includes('—Å–æ–≤–µ—Ç') || lowerResponse.includes('—Ä–µ–∫–æ–º–µ–Ω–¥') || 
            lowerQuery.includes('—Å–æ–≤–µ—Ç') || lowerQuery.includes('—Ä–µ–∫–æ–º–µ–Ω–¥')) {
            return { type: 'advice', action: 'show_advice' };
        }

        if (lowerResponse.includes('–∞–Ω–∞–ª–∏–∑') || lowerResponse.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫') ||
            lowerQuery.includes('–∞–Ω–∞–ª–∏–∑') || lowerQuery.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫')) {
            return { type: 'analysis', action: 'show_analysis' };
        }

        if (lowerResponse.includes('—Ä–∞—Å—á–µ—Ç') || lowerResponse.includes('—Å—á–∏—Ç–∞–π') ||
            /\d+/.test(response)) {
            return { type: 'calculation', action: 'show_calculation' };
        }

        if (lowerResponse.includes('–ø–ª–∞–Ω') || lowerResponse.includes('–±—é–¥–∂–µ—Ç') ||
            lowerQuery.includes('–ø–ª–∞–Ω') || lowerQuery.includes('–±—é–¥–∂–µ—Ç')) {
            return { type: 'planning', action: 'show_plan' };
        }

        return { type: 'general', action: 'show_message' };
    }

    // üõ°Ô∏è –†–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    getFallbackResponse(query) {
        const fallbacks = {
            ru: {
                analysis: "üìä –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö: —Ç—Ä–∞—Ç—ã –≤ –Ω–æ—Ä–º–µ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'",
                advice: "üí° –°–æ–≤–µ—Ç: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö",
                calculation: "üî¢ –î–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞'",
                general: "ü§ñ –ò–∑–≤–∏–Ω–∏—Ç–µ, –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
            },
            en: {
                analysis: "üìä Based on your data: spending is normal, but watch the 'Entertainment' category",
                advice: "üí° Tip: Try setting category limits in settings", 
                calculation: "üî¢ For accurate calculations, check the 'Analytics' section",
                general: "ü§ñ Sorry, AI is temporarily unavailable. Check your internet connection"
            },
            tj: {
                analysis: "üìä –ê–∑ —Ä”Ø–∏ –º–∞—ä–ª—É–º–æ—Ç–∏ —à—É–º–æ: —Å–∞—Ä—Ñ“≥–æ –¥–∞—Ä “≥–æ–ª–∞—Ç–∏ –æ–¥”£, –∞–º–º–æ –±–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–∏ '–§–∞—Ä–æ“ì–∞—Ç' –¥–∏“õ“õ–∞—Ç –¥–∏“≥–µ–¥",
                advice: "üí° –ú–∞—Å–ª–∏“≥–∞—Ç: –î–∞—Ä —Ç–∞–Ω–∑–∏–º–æ—Ç –±–∞—Ä–æ–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è“≥–æ –ª–∏–º–∏—Ç “∑–æ—Ä”£ –∫—É–Ω–µ–¥",
                calculation: "üî¢ –ë–∞—Ä–æ–∏ “≥–∏—Å–æ–±“≥–æ–∏ –¥–∞“õ–∏“õ, –±–∞ –±–∞—Ö—à–∏ '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' –≥—É–∑–∞—Ä–µ–¥", 
                general: "ü§ñ –ë—É–±–∞—Ö—à–µ–¥, –ò–ò –º—É–≤–∞“õ“õ–∞—Ç–∞–Ω –¥–∞—Å—Ç—Ä–∞—Å –Ω–µ—Å—Ç. –ü–∞–π–≤–∞—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∏ —Ö—É–¥—Ä–æ —Å–∞–Ω“∑–µ–¥"
            }
        };

        const lang = state.user.language;
        const responseType = this.analyzeResponseType('', query).type;
        
        return {
            text: fallbacks[lang][responseType],
            type: responseType,
            action: 'show_message',
            shouldSpeak: true,
            showInUI: true
        };
    }

    // üìö –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
    getRussianExamples() {
        return `
–í: "–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?"
–û: "üìä –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ 450‚Ç¨. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: üõí –ü—Ä–æ–¥—É–∫—Ç—ã (150‚Ç¨), üöñ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (100‚Ç¨)"

–í: "–ö–∞–∫ –º–Ω–µ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å?"  
–û: "üí° –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞—Ç—ã –Ω–∞ –∫–∞—Ñ–µ –Ω–∞ 20%. –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–∏–º–∏—Ç –≤ 50‚Ç¨/–¥–µ–Ω—å"

–í: "–°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ –±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç?"
–û: "‚ö†Ô∏è –ü—Ä–∏ –≤–∞—à–µ–º –¥–æ—Ö–æ–¥–µ 2000‚Ç¨ –∫—Ä–µ–¥–∏—Ç 500‚Ç¨ —Å–æ—Å—Ç–∞–≤–∏—Ç 25% –º–µ—Å—è—á–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ - —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, –Ω–æ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã"

–í: "–°–ø–ª–∞–Ω–∏—Ä—É–π –±—é–¥–∂–µ—Ç –Ω–∞ –æ—Ç–ø—É—Å–∫"
–û: "üå¥ –î–ª—è –æ—Ç–ø—É—Å–∫–∞ –∑–∞ 3000‚Ç¨ –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è—Ö 1500‚Ç¨ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø–æ 500‚Ç¨ –≤ –º–µ—Å—è—Ü - –Ω–∞–∫–æ–ø–∏—Ç–µ –∑–∞ 3 –º–µ—Å—è—Ü–∞"
`;
    }

    getEnglishExamples() {
        return `
Q: "How much did I spend this month?"
A: "üìä This month you spent 450‚Ç¨. Top categories: üõí Groceries (150‚Ç¨), üöñ Transport (100‚Ç¨)"

Q: "How can I save money?"
A: "üí° I recommend reducing dining out by 20%. Also set a daily limit of 50‚Ç¨"  

Q: "Should I take this loan?"
A: "‚ö†Ô∏è With your 2000‚Ç¨ income, a 500‚Ç¨ loan is 25% of monthly income - acceptable, but consider interest rates"

Q: "Plan a vacation budget"  
A: "üå¥ For a 3000‚Ç¨ vacation with current savings of 1500‚Ç¨, I recommend saving 500‚Ç¨ monthly - you'll reach goal in 3 months"
`;
    }

    getTajikExamples() {
        return `
–°: "–ú–∞–Ω –¥–∞—Ä –∏–Ω –º–æ“≥ —á”£ “õ–∞–¥—Ä —Å–∞—Ä—Ñ –∫–∞—Ä–¥–∞–º?"
“∂: "üìä –î–∞—Ä –∏–Ω –º–æ“≥ —à—É–º–æ 450‚Ç¨ —Å–∞—Ä—Ñ –∫–∞—Ä–¥–µ–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—è“≥–æ–∏ –∞—Å–æ—Å”£: üõí –ú–∞“≥—Å—É–ª–æ—Ç (150‚Ç¨), üöñ –ù–∞–∫–ª–∏—ë—Ç (100‚Ç¨)"

–°: "–ß”£ —Ç–∞–≤—Ä —Å–∞—Ä—Ñ–∞ –∫—É–Ω–∞–º?"
“∂: "üí° –¢–∞–≤—Å–∏—è –º–µ–¥–∏“≥–∞–º —Å–∞—Ä—Ñ–∏ —Ö”Ø—Ä–æ–∫—Ö–æ–Ω–∞“≥–æ 20% –∫–æ“≥–∏–ª –¥–∏“≥–µ–¥. –ò–Ω—á—É–Ω–∏–Ω –ª–∏–º–∏—Ç–∏ —Ä”Ø–æ–Ω–∞ 50‚Ç¨ “∑–æ—Ä”£ –∫—É–Ω–µ–¥"

–°: "–û—ë –∏–Ω “õ–∞—Ä–∑ –≥–∏—Ä–∏—Ñ—Ç–∞–Ω –∞—Ä–∑–∏—à –¥–æ—Ä–∞–¥?"
“∂: "‚ö†Ô∏è –ë–æ –¥–∞—Ä–æ–º–∞–¥–∏ 2000‚Ç¨, “õ–∞—Ä–∑–∏ 500‚Ç¨ 25% -–∏ –¥–∞—Ä–æ–º–∞–¥–∏ –º–æ“≥–æ–Ω–∞ –∞—Å—Ç - “õ–æ–±–∏–ª–∏ “õ–∞–±—É–ª, –∞–º–º–æ —Ñ–æ–∏–∑–∏—Ä–æ –±–∞ –Ω–∞–∑–∞—Ä –≥–∏—Ä–µ–¥"

–°: "–ë–∞—Ä–æ–∏ —Ç–∞—ä—Ç–∏–ª –±—é–¥–∂–µ—Ç –≥–∏—Ä–µ–¥"
“∂: "üå¥ –ë–∞—Ä–æ–∏ —Ç–∞—ä—Ç–∏–ª–∏ 3000‚Ç¨ –±–æ –Ω–∞“ì–∑“≥–æ–∏ “∑–æ—Ä”£ 1500‚Ç¨, —Ç–∞–≤—Å–∏—è –º–µ–¥–∏“≥–∞–º “≥–∞—Ä –º–æ“≥ 500‚Ç¨ –Ω–∞“ì–∑ –∫—É–Ω–µ–¥ - –¥–∞—Ä –¥–∞–≤–æ–º–∏ 3 –º–æ“≥ –±–∞ “≥–∞–¥–∞—Ñ –º–µ—Ä–∞—Å–µ–¥"
`;
    }

    // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    updateConversationHistory(message) {
        this.conversationHistory.push(message);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (this.conversationHistory.length > this.maxHistory) {
            this.conversationHistory = this.conversationHistory.slice(-this.maxHistory);
        }
    }

    // üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏
    clearCache() {
        this.cache.clear();
        this.conversationHistory = [];
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
const financialAI = new FinancialAIAssistant();

// ==========================================
// üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ==========================================

function initializeVoiceRecognition() {
    voiceManager = new VoiceManager();
    console.log('‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

// ==========================================
// üé§ –û–¢–ö–†–´–¢–¨ –ì–û–õ–û–°–û–í–£–Æ –ú–û–î–ê–õ–ö–£
// ==========================================

function openVoiceModal() {
    if (!voiceManager) {
        showToast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
        return;
    }
    
    voiceManager.start(state.user.language);
}

// ==========================================
// üîä –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ==========================================

function toggleVoiceRecording() {
    if (voiceManager) {
        if (voiceManager.isListening) {
            voiceManager.stop();
        } else {
            voiceManager.start();
        }
    }
}

function startVoiceRecording() {
    if (voiceManager) {
        voiceManager.start();
    }
}

function stopVoiceRecording() {
    if (voiceManager) {
        voiceManager.stop();
    }
}
function getLanguageCode(lang) {
    const codes = {
        ru: 'ru-RU',
        en: 'en-US',
        tj: 'tg-TJ'
    };
    return codes[lang] || 'ru-RU';
}




// ==========================================
// üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ==========================================

function initializeVoiceRecognition() {
    voiceManager = new VoiceManager();
    console.log('‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

// üî• –ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø addTransactionFromVoice - –î–û–ë–ê–í–¨–¢–ï –í –ö–õ–ê–°–° VoiceManager:

// üî• –ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø detectCategory - –î–û–ë–ê–í–¨–¢–ï –í –ö–õ–ê–°–° VoiceManager:

// ==========================================
// üé§ –û–¢–ö–†–´–¢–¨ –ì–û–õ–û–°–û–í–£–Æ –ú–û–î–ê–õ–ö–£
// ==========================================

function openVoiceModal() {
    if (!voiceManager) {
        showToast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
        return;
    }
    
    voiceManager.start(state.user.language);
}

// ==========================================
// üîä –û–ó–í–£–ß–ò–¢–¨ –¢–ï–ö–°–¢ (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
// ==========================================

function toggleVoiceRecording() {
    if (voiceManager) {
        if (voiceManager.isListening) {
            voiceManager.stop();
        } else {
            voiceManager.start();
        }
    }
}

function startVoiceRecording() {
    if (voiceManager) {
        voiceManager.start();
    }
}

function stopVoiceRecording() {
    if (voiceManager) {
        voiceManager.stop();
    }
}

function getLanguageCode(lang) {
    const codes = {
        ru: 'ru-RU',
        en: 'en-US',
        tj: 'tg-TJ'
    };
    return codes[lang] || 'ru-RU';
}



// Mustafoshoh Programer // Management Functions
function manageCategories() {
    openModal('category-modal');
    renderCategoriesList();
}

function renderCategoriesList() {
    const container = document.getElementById('category-list');
    if (!container) return;
    
    container.innerHTML = Object.entries(state.categories).map(([key, cat]) => `
        <div class="list-item">
            <div class="list-item-info">
                <div class="list-item-icon">${cat.icon}</div>
                <div class="list-item-details">
                    <div class="list-item-name">${cat[state.user.language]}</div>
                    <div class="list-item-subtitle">${key}</div>
                </div>
            </div>
            <div class="list-item-actions">
                <button class="list-item-btn" onclick="editCategory('${key}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <button class="list-item-btn delete" onclick="deleteCategory('${key}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `).join('');
}

function addNewCategory() {
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
    if (!name || name.trim() === '') return;
    
    const icon = prompt('–ò–∫–æ–Ω–∫–∞ (emoji):', 'üì¶');
    if (!icon) return;
    
    // –¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const isExpense = confirm('–≠—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤? (–û–ö = –î–∞, –û—Ç–º–µ–Ω–∞ = –î–æ—Ö–æ–¥)');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
    const key = 'custom_' + name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
    
    // –°–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç
    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    state.categories[key] = {
        ru: name,
        en: name,
        tj: name,
        icon: icon,
        color: randomColor,
        isCustom: true,
        isExpense: isExpense // ‚Üê –í–ê–ñ–ù–û!
    };
    
    saveData();
    renderCategoriesList();
    updateCategoryGrids(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ç–∫–∏
    showToast('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
}

function updateCategoryGrids() {
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ç–∫—É —Ä–∞—Å—Ö–æ–¥–æ–≤
    const expenseGrid = document.getElementById('expense-categories');
    if (expenseGrid) {
        renderCategoryGrid(expenseGrid, 'expense');
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ç–∫—É –¥–æ—Ö–æ–¥–æ–≤
    const incomeGrid = document.getElementById('income-categories');
    if (incomeGrid) {
        renderCategoryGrid(incomeGrid, 'income');
    }
}

// üî• –ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø detectCategory - –î–û–ë–ê–í–¨–¢–ï –í –ö–õ–ê–°–° VoiceManager:

function renderCategoryGrid(container, type) {
    if (!container) return;
    
    container.innerHTML = '';
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const allCategories = Object.keys(state.categories);
    
    // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø—É
    const categoryKeys = allCategories.filter(key => {
        const cat = state.categories[key];
        
        if (type === 'expense') {
            // –†–∞—Å—Ö–æ–¥—ã: –≤—Å–µ –∫—Ä–æ–º–µ –¥–æ—Ö–æ–¥–Ω—ã—Ö
            if (['salary', 'freelance', 'gift', 'investment'].includes(key)) {
                return false;
            }
            // –ï—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø
            if (cat.isCustom && cat.isExpense === false) {
                return false;
            }
            return true;
        } else {
            // –î–æ—Ö–æ–¥—ã: —Ç–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥–Ω—ã–µ
            if (['salary', 'freelance', 'gift', 'investment'].includes(key)) {
                return true;
            }
            // –ï—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø
            if (cat.isCustom && cat.isExpense === false) {
                return true;
            }
            return false;
        }
    });
    
    // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å
    categoryKeys.forEach(key => {
        const cat = state.categories[key];
        const item = document.createElement('div');
        item.className = 'category-item';
        item.onclick = () => selectCategory(key, type);
        item.innerHTML = `
            <div class="category-icon">${cat.icon}</div>
            <div class="category-label">${cat[state.user.language]}</div>
        `;
        container.appendChild(item);
    });
    
    console.log(`‚úÖ –û—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–æ ${categoryKeys.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ç–∏–ø–∞ "${type}"`);
}

function editCategory(key) {
    const cat = state.categories[key];
    if (!cat) return;
    
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', cat[state.user.language]);
    if (!name) return;
    
    const icon = prompt('–ò–∫–æ–Ω–∫–∞ (emoji):', cat.icon);
    if (!icon) return;
    
    cat[state.user.language] = name;
    cat.icon = icon;
    
    saveData();
    renderCategoriesList();
    showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
}

function deleteCategory(key) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) return;
    
    delete state.categories[key];
    saveData();
    renderCategoriesList();
    showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
}

function manageLoans() {
    openModal('loan-modal');
    renderLoansList();
}

function renderLoansList() {
    const container = document.getElementById('loan-list');
    if (!container) return;
    
    if (state.loans.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí∞</div>
                <div class="empty-state-text">–ù–µ—Ç –¥–æ–ª–≥–æ–≤</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = state.loans.map(loan => {
        const isPaid = loan.isPaid;
        const isOverdue = new Date(loan.date) < new Date() && !isPaid;
        const daysLeft = Math.ceil((new Date(loan.date) - new Date()) / (24 * 60 * 60 * 1000));
        
        let statusText = '';
        let statusColor = '';
        
        if (isPaid) {
            statusText = '‚úÖ –ü–æ–≥–∞—à–µ–Ω–æ';
            statusColor = '#10b981';
        } else if (isOverdue) {
            statusText = `‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(daysLeft)} –¥–Ω.`;
            statusColor = '#ef4444';
        } else {
            statusText = `‚è∞ –û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω.`;
            statusColor = '#f59e0b';
        }
        
        const typeIcon = loan.type === 'owe' ? 'üî¥' : 'üü¢';
        const typeText = loan.type === 'owe' ? '–¢—ã –¥–æ–ª–∂–µ–Ω' : '–¢–µ–±–µ –¥–æ–ª–∂–Ω—ã';
        
        return `
            <div class="list-item" style="${isPaid ? 'opacity: 0.5;' : ''}">
                <div class="list-item-info">
                    <div class="list-item-icon">${typeIcon}</div>
                    <div class="list-item-details">
                        <div class="list-item-name">${loan.name}</div>
                        <div class="list-item-subtitle">
                            ${typeText}: ${formatCurrency(loan.amount)}<br>
                            <span style="color: ${statusColor};">${statusText}</span>
                        </div>
                    </div>
                </div>
                <div class="list-item-actions">
                    ${!isPaid ? `
                        <button class="list-item-btn" onclick="payLoan(${loan.id})">–ü–æ–≥–∞—Å–∏—Ç—å</button>
                    ` : ''}
                    <button class="list-item-btn delete" onclick="deleteLoan(${loan.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
    }).join('');
}

function addNewLoan() {
    // –°–ø—Ä–æ—Å–∏—Ç—å —Ç–∏–ø –¥–æ–ª–≥–∞
    const loanType = confirm('–¢—ã –¥–æ–ª–∂–µ–Ω? (–û–ö = –î–∞, –û—Ç–º–µ–Ω–∞ = –ú–Ω–µ –¥–æ–ª–∂–Ω—ã)');
    
    const name = prompt('–ö–æ–º—É/–û—Ç –∫–æ–≥–æ?', '–í–∞—Å—è');
    if (!name) return;
    
    const amount = parseFloat(prompt('–°—É–º–º–∞:', '1000'));
    if (!amount || amount <= 0) return;
    
    const date = prompt('–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î):', new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
    if (!date) return;
    
    const loan = {
        id: Date.now(),
        name: name,
        amount: amount,
        date: date,
        type: loanType ? 'owe' : 'lent', // owe = —Ç—ã –¥–æ–ª–∂–µ–Ω, lent = —Ç–µ–±–µ –¥–æ–ª–∂–Ω—ã
        currency: state.user.currency,
        isPaid: false,
        createdAt: Date.now()
    };
    
    state.loans.push(loan);
    saveData();
    renderLoansList();
    
    // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    if (loanType) {
        // –¢—ã –≤–∑—è–ª –≤ –¥–æ–ª–≥ = –¥–æ—Ö–æ–¥
        const transaction = {
            id: Date.now(),
            type: 'income',
            amount: amount,
            currency: state.user.currency,
            category: 'other',
            description: `–î–æ–ª–≥ –æ—Ç ${name}`,
            timestamp: Date.now()
        };
        state.transactions.unshift(transaction);
    }
    
    saveData();
    updateUI();
    
    showToast(translations[state.user.language].loanAdded, 'success');
}

function payLoan(id) {
    const loan = state.loans.find(l => l.id === id);
    if (!loan) return;
    
    const transaction = {
        id: Date.now(),
        type: 'expense',
        amount: loan.amount,
        category: 'other',
        description: `–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞: ${loan.name}`,
        timestamp: Date.now(),
        currency: loan.currency || state.user.currency
    };
    
    state.transactions.unshift(transaction);
    state.loans = state.loans.filter(l => l.id !== id);
    
    saveData();
    renderLoansList();
    updateUI();
    
    showToast(translations[state.user.language].loanPaid, 'success');
}

function deleteLoan(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–≥?')) return;
    
    state.loans = state.loans.filter(l => l.id !== id);
    saveData();
    renderLoansList();
    showToast('–î–æ–ª–≥ —É–¥–∞–ª–µ–Ω', 'success');
}

function manageRecurring() {
    openModal('recurring-modal');
    renderRecurringList();
}

function renderRecurringList() {
    const container = document.getElementById('recurring-list');
    if (!container) return;
    
    if (state.recurringPayments.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-text">–ù–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–ª–∞—Ç–µ–∂–µ–π</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = state.recurringPayments.map(payment => `
        <div class="list-item">
            <div class="list-item-info">
                <div class="list-item-icon">üîÑ</div>
                <div class="list-item-details">
                    <div class="list-item-name">${payment.name}</div>
                    <div class="list-item-subtitle">${formatCurrency(payment.amount)} - ${payment.frequency}</div>
                </div>
            </div>
            <div class="list-item-actions">
                <button class="list-item-btn delete" onclick="deleteRecurring(${payment.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `).join('');
}

function addNewRecurring() {
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:');
    if (!name) return;
    
    const amount = parseFloat(prompt('–°—É–º–º–∞:'));
    if (!amount || amount <= 0) return;
    
    const frequency = prompt('–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å (daily/weekly/monthly):', 'monthly');
    if (!frequency) return;
    
    const payment = {
        id: Date.now(),
        name: name,
        amount: amount,
        frequency: frequency,
        nextDate: new Date().toISOString(),
        currency: state.user.currency,
        isActive: true
    };
    
    state.recurringPayments.push(payment);
    saveData();
    renderRecurringList();
    showToast(translations[state.user.language].recurringAdded, 'success');
}

function deleteRecurring(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂?')) return;
    
    state.recurringPayments = state.recurringPayments.filter(p => p.id !== id);
    saveData();
    renderRecurringList();
    showToast('–ü–ª–∞—Ç–µ–∂ —É–¥–∞–ª–µ–Ω', 'success');
}

function processRecurringPayments() {
    const now = new Date();
    
    state.recurringPayments.forEach(payment => {
        if (!payment.isActive) return;
        
        const nextDate = new Date(payment.nextDate);
        if (nextDate <= now) {
            const transaction = {
                id: Date.now(),
                type: 'expense',
                amount: payment.amount,
                category: 'bills',
                description: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂: ${payment.name}`,
                timestamp: nextDate.getTime(),
                currency: payment.currency || state.user.currency
            };
            
            state.transactions.unshift(transaction);
            
            switch(payment.frequency) {
                case 'daily':
                    nextDate.setDate(nextDate.getDate() + 1);
                    break;
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
            }
            
            payment.nextDate = nextDate.toISOString();
        }
    });
    
    saveData();
}

function manageGoals() {
    openModal('goals-modal');
    renderGoalsList();
}

function renderGoalsList() {
    const container = document.getElementById('goals-list');
    if (!container) return;
    
    if (state.savingsGoals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-text">–ù–µ—Ç —Ü–µ–ª–µ–π</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = state.savingsGoals.map(goal => {
        const progress = (goal.current / goal.target) * 100;
        
        return `
            <div class="list-item">
                <div class="list-item-info">
                    <div class="list-item-icon">üéØ</div>
                    <div class="list-item-details">
                        <div class="list-item-name">${goal.name}</div>
                        <div class="list-item-subtitle">${formatCurrency(goal.current)} –∏–∑ ${formatCurrency(goal.target)}</div>
                    </div>
                </div>
                <div class="list-item-actions">
                    <button class="list-item-btn" onclick="addToGoal(${goal.id})">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="list-item-btn delete" onclick="deleteGoal(${goal.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            <div class="goal-progress">
                <div class="goal-progress-bar">
                    <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                </div>
                <div class="goal-progress-text">${Math.round(progress)}%</div>
            </div>
        `;
    }).join('');
}

function addNewGoal() {
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏:');
    if (!name) return;
    
    const target = parseFloat(prompt('–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞:'));
    if (!target || target <= 0) return;
    
    const goal = {
        id: Date.now(),
        name: name,
        target: target,
        current: 0,
        currency: state.user.currency,
        created: new Date().toISOString()
    };
    
    state.savingsGoals.push(goal);
    saveData();
    renderGoalsList();
    showToast(translations[state.user.language].goalCreated, 'success');
}

function addToGoal(id) {
    const goal = state.savingsGoals.find(g => g.id === id);
    if (!goal) return;
    
    const amount = parseFloat(prompt(`–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –∫ —Ü–µ–ª–∏ "${goal.name}"?`));
    if (!amount || amount <= 0) return;
    
    // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–¶–µ–ª—å"
    const transaction = {
        id: Date.now(),
        type: 'expense',
        amount: amount,
        category: 'goal', // ‚Üê –ö–ê–¢–ï–ì–û–†–ò–Ø "–¶–ï–õ–¨"!
        description: `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏: ${goal.name}`,
        timestamp: Date.now(),
        currency: state.user.currency,
        goalId: goal.id // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ü–µ–ª–∏
    };
    
    state.transactions.unshift(transaction);
    goal.current += amount;
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
    if (goal.current >= goal.target && !goal.completed) {
        goal.completed = true;
        goal.completedAt = Date.now();
        
        // üéâ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –î–û–°–¢–ò–ñ–ï–ù–ò–ò!
        showToast(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¶–µ–ª—å "${goal.name}" –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!`, 'success');
        
        // –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(
                `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏ ${goal.name}!`
            );
            utterance.lang = 'ru-RU';
            window.speechSynthesis.speak(utterance);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        showConfetti();
    } else if (goal.current >= goal.target * 0.5 && goal.current < goal.target * 0.55) {
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–µ –ø—É—Ç–∏
        showToast(`üéØ –ü–æ–ª–æ–≤–∏–Ω–∞ –ø—É—Ç–∏! –¶–µ–ª—å "${goal.name}" - ${Math.round((goal.current/goal.target)*100)}%`, 'info');
    }
    
    saveData();
    renderGoalsList();
    updateUI();
    
    showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${formatCurrency(amount)} –∫ —Ü–µ–ª–∏`, 'success');
}

function showConfetti() {
    // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
    const colors = ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
    
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
                position: fixed;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                top: -10px;
                left: ${Math.random() * 100}%;
                border-radius: 50%;
                z-index: 9999;
                animation: confetti-fall ${2 + Math.random() * 2}s ease-out forwards;
            `;
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ CSS:
/*
@keyframes confetti-fall {
    to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
    }
}
*/

// Mustafoshoh Programer // Utility Functions
function formatCurrency(amount) {
    const symbol = currencySymbols[state.user.currency];
    return `${symbol}${Number(amount) ? Number(amount).toFixed(2) : "0.00"}`;
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    const lang = state.user.language;
    
    const dayName = translations[lang].days[date.getDay()];
    const day = date.getDate();
    const month = translations[lang].months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${dayName}, ${day} ${month} ${year}`;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function updateElementText(id, text) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = text;
    }
}

function getFilteredTransactions(type, period) {
    let transactions = [...state.transactions];
    
    if (type && type !== 'all') {
        transactions = transactions.filter(t => t.type === type);
    }
    
    if (period) {
        const now = new Date();
        let startDate;
        
        switch(period) {
            case 'today':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
            case 'week':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
        }
        
        if (startDate) {
            transactions = transactions.filter(t => t.timestamp >= startDate.getTime());
        }
    }
    
    if (state.filters.type && state.filters.type !== 'all') {
        transactions = transactions.filter(t => t.type === state.filters.type);
    }
    
    if (state.filters.category && state.filters.category !== 'all') {
        transactions = transactions.filter(t => t.category === state.filters.category);
    }
    
    if (state.filters.dateFrom) {
        transactions = transactions.filter(t => t.timestamp >= new Date(state.filters.dateFrom).getTime());
    }
    
    if (state.filters.dateTo) {
        transactions = transactions.filter(t => t.timestamp <= new Date(state.filters.dateTo).getTime());
    }
    
    return transactions.sort((a, b) => b.timestamp - a.timestamp);
}

function groupTransactionsByDate(transactions) {
    const grouped = {};
    const lang = state.user.language;
    
    transactions.forEach(t => {
        const date = new Date(t.timestamp);
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        let dateKey;
        if (date.toDateString() === today.toDateString()) {
            dateKey = translations[lang].today;
        } else if (date.toDateString() === yesterday.toDateString()) {
            dateKey = translations[lang].yesterday;
        } else {
            const day = date.getDate();
            const month = translations[lang].months[date.getMonth()];
            dateKey = `${day} ${month}`;
        }
        
        if (!grouped[dateKey]) {
            grouped[dateKey] = [];
        }
        grouped[dateKey].push(t);
    });
    
    return grouped;
}

function createTransactionHTML(transaction) {
    const category = state.categories[transaction.category] || state.categories.other;
    const txRate = rates[transaction.currency] || 1;
    const rate = rates[state.user.currency] || 1;
    const amount = (transaction.amount * txRate) / rate;
    
    return `
        <div class="transaction-item" onclick="showTransactionDetail(${transaction.id})">
            <div class="transaction-icon" style="background: ${category.color}20;">
                ${category.icon}
            </div>
            <div class="transaction-info">
                <div class="transaction-title">${transaction.description || category[state.user.language]}</div>
                <div class="transaction-time">${formatTime(transaction.timestamp)}</div>
            </div>
            <div class="transaction-amount ${transaction.type}">
                ${transaction.type === 'expense' ? '-' : '+'}${formatCurrency(amount)}
            </div>
        </div>
    `;
}

function showToast(message, type) {
    type = type || 'info';
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${message}</span>`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.add('active');
}

function checkNotifications() {
    if (state.settings.notifications.budget) {
        const rate = rates[state.user.currency] || 1;
        const budget = state.user.monthlyIncome * rate;
        const expenses = getFilteredTransactions('expense', 'month');
        const totalExpense = expenses.reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
        
        if (totalExpense > budget) {
            showToast('–ü—Ä–µ–≤—ã—à–µ–Ω –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç!', 'warning');
        }
    }
    
    if (state.settings.notifications.debt && state.loans.length > 0) {
        showToast(`–£ –≤–∞—Å ${state.loans.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤`, 'info');
    }
}

// Mustafoshoh Programer // Smart Notifications & Category Limits
// ==========================================

// üî• –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ö–û–î –ü–û–°–õ–ï –§–£–ù–ö–¶–ò–ò checkNotifications()

// Category Limits System
// Category Limits System
function initializeCategoryLimits() {
    if (!state.categoryLimits) {
        state.categoryLimits = {
            food: 300,
            transport: 100,
            restaurant: 200,
            health: 150,
            clothes: 250,
            entertainment: 100,
            bills: 500,
            other: 50
        };
        console.log('‚úÖ Category limits initialized');
    }
}

// Smart Notifications System
// üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø checkSmartNotifications
function checkSmartNotifications() {
    console.log('üîî –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–º–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
    
    try {
        const rate = rates[state.user.currency] || 1;
        const budget = state.user.monthlyIncome;
        const expenses = getFilteredTransactions('expense', 'month');
        const totalExpense = expenses.reduce((sum, t) => {
            const txRate = rates[t.currency] || 1;
            return sum + ((t.amount * txRate) / rate);
        }, 0);
        
        const alerts = [];
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞
        if (budget > 0 && totalExpense > budget * 0.9) {
            alerts.push({
                type: 'warning',
                icon: '‚ö†Ô∏è',
                title: '–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –ª–∏–º–∏—Ç—É',
                text: `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ ${Math.round((totalExpense/budget)*100)}% –æ—Ç –±—é–¥–∂–µ—Ç–∞`
            });
        }
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–ª–≥–∞—Ö
        if (state.loans && state.loans.length > 0) {
            const activeLoans = state.loans.filter(loan => !loan.isPaid);
            if (activeLoans.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'üí≥',
                    title: '–ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–ª–≥–∏',
                    text: `–£ –≤–∞—Å ${activeLoans.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤`
                });
            }
        }
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
        if (state.recurringPayments && state.recurringPayments.length > 0) {
            const today = new Date();
            const upcomingPayments = state.recurringPayments.filter(payment => {
                if (!payment.isActive || !payment.nextDate) return false;
                const nextDate = new Date(payment.nextDate);
                const daysDiff = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                return daysDiff >= 0 && daysDiff <= 3;
            });
            
            if (upcomingPayments.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'üîÑ',
                    title: '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏',
                    text: `–°–∫–æ—Ä–æ ${upcomingPayments.length} —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π`
                });
            }
        }
        
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', alerts.length);
        return alerts;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ checkSmartNotifications:', error);
        return [];
    }
}
function hasTransactionsToday() {
    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    
    return state.transactions.some(t => 
        t.timestamp >= todayStart.getTime() && t.type === 'expense'
    );
}

function isEveningTime() {
    const hour = new Date().getHours();
    return hour >= 18 && hour <= 22; // –í–µ—á–µ—Ä–æ–º —Å 18:00 –¥–æ 22:00
}

function getUpcomingPayments() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const upcoming = [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
    state.recurringPayments.forEach(payment => {
        if (payment.isActive && payment.nextDate.startsWith(tomorrowStr)) {
            upcoming.push(payment);
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ª–≥–∏
    state.loans.forEach(loan => {
        if (!loan.isPaid && loan.date === tomorrowStr) {
            upcoming.push({
                name: `–î–æ–ª–≥: ${loan.name}`,
                amount: loan.amount,
                type: 'loan'
            });
        }
    });
    
    return upcoming;
}

function checkCategoryLimits() {
    const exceeded = [];
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    const monthExpenses = state.transactions.filter(t => {
        const date = new Date(t.timestamp);
        return t.type === 'expense' && 
               date.getMonth() === currentMonth && 
               date.getFullYear() === currentYear;
    });
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categoryTotals = {};
    monthExpenses.forEach(t => {
        const cat = t.category || 'other';
        const txRate = rates[t.currency] || 1;
        const rate = rates[state.user.currency] || 1;
        const convertedAmount = (t.amount * txRate) / rate;
        
        categoryTotals[cat] = (categoryTotals[cat] || 0) + convertedAmount;
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
    Object.entries(state.categoryLimits || {}).forEach(([category, limit]) => {
        const spent = categoryTotals[category] || 0;
        if (spent > limit) {
            const overPercent = Math.round(((spent - limit) / limit) * 100);
            const categoryName = state.categories[category]?.[state.user.language] || category;
            
            exceeded.push({
                category,
                categoryName,
                spent,
                limit,
                overPercent
            });
        }
    });
    
    return exceeded;
}

function displaySmartNotifications(notifications) {
    if (notifications.length === 0) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç—ã –¥–ª—è —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    notifications.forEach(notif => {
        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const lastShown = localStorage.getItem(`notif_${notif.title}`);
        const now = Date.now();
        
        if (!lastShown || (now - parseInt(lastShown)) > 6 * 60 * 60 * 1000) { // 6 —á–∞—Å–æ–≤
            showToast(`${notif.icon} ${notif.text}`, notif.type);
            localStorage.setItem(`notif_${notif.title}`, now.toString());
        }
    });
}

// üî• –û–ë–ù–û–í–ò–¢–ï –°–£–©–ï–°–¢–í–£–Æ–©–£–Æ –§–£–ù–ö–¶–ò–Æ checkNotifications()
function checkNotifications() {
    try {
        const smartAlerts = checkSmartNotifications();
        const container = document.getElementById('alerts-container');
        
        if (!container) return;
        
        if (smartAlerts.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = smartAlerts.map(alert => `
            <div class="alert ${alert.type}">
                <div class="alert-icon">${alert.icon}</div>
                <div class="alert-content">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-text">${alert.text}</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error in checkNotifications:', error);
    }
}
    
    // –ë–∞–∑–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—é–¥–∂–µ—Ç–µ
    if (totalExpense > budget * 0.9 && totalExpense < budget) {
        alerts.push({
            type: 'warning',
            icon: '‚ö†Ô∏è',
            title: '–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –ª–∏–º–∏—Ç—É',
            text: `–í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ${Math.round((totalExpense/budget)*100)}% –æ—Ç –±—é–¥–∂–µ—Ç–∞`
        });
    }
    
    if (totalExpense > budget) {
        alerts.push({
            type: 'danger',
            icon: 'üö®',
            title: '–ü—Ä–µ–≤—ã—à–µ–Ω –±—é–¥–∂–µ—Ç!',
            text: `–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: ${formatCurrency(totalExpense - budget)}`
        });
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ–ª–≥–∞—Ö
    if (state.loans.length > 0) {
        const totalDebt = state.loans.reduce((sum, l) => {
            const loanRate = rates[l.currency || state.user.currency] || 1;
            return sum + ((l.amount * loanRate) / rate);
        }, 0);
        alerts.push({
            type: 'info',
            icon: 'üí≥',
            title: '–ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–ª–≥–∏',
            text: `–£ –≤–∞—Å ${state.loans.length} –¥–æ–ª–≥–æ–≤ –Ω–∞ —Å—É–º–º—É ${formatCurrency(totalDebt)}`
        });
    }
    
    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –£–ú–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    const smartAlerts = checkCategoryLimits().slice(0, 2); // –ú–∞–∫—Å–∏–º—É–º 2 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö
    
    smartAlerts.forEach(limit => {
        alerts.push({
            type: 'danger',
            icon: 'üìä',
            title: `–õ–∏–º–∏—Ç "${limit.categoryName}"`,
            text: `–ü—Ä–µ–≤—ã—à–µ–Ω –Ω–∞ ${limit.overPercent}% (${formatCurrency(limit.spent)} / ${formatCurrency(limit.limit)})`
        });
    });
    
    container.innerHTML = alerts.map(a => `
        <div class="alert ${a.type}">
            <div class="alert-icon">${a.icon}</div>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-text">${a.text}</div>
            </div>
        </div>
    `).join('');

// üî• –î–û–ë–ê–í–¨–¢–ï –í –§–£–ù–ö–¶–ò–Æ initializeApp() (–ø–æ—Å–ª–µ loadData())
function initializeApp() {
    if (state.isFirstLaunch) {
        showOnboarding();
    } else {
        checkSecurityOnLoad();
    }
    
    const onboardingEl = document.getElementById('onboarding');
    const appEl = document.getElementById('app');
    
    if (onboardingEl) {
        onboardingEl.style.display = 'none';
    }
    
    if (appEl) {
        appEl.style.display = 'block';
        appEl.style.opacity = '1';
    }
    
    // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –õ–ò–ú–ò–¢–´ –ö–ê–¢–ï–ì–û–†–ò–ô
    initializeCategoryLimits();
    
    applyTheme();
    updateUI();
    renderAllScreens();
    applyTheme();
updateThemeDependentElements();
    
    // üî• –ó–ê–ü–£–°–ö–ê–ï–ú –£–ú–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –° –ó–ê–î–ï–†–ñ–ö–û–ô
    setTimeout(() => {
        checkSmartNotifications();
    }, 3000); // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    
    setTimeout(() => {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        }
        initializeVoiceRecognition();
    }, 200);
}

// Mustafoshoh Programer // Export/Import Functions
// Mustafoshoh Programer // Export/Import Functions
function exportData() {
    const format = confirm('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Excel? (OK = Excel, –û—Ç–º–µ–Ω–∞ = JSON)');
    
    if (format) {
        exportToExcel();
    } else {
        exportToJSON();
    }
}

function exportToJSON() {
    const data = {
        version: '1.0.0',
        exportDate: new Date().toISOString(),
        ...state
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `voicetifi-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON', 'success');
}

function exportToExcel() {
    let csv = 'ID,–î–∞—Ç–∞,–í—Ä–µ–º—è,–¢–∏–ø,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–û–ø–∏—Å–∞–Ω–∏–µ,–°—É–º–º–∞,–í–∞–ª—é—Ç–∞\n';
    
    state.transactions.forEach(t => {
        const date = new Date(t.timestamp);
        const dateStr = date.toLocaleDateString('ru-RU');
        const timeStr = date.toLocaleTimeString('ru-RU');
        const category = state.categories[t.category]?.[state.user.language] || t.category;
        const type = t.type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : t.type === 'income' ? '–î–æ—Ö–æ–¥' : '–ü–µ—Ä–µ–≤–æ–¥';
        
        csv += `${t.id},"${dateStr}","${timeStr}","${type}","${category}","${t.description || ''}",${t.amount},${t.currency}\n`;
    });
    
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `voicetifi-export-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('üìä –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Excel (CSV)', 'success');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name.toLowerCase();
    
    if (fileName.endsWith('.json')) {
        importFromJSON(file);
    } else if (fileName.endsWith('.csv')) {
        importFromCSV(file);
    
     } else if (fileName.endsWith('.vtf')) {
        importEncrypted(file);
    } else {
        showToast('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ JSON –∏ CSV —Ñ–∞–π–ª—ã', 'error');
    }
    
    event.target.value = '';
}

function importFromJSON(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.version && data.user) {
                const backup = { ...state };
                localStorage.setItem('voicetifi_import_backup', JSON.stringify(backup));
                
                state = { ...state, ...data };
                saveData();
                
                updateUI();
                renderAllScreens();
                
                showToast('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ JSON', 'success');
            } else {
                throw new Error('Invalid backup file');
            }
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
            console.error('Import error:', error);
        }
    };
    
    reader.readAsText(file);
}

function importFromCSV(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            
            let imported = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
                
                if (values.length < 7) continue;
                
                const transaction = {
                    id: parseInt(values[0]) || Date.now() + i,
                    type: values[3]?.replace(/"/g, '') === '–†–∞—Å—Ö–æ–¥' ? 'expense' : 
                          values[3]?.replace(/"/g, '') === '–î–æ—Ö–æ–¥' ? 'income' : 'transfer',
                    category: findCategoryByName(values[4]?.replace(/"/g, '')),
                    description: values[5]?.replace(/"/g, ''),
                    amount: parseFloat(values[6]) || 0,
                    currency: values[7]?.replace(/"/g, '') || 'USD',
                    timestamp: parseCSVDate(values[1], values[2])
                };
                
                state.transactions.push(transaction);
                imported++;
            }
            
            saveData();
            updateUI();
            renderAllScreens();
            
            showToast(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ CSV`, 'success');
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV', 'error');
            console.error('CSV Import error:', error);
        }
    };
    
    reader.readAsText(file);
}

function findCategoryByName(name) {
    for (const [key, cat] of Object.entries(state.categories)) {
        if (cat[state.user.language] === name || cat.ru === name || cat.en === name) {
            return key;
        }
    }
    return 'other';
}

function parseCSVDate(dateStr, timeStr) {
    try {
        dateStr = dateStr?.replace(/"/g, '');
        timeStr = timeStr?.replace(/"/g, '');
        
        const [day, month, year] = dateStr.split('.');
        const [hours, minutes] = timeStr.split(':');
        
        return new Date(year, month - 1, day, hours, minutes).getTime();
    } catch (e) {
        return Date.now();
    }
}
function clearAllData() {
    if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?\n\n‚Ä¢ –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n‚Ä¢ –í—Å–µ –¥–æ–ª–≥–∏\n‚Ä¢ –í—Å–µ —Ü–µ–ª–∏\n‚Ä¢ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–õ–¨–ó–Ø –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        return;
    }
    
    const confirmText = prompt('–í–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨ –í–°–Å" (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏) –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:');
    
    if (confirmText !== '–£–î–ê–õ–ò–¢–¨ –í–°–Å') {
        showToast('–û—Ç–º–µ–Ω–µ–Ω–æ. –î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª–µ–Ω—ã.', 'info');
        return;
    }
    
    const backup = { ...state };
    const backupDate = new Date().toISOString();
    localStorage.setItem(`voicetifi_clear_backup_${backupDate}`, JSON.stringify(backup));
    
    console.log('üíæ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º:', backupDate);
    
    const userSettings = {
        monthlyIncome: state.user.monthlyIncome,
        currency: state.user.currency,
        language: state.user.language,
        theme: state.user.theme,
        dailyLimit: state.user.dailyLimit
    };
    
    state.transactions = [];
    state.loans = [];
    state.recurringPayments = [];
    state.savingsGoals = [];
    
    state.user = { ...state.user, ...userSettings };
    
    saveData();
    updateUI();
    renderAllScreens();
    
    showToast('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã\nüíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage', 'success');
    
    setTimeout(() => {
        alert('‚ÑπÔ∏è –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ò\n\n' +
              '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\n\n' +
              '–ß—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:\n' +
              '1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)\n' +
              '2. –ù–∞–π–¥–∏—Ç–µ –∫–ª—é—á: voicetifi_clear_backup_' + backupDate.split('T')[0] + '\n' +
              '3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ\n' +
              '4. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —á–µ—Ä–µ–∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö');
    }, 1000);
}

// Mustafoshoh Programer // UI Update Functions
function updateUI() {
    updateGreeting();
    updateBalanceCard();
    updateQuickStats();
    updateRecentTransactions();
    updateSettingsValues();
    updateToggleStates();
}

function renderAllScreens() {
    renderHomeScreen();
    if (state.currentScreen === 'analytics') {
        setTimeout(() => renderAnalyticsScreen(), 100);
    }
    renderHistoryScreen();
    renderSettingsScreen();
}

// Mustafoshoh Programer // Event Listeners
function setupEventListeners() {
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            state.filters.period = tab.dataset.period;
            renderAnalyticsScreen();
        });
    });
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const screen = btn.dataset.screen;
            if (screen) switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) {
                const modal = backdrop.closest('.modal');
                if (modal) modal.classList.remove('active');
            }
        });
    });
    
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        let timeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(filterTransactions, 300);
        });
    }
    
    const receiptInput = document.getElementById('expense-receipt');
    if (receiptInput) {
        receiptInput.addEventListener('change', previewReceipt);
    }
}

// üî• –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –§–£–ù–ö–¶–ò–ò:

function previewReceipt(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const preview = document.getElementById('expense-receipt-preview');
        if (preview) {
            preview.innerHTML = `
                <div class="receipt-preview-item">
                    <img src="${e.target.result}" alt="Receipt preview">
                    <button class="remove-receipt-btn" onclick="removeReceiptPreview()">‚úï</button>
                </div>
            `;
        }
    };
    reader.readAsDataURL(file);
}

// Mustafoshoh Programer // Additional Modal Functions
function openDateFilter() {
    openModal('date-filter-modal');
}

function applyDateFilter() {
    state.filters.dateFrom = document.getElementById('date-from')?.value;
    state.filters.dateTo = document.getElementById('date-to')?.value;
    
    closeModal('date-filter-modal');
    renderHistoryScreen();
}

function resetDateFilter() {
    state.filters.dateFrom = null;
    state.filters.dateTo = null;
    
    const dateFromEl = document.getElementById('date-from');
    const dateToEl = document.getElementById('date-to');
    
    if (dateFromEl) dateFromEl.value = '';
    if (dateToEl) dateToEl.value = '';
    
    closeModal('date-filter-modal');
    renderHistoryScreen();
}

function openLanguageSelector() {
    openModal('language-modal');
}

function changeLanguage(lang) {
    state.user.language = lang;
    saveData();
    
    closeModal('language-modal');
    updateUI();
    renderAllScreens();
    
    showToast('–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω', 'success');
}

function openCurrencySelector() {
    openModal('currency-modal');
}

function changeCurrency(currency) {
    state.user.currency = currency;
    saveData();
    
    closeModal('currency-modal');
    updateUI();
    renderAllScreens();
    
    showToast('–í–∞–ª—é—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
}

function editBudget() {
    const currentIncome = state.user.monthlyIncome;
    const currentCurrency = state.user.currency;
    
    const displayIncome = currentIncome;
    const symbol = currencySymbols[currentCurrency];
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'edit-budget-modal';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="closeEditBudgetModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç</h2>
                <button class="close-btn" onclick="closeEditBudgetModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</label>
                    <input type="number" id="edit-income-input" class="amount-input" 
                           value="${displayIncome}" step="0.01" min="0" 
                           placeholder="0.00"
                           oninput="updateDailyLimitDisplay()">
                </div>
                <div class="currency-selector-edit">
                    <button class="currency-edit-btn ${currentCurrency === 'USD' ? 'active' : ''}" 
                            onclick="selectEditCurrency('USD')">$ USD</button>
                    <button class="currency-edit-btn ${currentCurrency === 'TJS' ? 'active' : ''}" 
                            onclick="selectEditCurrency('TJS')">TJS</button>
                    <button class="currency-edit-btn ${currentCurrency === 'RUB' ? 'active' : ''}" 
                            onclick="selectEditCurrency('RUB')">‚ÇΩ RUB</button>
                </div>
                <div class="form-group">
                    <label>–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç (–∞–≤—Ç–æ)</label>
                    <input type="text" id="edit-daily-display" class="amount-input" 
                           readonly value="${symbol}${(displayIncome / 30).toFixed(2)}">
                </div>
                <button class="save-btn" onclick="saveBudgetEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    setTimeout(() => {
        const incomeInput = document.getElementById('edit-income-input');
        if (incomeInput) {
            incomeInput.focus();
            incomeInput.select();
        }
    }, 100);
}

function updateDailyLimitDisplay() {
    const incomeInput = document.getElementById('edit-income-input');
    const dailyDisplay = document.getElementById('edit-daily-display');
    
    if (incomeInput && dailyDisplay) {
        const inputValue = incomeInput.value;
        const numberMatch = inputValue.match(/[\d.]+/);
        const income = numberMatch ? parseFloat(numberMatch[0]) : 0;
        
        const activeBtn = document.querySelector('.currency-edit-btn.active');
        const currency = activeBtn?.textContent.includes('USD') ? 'USD' : 
                        activeBtn?.textContent.includes('TJS') ? 'TJS' : 'RUB';
        const symbol = currencySymbols[currency];
        
        dailyDisplay.value = `${symbol}${(income / 30).toFixed(2)}`;
    }
}

function closeEditBudgetModal() {
    const modal = document.getElementById('edit-budget-modal');
    if (modal) modal.remove();
}

function selectEditCurrency(currency) {
    document.querySelectorAll('.currency-edit-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    updateDailyLimitDisplay();
}

function updateDailyLimit() {
    updateDailyLimitDisplay();
}

function updateDailyLimit() {
    const incomeInput = document.getElementById('edit-income-input');
    const dailyDisplay = document.getElementById('edit-daily-display');
    
    if (incomeInput && dailyDisplay) {
        const income = parseFloat(incomeInput.value) || 0;
        const activeBtn = document.querySelector('.currency-edit-btn.active');
        const currency = activeBtn?.textContent.includes('USD') ? 'USD' : 
                        activeBtn?.textContent.includes('TJS') ? 'TJS' : 'RUB';
        const symbol = currencySymbols[currency];
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∏–º –Ω–∞ 30, –ë–ï–ó –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        dailyDisplay.value = `${symbol}${(income / 30).toFixed(2)}`;
    }
}

function saveBudgetEdit() {
    const incomeInput = document.getElementById('edit-income-input');
    const activeCurrencyBtn = document.querySelector('.currency-edit-btn.active');
    
    if (!incomeInput || !activeCurrencyBtn) {
        showToast('–û—à–∏–±–∫–∞: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    const newIncome = parseFloat(incomeInput.value);
    const currencyText = activeCurrencyBtn.textContent;
    const newCurrency = currencyText.includes('USD') ? 'USD' : 
                        currencyText.includes('TJS') ? 'TJS' : 'RUB';
    
    if (!newIncome || newIncome <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞', 'error');
        return;
    }
    
    state.user.monthlyIncome = newIncome;
    state.user.dailyLimit = newIncome / 30;
    state.user.currency = newCurrency;
    
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω –±—é–¥–∂–µ—Ç:', {
        income: newIncome,
        currency: newCurrency,
        dailyLimit: state.user.dailyLimit
    });
    
    saveData();
    closeEditBudgetModal();
    
    updateUI();
    renderAllScreens();
    
    showToast('–ë—é–¥–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
}

function showNotifications() {
    showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç', 'info');
}

function showAbout() {
    openModal('about-modal');
}

function openReceiptModal() {
    openAddModal('expense');
    setTimeout(() => {
        const receiptInput = document.getElementById('expense-receipt');
        if (receiptInput) receiptInput.click();
    }, 100);
}

// üî• –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –§–£–ù–ö–¶–ò–ò –í –ö–û–ù–ï–¶ –°–ö–†–ò–ü–¢–ê

// Mustafoshoh Programer // Transaction Editing
// ==========================================
// ‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ô - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
// ==========================================

let editingTransaction = null;

function editTransaction() {
    if (!state.editingTransaction) return;
    
    editingTransaction = state.editingTransaction;
    openModal('edit-modal');
    populateEditForm();
}

function populateEditForm() {
    if (!editingTransaction) return;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏–ø
    const typeSelect = document.getElementById('edit-type');
    if (typeSelect) {
        typeSelect.value = editingTransaction.type;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    updateEditCategories();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—É–º–º—É
    const amountInput = document.getElementById('edit-amount');
    if (amountInput) {
        amountInput.value = editingTransaction.amount;
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    const descInput = document.getElementById('edit-desc');
    if (descInput) {
        descInput.value = editingTransaction.description || '';
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—É
    const dateInput = document.getElementById('edit-date');
    if (dateInput) {
        const date = new Date(editingTransaction.timestamp);
        dateInput.value = date.toISOString().slice(0, 16);
    }
    
    // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    setTimeout(() => {
        selectEditCategory(editingTransaction.category);
    }, 100);
}

function updateEditCategories() {
    const typeSelect = document.getElementById('edit-type');
    const categoriesContainer = document.getElementById('edit-categories');
    
    if (!typeSelect || !categoriesContainer) return;
    
    const type = typeSelect.value;
    categoriesContainer.innerHTML = '';
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
    const categoryKeys = Object.keys(state.categories).filter(key => {
        const cat = state.categories[key];
        if (type === 'expense') {
            // –î–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏—Å–∫–ª—é—á–∞–µ–º –¥–æ—Ö–æ–¥–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            return !['salary', 'freelance', 'gift', 'investment'].includes(key);
        } else {
            // –î–ª—è –¥–æ—Ö–æ–¥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            return ['salary', 'freelance', 'gift', 'investment'].includes(key);
        }
    });
    
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    categoryKeys.forEach(key => {
        const cat = state.categories[key];
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';
        categoryItem.dataset.category = key;
        categoryItem.onclick = () => selectEditCategory(key);
        categoryItem.innerHTML = `
            <div class="category-icon">${cat.icon}</div>
            <div class="category-label">${cat[state.user.language]}</div>
        `;
        categoriesContainer.appendChild(categoryItem);
    });
}

function selectEditCategory(category) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    document.querySelectorAll('#edit-categories .category-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    const selectedItem = document.querySelector(`#edit-categories .category-item[data-category="${category}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }
}

function saveEditedTransaction() {
    if (!editingTransaction) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
    const typeSelect = document.getElementById('edit-type');
    const amountInput = document.getElementById('edit-amount');
    const descInput = document.getElementById('edit-desc');
    const dateInput = document.getElementById('edit-date');
    
    if (!typeSelect || !amountInput || !dateInput) return;
    
    const type = typeSelect.value;
    const amount = parseFloat(amountInput.value);
    const description = descInput.value;
    const timestamp = new Date(dateInput.value).getTime();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!amount || amount <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
        return;
    }
    
    if (!timestamp) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É', 'error');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    const selectedCategoryItem = document.querySelector('#edit-categories .category-item.active');
    const category = selectedCategoryItem ? selectedCategoryItem.dataset.category : editingTransaction.category;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    const updatedTransaction = {
        ...editingTransaction,
        type: type,
        amount: amount,
        category: category,
        description: description,
        timestamp: timestamp
    };
    
    // –ù–∞—Ö–æ–¥–∏–º –∏ –∑–∞–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –º–∞—Å—Å–∏–≤–µ
    const transactionIndex = state.transactions.findIndex(t => t.id === editingTransaction.id);
    if (transactionIndex !== -1) {
        state.transactions[transactionIndex] = updatedTransaction;
        saveData();
        
        closeModal('edit-modal');
        closeModal('detail-modal');
        
        updateUI();
        renderAllScreens();
        
        showToast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    } else {
        showToast('–û—à–∏–±–∫–∞: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
    }
    
    editingTransaction = null;
    state.editingTransaction = null;
}

// üî• –û–ë–ù–û–í–ò–¢–ï –§–£–ù–ö–¶–ò–Æ showTransactionDetail - –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ü–∏—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

function showTransactionDetail(id) {
    const transaction = state.transactions.find(t => t.id === id);
    if (!transaction) return;
    
    state.editingTransaction = transaction;
    
    const modal = document.getElementById('detail-modal');
    const container = document.getElementById('transaction-detail');
    
    const category = state.categories[transaction.category] || state.categories.other;
    const txRate = rates[transaction.currency] || 1;
    const rate = rates[state.user.currency] || 1;
    const amount = (transaction.amount * txRate) / rate;
    
    const date = new Date(transaction.timestamp);
    const formattedDate = date.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    container.innerHTML = `
        <div class="transaction-detail-icon" style="background: ${category.color}20;">
            ${category.icon}
        </div>
        <h3>${transaction.description || category[state.user.language]}</h3>
        <div class="transaction-detail-amount ${transaction.type}">
            ${transaction.type === 'expense' ? '-' : '+'}${formatCurrency(amount)}
        </div>
        <div class="transaction-detail-info">
            <div class="detail-row">
                <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                <span>${category.icon} ${category[state.user.language]}</span>
            </div>
            <div class="detail-row">
                <span>–î–∞—Ç–∞:</span>
                <span>${formattedDate}</span>
            </div>
            <div class="detail-row">
                <span>–¢–∏–ø:</span>
                <span>${transaction.type === 'expense' ? '–†–∞—Å—Ö–æ–¥' : transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–ü–µ—Ä–µ–≤–æ–¥'}</span>
            </div>
            <div class="detail-row">
                <span>ID:</span>
                <span style="font-family: monospace; font-size: 12px;">${transaction.id}</span>
            </div>
        </div>
        ${transaction.receipt ? `
            <div class="receipt-section">
                <h4>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —á–µ–∫:</h4>
                <img src="${transaction.receipt}" class="transaction-detail-receipt" 
                     onclick="openReceiptFullscreen('${transaction.receipt}')">
            </div>
        ` : ''}
        
        <!-- üî• –°–ï–ö–¶–ò–Ø –ë–´–°–¢–†–û–ì–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
        <div class="edit-transaction-section">
            <h4>–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</h4>
            <div class="quick-edit-actions">
                <button class="action-btn" onclick="quickEditAmount(${transaction.id}, 10)">
                    <span class="action-icon">‚ûï</span>
                    <span class="action-label">+10</span>
                </button>
                <button class="action-btn" onclick="quickEditAmount(${transaction.id}, -10)">
                    <span class="action-icon">‚ûñ</span>
                    <span class="action-label">-10</span>
                </button>
                <button class="action-btn" onclick="duplicateTransaction(${transaction.id})">
                    <span class="action-icon">üìã</span>
                    <span class="action-label">–ö–æ–ø–∏—è</span>
                </button>
            </div>
        </div>
    `;
    
    modal.classList.add('active');
}

// üî• –î–û–ë–ê–í–¨–¢–ï –§–£–ù–ö–¶–ò–ò –ë–´–°–¢–†–û–ì–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø:

function quickEditAmount(transactionId, amountChange) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    const newAmount = Math.max(0.01, transaction.amount + amountChange);
    transaction.amount = newAmount;
    
    saveData();
    closeModal('detail-modal');
    
    updateUI();
    renderAllScreens();
    
    showToast(`–°—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${formatCurrency(newAmount)}`, 'success');
}

function duplicateTransaction(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    const duplicate = {
        ...transaction,
        id: Date.now(),
        timestamp: Date.now(),
        description: `${transaction.description} (–∫–æ–ø–∏—è)`
    };
    
    state.transactions.unshift(duplicate);
    saveData();
    
    closeModal('detail-modal');
    
    updateUI();
    renderAllScreens();
    
    showToast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
}

// üî• –û–ë–ù–û–í–ò–¢–ï –§–£–ù–ö–¶–ò–Æ deleteTransaction:

function deleteTransaction() {
    if (!state.editingTransaction) return;
    
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        state.transactions = state.transactions.filter(t => t.id !== state.editingTransaction.id);
        saveData();
        
        closeModal('detail-modal');
        updateUI();
        renderAllScreens();
        
        showToast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
    }
}

// ==========================================
// üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –ü–†–ò–í–ê–¢–ù–û–°–¢–¨
// ==========================================

let currentPin = '';
let isPinSetup = false;
let setupPinFirst = '';

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function checkSecurityOnLoad() {
    if (state.security.pinEnabled && state.security.pinCode) {
        showPinScreen();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏
    if (state.security.biometricEnabled && 'credentials' in navigator) {
        const btn = document.getElementById('biometric-btn');
        if (btn) btn.style.display = 'block';
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫—Ä—ã—Ç–∏–µ —Å—É–º–º
    if (state.security.hideAmounts) {
        document.body.classList.add('amounts-hidden');
    }
    
    // –ê–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    setupAutoLock();
}

function togglePinCode() {
    const checkbox = document.getElementById('pin-toggle');
    
    if (checkbox.checked) {
        // –í–∫–ª—é—á–∏—Ç—å PIN
        isPinSetup = true;
        setupPinFirst = '';
        currentPin = '';
        
        const title = document.querySelector('.pin-title');
        if (title) title.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PIN-–∫–æ–¥';
        
        showPinScreen();
    } else {
        // –í—ã–∫–ª—é—á–∏—Ç—å PIN
        if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å PIN-–∫–æ–¥?')) {
            state.security.pinEnabled = false;
            state.security.pinCode = null;
            saveData();
            showToast('PIN-–∫–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
        } else {
            checkbox.checked = true;
        }
    }
}

function toggleBiometric() {
    const checkbox = document.getElementById('biometric-toggle');
    
    if (!('credentials' in navigator)) {
        showToast('–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
        checkbox.checked = false;
        return;
    }
    
    state.security.biometricEnabled = checkbox.checked;
    saveData();
    
    const btn = document.getElementById('biometric-btn');
    if (btn) {
        btn.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    showToast(checkbox.checked ? 'üëÜ –ë–∏–æ–º–µ—Ç—Ä–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–ë–∏–æ–º–µ—Ç—Ä–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞', 'success');
}

function changeAutoLock() {
    const select = document.getElementById('autolock-select');
    state.security.autoLockMinutes = parseInt(select.value);
    saveData();
    
    setupAutoLock();
    showToast(`–ê–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: ${state.security.autoLockMinutes} –º–∏–Ω`, 'success');
}

// –û–±–Ω–æ–≤–∏—Ç—å toggles –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function updateSecurityToggles() {
    const pinToggle = document.getElementById('pin-toggle');
    const biometricToggle = document.getElementById('biometric-toggle');
    const hideToggle = document.getElementById('hide-amounts-toggle');
    const autolockSelect = document.getElementById('autolock-select');
    
    if (pinToggle) pinToggle.checked = state.security.pinEnabled;
    if (biometricToggle) biometricToggle.checked = state.security.biometricEnabled;
    if (hideToggle) hideToggle.checked = state.security.hideAmounts;
    if (autolockSelect) autolockSelect.value = state.security.autoLockMinutes;
}

function showPinScreen() {
    const pinScreen = document.getElementById('pin-screen');
    const app = document.getElementById('app');
    
    if (pinScreen) {
        pinScreen.style.display = 'flex';
    }
    if (app) {
        app.style.display = 'none';
    }
    
    currentPin = '';
    updatePinDots();
}

function hidePinScreen() {
    const pinScreen = document.getElementById('pin-screen');
    const app = document.getElementById('app');
    
    if (pinScreen) {
        pinScreen.style.display = 'none';
    }
    if (app) {
        app.style.display = 'block';
    }
    
    state.security.lastUnlockTime = Date.now();
    saveData();
}

function enterPin(digit) {
    if (currentPin.length >= 4) return;
    
    currentPin += digit;
    updatePinDots();
    
    // –í–∏–±—Ä–∞—Ü–∏—è
    if ('vibrate' in navigator) {
        navigator.vibrate(50);
    }
    
    if (currentPin.length === 4) {
        setTimeout(() => {
            if (isPinSetup) {
                handlePinSetup();
            } else {
                verifyPin();
            }
        }, 200);
    }
}

function clearPin() {
    if (currentPin.length > 0) {
        currentPin = currentPin.slice(0, -1);
        updatePinDots();
        
        if ('vibrate' in navigator) {
            navigator.vibrate(50);
        }
    }
}

function updatePinDots() {
    const dots = document.querySelectorAll('.pin-dot');
    dots.forEach((dot, index) => {
        if (index < currentPin.length) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    });
}

function handlePinSetup() {
    if (!setupPinFirst) {
        setupPinFirst = currentPin;
        currentPin = '';
        updatePinDots();
        
        const title = document.querySelector('.pin-title');
        if (title) {
            title.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ PIN-–∫–æ–¥';
        }
    } else {
        if (currentPin === setupPinFirst) {
            state.security.pinCode = currentPin;
            state.security.pinEnabled = true;
            saveData();
            
            showToast('‚úÖ PIN-–∫–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
            closeModal('security-setup-modal');
            hidePinScreen();
            
            setupPinFirst = '';
            isPinSetup = false;
        } else {
            showToast('‚ùå PIN-–∫–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
            currentPin = '';
            setupPinFirst = '';
            updatePinDots();
            
            const title = document.querySelector('.pin-title');
            if (title) {
                title.textContent = '–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥';
            }
        }
    }
}

function verifyPin() {
    if (currentPin === state.security.pinCode) {
        hidePinScreen();
        showToast('‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ', 'success');
    } else {
        showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥', 'error');
        
        // –¢—Ä—è—Å–∫–∞
        const container = document.querySelector('.pin-container');
        if (container) {
            container.style.animation = 'shake 0.5s';
            setTimeout(() => {
                container.style.animation = '';
            }, 500);
        }
        
        // –í–∏–±—Ä–∞—Ü–∏—è
        if ('vibrate' in navigator) {
            navigator.vibrate([100, 50, 100]);
        }
        
        currentPin = '';
        updatePinDots();
    }
}

// –ë–∏–æ–º–µ—Ç—Ä–∏—è
async function useBiometric() {
    if (!('credentials' in navigator)) {
        showToast('–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        return;
    }
    
    try {
        const credential = await navigator.credentials.get({
            publicKey: {
                challenge: new Uint8Array(32),
                timeout: 60000,
                userVerification: 'required'
            }
        });
        
        if (credential) {
            hidePinScreen();
            showToast('‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –±–∏–æ–º–µ—Ç—Ä–∏—é', 'success');
        }
    } catch (error) {
        console.error('Biometric error:', error);
        showToast('–û—à–∏–±–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏', 'error');
    }
}

// –°–∫—Ä—ã—Ç–∏–µ —Å—É–º–º
function toggleHideAmounts() {
    state.security.hideAmounts = !state.security.hideAmounts;
    
    if (state.security.hideAmounts) {
        document.body.classList.add('amounts-hidden');
        showToast('üîí –°—É–º–º—ã —Å–∫—Ä—ã—Ç—ã', 'info');
    } else {
        document.body.classList.remove('amounts-hidden');
        showToast('üëÅÔ∏è –°—É–º–º—ã –ø–æ–∫–∞–∑–∞–Ω—ã', 'info');
    }
    
    saveData();
}

// –ê–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
function setupAutoLock() {
    let inactivityTimer;
    
    const resetTimer = () => {
        clearTimeout(inactivityTimer);
        
        if (state.security.pinEnabled && state.security.autoLockMinutes > 0) {
            inactivityTimer = setTimeout(() => {
                if (state.security.lastUnlockTime) {
                    const elapsed = Date.now() - state.security.lastUnlockTime;
                    const lockTime = state.security.autoLockMinutes * 60 * 1000;
                    
                    if (elapsed > lockTime) {
                        showPinScreen();
                    }
                }
            }, state.security.autoLockMinutes * 60 * 1000);
        }
    };
    
    document.addEventListener('touchstart', resetTimer);
    document.addEventListener('click', resetTimer);
    document.addEventListener('keypress', resetTimer);
    
    resetTimer();
}

// –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
function exportEncrypted() {
    const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –±—ç–∫–∞–ø–∞:');
    if (!password) return;
    
    const confirmPassword = prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
    if (password !== confirmPassword) {
        showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
    }
    
    const data = {
        version: '1.0.0',
        exportDate: new Date().toISOString(),
        encrypted: true,
        ...state
    };
    
    // –ü—Ä–æ—Å—Ç–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ crypto API)
    const encrypted = btoa(JSON.stringify(data) + '::' + password);
    
    const blob = new Blob([encrypted], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `voicetifi-encrypted-${new Date().toISOString().split('T')[0]}.vtf`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω', 'success');
}

// –ò–º–ø–æ—Ä—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
function importEncrypted(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:');
            if (!password) return;
            
            const decrypted = atob(e.target.result);
            const [dataStr, filePassword] = decrypted.split('::');
            
            if (filePassword !== password) {
                showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            const data = JSON.parse(dataStr);
            
            if (data.version && data.user) {
                state = { ...state, ...data };
                saveData();
                
                updateUI();
                renderAllScreens();
                
                showToast('‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            }
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏', 'error');
            console.error('Decrypt error:', error);
        }
    };
    
    reader.readAsText(file);
}


const style = document.createElement('style');
style.textContent = `
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}
`;
document.head.appendChild(style);

// üî• –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ö–ê–ñ–î–´–ï 30 –ú–ò–ù–£–¢
setInterval(() => {
    if (!state.isFirstLaunch && document.getElementById('app').style.display !== 'none') {
        checkSmartNotifications();
    }
}, 30 * 60 * 1000); // 30 –º–∏–Ω—É—Ç

// üî• –ü–†–û–í–ï–†–ö–ê –ü–†–ò –í–û–ó–í–†–ê–¢–ï –ù–ê –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
function switchScreen(screenName) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const screenEl = document.getElementById(`${screenName}-screen`);
    if (screenEl) screenEl.classList.add('active');
    
    const navBtn = document.querySelector(`.nav-btn[data-screen="${screenName}"]`);
    if (navBtn) navBtn.classList.add('active');
    
    state.currentScreen = screenName;
    
    if (screenName === 'home') {
        renderHomeScreen();
        // üî• –ü–†–û–í–ï–†–Ø–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ü–†–ò –ü–ï–†–ï–•–û–î–ï –ù–ê –ì–õ–ê–í–ù–£–Æ
        setTimeout(() => {
            checkSmartNotifications();
        }, 1000);
    }
    if (screenName === 'analytics') {
        setTimeout(() => renderAnalyticsScreen(), 100);
    }
    if (screenName === 'history') renderHistoryScreen();
    if (screenName === 'settings') renderSettingsScreen();
}
    </script>
</body>
</html>
